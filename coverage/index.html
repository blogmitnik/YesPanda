<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Server</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.0/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2019-01-22T12:13:55+08:00">2019-01-22T12:13:55+08:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">2.88%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.02
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>60</b> files in total.
    <b>4927</b> relevant lines. 
    <span class="green"><b>142</b> lines covered</span> and
    <span class="red"><b>4785</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#34ffd0e719700d5b1375dd0bb79ad8622369a3cb" class="src_link" title="app/admin/access_grants.rb">app/admin/access_grants.rb</a></td>
        <td class="red strong">18.18 %</td>
        <td>16</td>
        <td>11</td>
        <td>2</td>
        <td>9</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#615f93c434d26f82b0e21257e2e79143fdee062f" class="src_link" title="app/admin/access_tokens.rb">app/admin/access_tokens.rb</a></td>
        <td class="red strong">16.67 %</td>
        <td>18</td>
        <td>12</td>
        <td>2</td>
        <td>10</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4dfaf0579c02e56201a23b9c8e0694031f14d6c1" class="src_link" title="app/admin/dashboards.rb">app/admin/dashboards.rb</a></td>
        <td class="red strong">42.86 %</td>
        <td>33</td>
        <td>7</td>
        <td>3</td>
        <td>4</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fdc81a7d0f7b1b47e9b431a45d1df0e67df381c2" class="src_link" title="app/admin/posts.rb">app/admin/posts.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>15</td>
        <td>10</td>
        <td>2</td>
        <td>8</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8994da703dfd41fed54a09b94842a7fdc4e0b4af" class="src_link" title="app/admin/users.rb">app/admin/users.rb</a></td>
        <td class="red strong">28.57 %</td>
        <td>9</td>
        <td>7</td>
        <td>2</td>
        <td>5</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#960ff6fafc6d72dba7371011ad1437622e328fd5" class="src_link" title="app/controllers/accounts_controller.rb">app/controllers/accounts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>14</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ac293196198b9dc9d4171cff228ebc43e5d42bba" class="src_link" title="app/controllers/api/api_controller.rb">app/controllers/api/api_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>19</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f610f5dd1ad23c8f5ff0d5006d14bc05960237e" class="src_link" title="app/controllers/api/v1/my_posts_controller.rb">app/controllers/api/v1/my_posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>51</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3504b0829f0a9e250447030a3239078ed86436bb" class="src_link" title="app/controllers/api/v1/posts_controller.rb">app/controllers/api/v1/posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>24</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed63f20852340a42060b9639fb309a1775896130" class="src_link" title="app/controllers/api/v1/reports_controller.rb">app/controllers/api/v1/reports_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>69</td>
        <td>69</td>
        <td>0</td>
        <td>69</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f56640ba9f11c03b02c7c439e5468edb4205e673" class="src_link" title="app/controllers/api/v1/stations_controller.rb">app/controllers/api/v1/stations_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>36</td>
        <td>36</td>
        <td>0</td>
        <td>36</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8f823bffc87688e5d59311630d21844a1add5917" class="src_link" title="app/controllers/api/v1/users_controller.rb">app/controllers/api/v1/users_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>24</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6b0a7b36a4a858e52021f6d4e311229a98e9e926" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>188</td>
        <td>100</td>
        <td>20</td>
        <td>80</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c06b0c1e66a4f18cb8125b12b0583b611aab730" class="src_link" title="app/controllers/configs_controller.rb">app/controllers/configs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>25</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5327bd1136143f2409057bd098ef65b19c94164c" class="src_link" title="app/controllers/errors_controller.rb">app/controllers/errors_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#67685c069bcbec0330dbb8f47df57c9a0ce8610f" class="src_link" title="app/controllers/main_controller.rb">app/controllers/main_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#87967e08287ab0e14285b31cf8f2dee4550ccabb" class="src_link" title="app/controllers/my_posts_controller.rb">app/controllers/my_posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>102</td>
        <td>102</td>
        <td>0</td>
        <td>102</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#abae0c29066908ba29d5ec305de0000dab6f4eab" class="src_link" title="app/controllers/omniauth_callbacks_controller.rb">app/controllers/omniauth_callbacks_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d274312168a7a26ea826ff1e6292d14fb636399" class="src_link" title="app/controllers/posts_controller.rb">app/controllers/posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>7</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dde5b20768f432baebd71cf2696090c9a2b4edca" class="src_link" title="app/controllers/products_controller.rb">app/controllers/products_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>48</td>
        <td>0</td>
        <td>48</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#91e0d17fa9b7d7d7331b202e3f9716c281609cab" class="src_link" title="app/controllers/reports_controller.rb">app/controllers/reports_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>351</td>
        <td>351</td>
        <td>0</td>
        <td>351</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#872414610b395d5e63c0d3c2a093b77b3c9ec68e" class="src_link" title="app/controllers/stations_controller.rb">app/controllers/stations_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>34</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d5dc5e13aaa0bf866b2723c708c6b9ac2b2c964d" class="src_link" title="app/controllers/yield_files_controller.rb">app/controllers/yield_files_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>51</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f9d49ec755a0b049fe2a2715cbfbd1939077d274" class="src_link" title="app/helpers/api/posts_helper.rb">app/helpers/api/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40171d8da8c6f3c06df53a2a7835a694306d0f19" class="src_link" title="app/helpers/api/v1/my_posts_helper.rb">app/helpers/api/v1/my_posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#84e75d5b106d81f847e14501665d1388e7d68011" class="src_link" title="app/helpers/api/v1/posts_helper.rb">app/helpers/api/v1/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#db8683748106f78aae1b07828b63d36fd736040a" class="src_link" title="app/helpers/api/v1/reports_helper.rb">app/helpers/api/v1/reports_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ceec76f94f198e9b8775421b99df9ebdf97d2a7" class="src_link" title="app/helpers/api/v1/users_helper.rb">app/helpers/api/v1/users_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2f4ef67581b8fe2028bbc2acd63416352b02a4be" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">52.94 %</td>
        <td>36</td>
        <td>17</td>
        <td>9</td>
        <td>8</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64f3f66b63d3a996930c963ef2f2b6db2400ebee" class="src_link" title="app/helpers/configs_helper.rb">app/helpers/configs_helper.rb</a></td>
        <td class="red strong">8.11 %</td>
        <td>69</td>
        <td>37</td>
        <td>3</td>
        <td>34</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bde0854b6686455c7010062d9e6f6bce913404e3" class="src_link" title="app/helpers/errors_helper.rb">app/helpers/errors_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2c84dc224c262868a116e6cbc2c650de89207174" class="src_link" title="app/helpers/main_helper.rb">app/helpers/main_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8942d1033cd2037b35210de4b934e7d61c53eb49" class="src_link" title="app/helpers/my_posts_helper.rb">app/helpers/my_posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ecd6d6aa86ad1552a5ac64e7f97d233a41a3f128" class="src_link" title="app/helpers/omniauth_callbacks_helper.rb">app/helpers/omniauth_callbacks_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5e0b98d4b2349863dfbe08cdd227c4976fc0bbd9" class="src_link" title="app/helpers/posts_helper.rb">app/helpers/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#452d201139ca113c7327ae7ffa28118a0a00e017" class="src_link" title="app/helpers/reports_helper.rb">app/helpers/reports_helper.rb</a></td>
        <td class="red strong">7.5 %</td>
        <td>268</td>
        <td>80</td>
        <td>6</td>
        <td>74</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#542127bc654deec3b1947806f236ac8ddf09546f" class="src_link" title="app/helpers/stations_helper.rb">app/helpers/stations_helper.rb</a></td>
        <td class="red strong">5.66 %</td>
        <td>82</td>
        <td>53</td>
        <td>3</td>
        <td>50</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5cf37ba875a4a669db10d86c8506d17e212f3ff0" class="src_link" title="app/models/admin_user.rb">app/models/admin_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>10</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ba4b4a10151ccaa91d70b490d00295b357ca2fa" class="src_link" title="app/models/api_error.rb">app/models/api_error.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>13</td>
        <td>0</td>
        <td>13</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b0f5bed65edbfbd7027a6c6b8749275504b0e38f" class="src_link" title="app/models/device.rb">app/models/device.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5a9f4b2d7151036b7308a50cb37332619dfd3f5e" class="src_link" title="app/models/facebook_user.rb">app/models/facebook_user.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>35</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f773582fe9a446cb7d928628d202b7f096342534" class="src_link" title="app/models/post.rb">app/models/post.rb</a></td>
        <td class="red strong">72.41 %</td>
        <td>49</td>
        <td>29</td>
        <td>21</td>
        <td>8</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4b28cf76e7b8bbb50ffac1fc56cd0bc89e448617" class="src_link" title="app/models/product.rb">app/models/product.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4bd578208df1e60b497da5ee90daca8ee1c52200" class="src_link" title="app/models/report.rb">app/models/report.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>835</td>
        <td>835</td>
        <td>0</td>
        <td>835</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d0a1a867f88d54143d9c9ac746bb2566d8d51d70" class="src_link" title="app/models/report_main.rb">app/models/report_main.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>675</td>
        <td>675</td>
        <td>0</td>
        <td>675</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#37de5ee36a45db602a4fc80a13718d194d432001" class="src_link" title="app/models/report_mini.rb">app/models/report_mini.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>673</td>
        <td>673</td>
        <td>0</td>
        <td>673</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7cc9ea4465c93015ca10915b71dd35c613265931" class="src_link" title="app/models/station.rb">app/models/station.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d22cad171f75d0128802dd301ea944158bb639b" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">46.15 %</td>
        <td>63</td>
        <td>26</td>
        <td>12</td>
        <td>14</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#796298c4d1a463e34a8d433d9e01dcd06c25b99f" class="src_link" title="app/models/yield_file.rb">app/models/yield_file.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>27</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f4ec721e9f370fffeb55c366aa07298942d65952" class="src_link" title="lib/tasks/clean_overdue_data_dvt.rake">lib/tasks/clean_overdue_data_dvt.rake</a></td>
        <td class="red strong">10.81 %</td>
        <td>48</td>
        <td>37</td>
        <td>4</td>
        <td>33</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9fb8d7e951ade8298f9a2bd8d8f8300cfdc13778" class="src_link" title="lib/tasks/clean_overdue_data_gl_dvt.rake">lib/tasks/clean_overdue_data_gl_dvt.rake</a></td>
        <td class="red strong">10.81 %</td>
        <td>48</td>
        <td>37</td>
        <td>4</td>
        <td>33</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97a368b9d37950528de35672f61955fed5bc3af9" class="src_link" title="lib/tasks/import_jhc_dvt.rake">lib/tasks/import_jhc_dvt.rake</a></td>
        <td class="red strong">2.88 %</td>
        <td>250</td>
        <td>139</td>
        <td>4</td>
        <td>135</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0144b9eb4dc051a78c9157db1db597a8ccc98ecb" class="src_link" title="lib/tasks/import_jhd_dvt.rake">lib/tasks/import_jhd_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#490ad2a4d9c4ce1e83d4733353d36955dc36e25f" class="src_link" title="lib/tasks/import_jhe_dvt.rake">lib/tasks/import_jhe_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6bdc78e1cb37a545f0a43aee4cc1b7255d8f8ef6" class="src_link" title="lib/tasks/import_jhe_pvte.rake">lib/tasks/import_jhe_pvte.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>232</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4d08ef2950c290b1776de1f8019b5803b80c46fe" class="src_link" title="lib/tasks/import_jhf_dvt.rake">lib/tasks/import_jhf_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45f3ae5f02adb3c091ba3b5dafba7ad75ea38f85" class="src_link" title="lib/tasks/import_jhh_ab.rake">lib/tasks/import_jhh_ab.rake</a></td>
        <td class="red strong">2.8 %</td>
        <td>233</td>
        <td>143</td>
        <td>4</td>
        <td>139</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b6a793c740e74e8cc9f87009a41036dfceebc160" class="src_link" title="lib/tasks/import_jhk_p2.rake">lib/tasks/import_jhk_p2.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>232</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c6ef95ec1f6bf8ac055cf05be6cf899a1046900" class="src_link" title="lib/tasks/import_jhx_dvt_mix.rake">lib/tasks/import_jhx_dvt_mix.rake</a></td>
        <td class="red strong">2.84 %</td>
        <td>232</td>
        <td>141</td>
        <td>4</td>
        <td>137</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c17231eb03eb5a7fcc5bde9e337642a9a4abcd1" class="src_link" title="lib/tasks/import_jhx_pvte.rake">lib/tasks/import_jhx_pvte.rake</a></td>
        <td class="red strong">2.8 %</td>
        <td>235</td>
        <td>143</td>
        <td>4</td>
        <td>139</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="red">2.02%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.02
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>18</b> files in total.
    <b>990</b> relevant lines. 
    <span class="green"><b>20</b> lines covered</span> and
    <span class="red"><b>970</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#960ff6fafc6d72dba7371011ad1437622e328fd5" class="src_link" title="app/controllers/accounts_controller.rb">app/controllers/accounts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>14</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ac293196198b9dc9d4171cff228ebc43e5d42bba" class="src_link" title="app/controllers/api/api_controller.rb">app/controllers/api/api_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>19</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f610f5dd1ad23c8f5ff0d5006d14bc05960237e" class="src_link" title="app/controllers/api/v1/my_posts_controller.rb">app/controllers/api/v1/my_posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>51</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3504b0829f0a9e250447030a3239078ed86436bb" class="src_link" title="app/controllers/api/v1/posts_controller.rb">app/controllers/api/v1/posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>24</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed63f20852340a42060b9639fb309a1775896130" class="src_link" title="app/controllers/api/v1/reports_controller.rb">app/controllers/api/v1/reports_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>69</td>
        <td>69</td>
        <td>0</td>
        <td>69</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f56640ba9f11c03b02c7c439e5468edb4205e673" class="src_link" title="app/controllers/api/v1/stations_controller.rb">app/controllers/api/v1/stations_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>36</td>
        <td>36</td>
        <td>0</td>
        <td>36</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8f823bffc87688e5d59311630d21844a1add5917" class="src_link" title="app/controllers/api/v1/users_controller.rb">app/controllers/api/v1/users_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>24</td>
        <td>0</td>
        <td>24</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6b0a7b36a4a858e52021f6d4e311229a98e9e926" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>188</td>
        <td>100</td>
        <td>20</td>
        <td>80</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c06b0c1e66a4f18cb8125b12b0583b611aab730" class="src_link" title="app/controllers/configs_controller.rb">app/controllers/configs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>25</td>
        <td>25</td>
        <td>0</td>
        <td>25</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5327bd1136143f2409057bd098ef65b19c94164c" class="src_link" title="app/controllers/errors_controller.rb">app/controllers/errors_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>6</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#67685c069bcbec0330dbb8f47df57c9a0ce8610f" class="src_link" title="app/controllers/main_controller.rb">app/controllers/main_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#87967e08287ab0e14285b31cf8f2dee4550ccabb" class="src_link" title="app/controllers/my_posts_controller.rb">app/controllers/my_posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>102</td>
        <td>102</td>
        <td>0</td>
        <td>102</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#abae0c29066908ba29d5ec305de0000dab6f4eab" class="src_link" title="app/controllers/omniauth_callbacks_controller.rb">app/controllers/omniauth_callbacks_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>18</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d274312168a7a26ea826ff1e6292d14fb636399" class="src_link" title="app/controllers/posts_controller.rb">app/controllers/posts_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>7</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dde5b20768f432baebd71cf2696090c9a2b4edca" class="src_link" title="app/controllers/products_controller.rb">app/controllers/products_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>48</td>
        <td>48</td>
        <td>0</td>
        <td>48</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#91e0d17fa9b7d7d7331b202e3f9716c281609cab" class="src_link" title="app/controllers/reports_controller.rb">app/controllers/reports_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>351</td>
        <td>351</td>
        <td>0</td>
        <td>351</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#872414610b395d5e63c0d3c2a093b77b3c9ec68e" class="src_link" title="app/controllers/stations_controller.rb">app/controllers/stations_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>34</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d5dc5e13aaa0bf866b2723c708c6b9ac2b2c964d" class="src_link" title="app/controllers/yield_files_controller.rb">app/controllers/yield_files_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>51</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="red">1.54%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.02
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>12</b> files in total.
    <b>2343</b> relevant lines. 
    <span class="green"><b>36</b> lines covered</span> and
    <span class="red"><b>2307</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#5cf37ba875a4a669db10d86c8506d17e212f3ff0" class="src_link" title="app/models/admin_user.rb">app/models/admin_user.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>10</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9ba4b4a10151ccaa91d70b490d00295b357ca2fa" class="src_link" title="app/models/api_error.rb">app/models/api_error.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>13</td>
        <td>13</td>
        <td>0</td>
        <td>13</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b0f5bed65edbfbd7027a6c6b8749275504b0e38f" class="src_link" title="app/models/device.rb">app/models/device.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5a9f4b2d7151036b7308a50cb37332619dfd3f5e" class="src_link" title="app/models/facebook_user.rb">app/models/facebook_user.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>35</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f773582fe9a446cb7d928628d202b7f096342534" class="src_link" title="app/models/post.rb">app/models/post.rb</a></td>
        <td class="red strong">72.41 %</td>
        <td>49</td>
        <td>29</td>
        <td>21</td>
        <td>8</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4b28cf76e7b8bbb50ffac1fc56cd0bc89e448617" class="src_link" title="app/models/product.rb">app/models/product.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4bd578208df1e60b497da5ee90daca8ee1c52200" class="src_link" title="app/models/report.rb">app/models/report.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>835</td>
        <td>835</td>
        <td>0</td>
        <td>835</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d0a1a867f88d54143d9c9ac746bb2566d8d51d70" class="src_link" title="app/models/report_main.rb">app/models/report_main.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>675</td>
        <td>675</td>
        <td>0</td>
        <td>675</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#37de5ee36a45db602a4fc80a13718d194d432001" class="src_link" title="app/models/report_mini.rb">app/models/report_mini.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>673</td>
        <td>673</td>
        <td>0</td>
        <td>673</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7cc9ea4465c93015ca10915b71dd35c613265931" class="src_link" title="app/models/station.rb">app/models/station.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>11</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d22cad171f75d0128802dd301ea944158bb639b" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">46.15 %</td>
        <td>63</td>
        <td>26</td>
        <td>12</td>
        <td>14</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#796298c4d1a463e34a8d433d9e01dcd06c25b99f" class="src_link" title="app/models/yield_file.rb">app/models/yield_file.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>27</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="red">15.74%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.18
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>14</b> files in total.
    <b>197</b> relevant lines. 
    <span class="green"><b>31</b> lines covered</span> and
    <span class="red"><b>166</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#f9d49ec755a0b049fe2a2715cbfbd1939077d274" class="src_link" title="app/helpers/api/posts_helper.rb">app/helpers/api/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#40171d8da8c6f3c06df53a2a7835a694306d0f19" class="src_link" title="app/helpers/api/v1/my_posts_helper.rb">app/helpers/api/v1/my_posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#84e75d5b106d81f847e14501665d1388e7d68011" class="src_link" title="app/helpers/api/v1/posts_helper.rb">app/helpers/api/v1/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#db8683748106f78aae1b07828b63d36fd736040a" class="src_link" title="app/helpers/api/v1/reports_helper.rb">app/helpers/api/v1/reports_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ceec76f94f198e9b8775421b99df9ebdf97d2a7" class="src_link" title="app/helpers/api/v1/users_helper.rb">app/helpers/api/v1/users_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2f4ef67581b8fe2028bbc2acd63416352b02a4be" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">52.94 %</td>
        <td>36</td>
        <td>17</td>
        <td>9</td>
        <td>8</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#64f3f66b63d3a996930c963ef2f2b6db2400ebee" class="src_link" title="app/helpers/configs_helper.rb">app/helpers/configs_helper.rb</a></td>
        <td class="red strong">8.11 %</td>
        <td>69</td>
        <td>37</td>
        <td>3</td>
        <td>34</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bde0854b6686455c7010062d9e6f6bce913404e3" class="src_link" title="app/helpers/errors_helper.rb">app/helpers/errors_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2c84dc224c262868a116e6cbc2c650de89207174" class="src_link" title="app/helpers/main_helper.rb">app/helpers/main_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8942d1033cd2037b35210de4b934e7d61c53eb49" class="src_link" title="app/helpers/my_posts_helper.rb">app/helpers/my_posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ecd6d6aa86ad1552a5ac64e7f97d233a41a3f128" class="src_link" title="app/helpers/omniauth_callbacks_helper.rb">app/helpers/omniauth_callbacks_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5e0b98d4b2349863dfbe08cdd227c4976fc0bbd9" class="src_link" title="app/helpers/posts_helper.rb">app/helpers/posts_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>2</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#452d201139ca113c7327ae7ffa28118a0a00e017" class="src_link" title="app/helpers/reports_helper.rb">app/helpers/reports_helper.rb</a></td>
        <td class="red strong">7.5 %</td>
        <td>268</td>
        <td>80</td>
        <td>6</td>
        <td>74</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#542127bc654deec3b1947806f236ac8ddf09546f" class="src_link" title="app/helpers/stations_helper.rb">app/helpers/stations_helper.rb</a></td>
        <td class="red strong">5.66 %</td>
        <td>82</td>
        <td>53</td>
        <td>3</td>
        <td>50</td>
        <td>0.1</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Jobs"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="red">3.26%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.01
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>11</b> files in total.
    <b>1350</b> relevant lines. 
    <span class="green"><b>44</b> lines covered</span> and
    <span class="red"><b>1306</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#f4ec721e9f370fffeb55c366aa07298942d65952" class="src_link" title="lib/tasks/clean_overdue_data_dvt.rake">lib/tasks/clean_overdue_data_dvt.rake</a></td>
        <td class="red strong">10.81 %</td>
        <td>48</td>
        <td>37</td>
        <td>4</td>
        <td>33</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9fb8d7e951ade8298f9a2bd8d8f8300cfdc13778" class="src_link" title="lib/tasks/clean_overdue_data_gl_dvt.rake">lib/tasks/clean_overdue_data_gl_dvt.rake</a></td>
        <td class="red strong">10.81 %</td>
        <td>48</td>
        <td>37</td>
        <td>4</td>
        <td>33</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97a368b9d37950528de35672f61955fed5bc3af9" class="src_link" title="lib/tasks/import_jhc_dvt.rake">lib/tasks/import_jhc_dvt.rake</a></td>
        <td class="red strong">2.88 %</td>
        <td>250</td>
        <td>139</td>
        <td>4</td>
        <td>135</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0144b9eb4dc051a78c9157db1db597a8ccc98ecb" class="src_link" title="lib/tasks/import_jhd_dvt.rake">lib/tasks/import_jhd_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#490ad2a4d9c4ce1e83d4733353d36955dc36e25f" class="src_link" title="lib/tasks/import_jhe_dvt.rake">lib/tasks/import_jhe_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6bdc78e1cb37a545f0a43aee4cc1b7255d8f8ef6" class="src_link" title="lib/tasks/import_jhe_pvte.rake">lib/tasks/import_jhe_pvte.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>232</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4d08ef2950c290b1776de1f8019b5803b80c46fe" class="src_link" title="lib/tasks/import_jhf_dvt.rake">lib/tasks/import_jhf_dvt.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>253</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#45f3ae5f02adb3c091ba3b5dafba7ad75ea38f85" class="src_link" title="lib/tasks/import_jhh_ab.rake">lib/tasks/import_jhh_ab.rake</a></td>
        <td class="red strong">2.8 %</td>
        <td>233</td>
        <td>143</td>
        <td>4</td>
        <td>139</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b6a793c740e74e8cc9f87009a41036dfceebc160" class="src_link" title="lib/tasks/import_jhk_p2.rake">lib/tasks/import_jhk_p2.rake</a></td>
        <td class="red strong">2.82 %</td>
        <td>232</td>
        <td>142</td>
        <td>4</td>
        <td>138</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c6ef95ec1f6bf8ac055cf05be6cf899a1046900" class="src_link" title="lib/tasks/import_jhx_dvt_mix.rake">lib/tasks/import_jhx_dvt_mix.rake</a></td>
        <td class="red strong">2.84 %</td>
        <td>232</td>
        <td>141</td>
        <td>4</td>
        <td>137</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c17231eb03eb5a7fcc5bde9e337642a9a4abcd1" class="src_link" title="lib/tasks/import_jhx_pvte.rake">lib/tasks/import_jhx_pvte.rake</a></td>
        <td class="red strong">2.8 %</td>
        <td>235</td>
        <td>143</td>
        <td>4</td>
        <td>139</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="red">23.4%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.24
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>5</b> files in total.
    <b>47</b> relevant lines. 
    <span class="green"><b>11</b> lines covered</span> and
    <span class="red"><b>36</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#34ffd0e719700d5b1375dd0bb79ad8622369a3cb" class="src_link" title="app/admin/access_grants.rb">app/admin/access_grants.rb</a></td>
        <td class="red strong">18.18 %</td>
        <td>16</td>
        <td>11</td>
        <td>2</td>
        <td>9</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#615f93c434d26f82b0e21257e2e79143fdee062f" class="src_link" title="app/admin/access_tokens.rb">app/admin/access_tokens.rb</a></td>
        <td class="red strong">16.67 %</td>
        <td>18</td>
        <td>12</td>
        <td>2</td>
        <td>10</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4dfaf0579c02e56201a23b9c8e0694031f14d6c1" class="src_link" title="app/admin/dashboards.rb">app/admin/dashboards.rb</a></td>
        <td class="red strong">42.86 %</td>
        <td>33</td>
        <td>7</td>
        <td>3</td>
        <td>4</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fdc81a7d0f7b1b47e9b431a45d1df0e67df381c2" class="src_link" title="app/admin/posts.rb">app/admin/posts.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>15</td>
        <td>10</td>
        <td>2</td>
        <td>8</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8994da703dfd41fed54a09b94842a7fdc4e0b4af" class="src_link" title="app/admin/users.rb">app/admin/users.rb</a></td>
        <td class="red strong">28.57 %</td>
        <td>9</td>
        <td>7</td>
        <td>2</td>
        <td>5</td>
        <td>0.3</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.11.2 
        and simplecov-html v0.10.0<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="34ffd0e719700d5b1375dd0bb79ad8622369a3cb">
  <div class="header">
    <h3>app/admin/access_grants.rb</h3>
    <h4><span class="red">18.18 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveAdmin.register Doorkeeper::AccessGrant do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  index do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    column :owner do |grant|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      div User.find_by_id(grant.resource_owner_id).email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    column :application</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    column :token do |grant|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      div truncate(grant.token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    column :expires_in</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    column :redirect_uri</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    column :revoked_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # column :scopes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    default_actions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="615f93c434d26f82b0e21257e2e79143fdee062f">
  <div class="header">
    <h3>app/admin/access_tokens.rb</h3>
    <h4><span class="red">16.67 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveAdmin.register Doorkeeper::AccessToken do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  index do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    column :owner do |grant|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      div User.find_by_id(grant.resource_owner_id).email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    column :application</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    column :token do |grant|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      div truncate(grant.token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    column :refresh_token do |grant|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      div truncate(grant.refresh_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    column :expires_in</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    column :revoked_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # column :scopes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    default_actions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4dfaf0579c02e56201a23b9c8e0694031f14d6c1">
  <div class="header">
    <h3>app/admin/dashboards.rb</h3>
    <h4><span class="red">42.86 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveAdmin.register_page &quot;Dashboard&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  menu priority: 1, label: proc{ I18n.t(&quot;active_admin.dashboard&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  content title: proc{ I18n.t(&quot;active_admin.dashboard&quot;) } do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    div class: &quot;blank_slate_container&quot;, id: &quot;dashboard_default_message&quot; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      span class: &quot;blank_slate&quot; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        span I18n.t(&quot;active_admin.dashboard_welcome.welcome&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        small I18n.t(&quot;active_admin.dashboard_welcome.call_to_action&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Here is an example of a simple dashboard with columns and panels.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    # columns do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    #   column do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    #     panel &quot;Recent Posts&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    #       ul do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    #         Post.recent(5).map do |post|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    #           li link_to(post.title, admin_post_path(post))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    #         end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #       end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    #   column do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    #     panel &quot;Info&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    #       para &quot;Welcome to ActiveAdmin.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end # content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="fdc81a7d0f7b1b47e9b431a45d1df0e67df381c2">
  <div class="header">
    <h3>app/admin/posts.rb</h3>
    <h4><span class="red">20.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveAdmin.register Post do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  index do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    column :id, sotrable: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    column :title do |post|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      div(:style =&gt; &quot;white-space: nowrap&quot;) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        truncate(post.title)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    column :content do |post|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      div truncate(post.content)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    column :published_at, sortable: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    default_actions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8994da703dfd41fed54a09b94842a7fdc4e0b4af">
  <div class="header">
    <h3>app/admin/users.rb</h3>
    <h4><span class="red">28.57 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">ActiveAdmin.register User do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  index do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    column :id, sotrable: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    column :email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    column :current_sign_in_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    column :current_sign_in_ip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    default_actions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="960ff6fafc6d72dba7371011ad1437622e328fd5">
  <div class="header">
    <h3>app/controllers/accounts_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class AccountsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def checkpass</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	if current_user &amp;&amp; current_user.valid_password?(params[:password])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  	  current_user.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  	  Devise.sign_out_all_scopes ? sign_out : sign_out(current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  	  respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  	    format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  	  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ac293196198b9dc9d4171cff228ebc43e5d42bba">
  <div class="header">
    <h3>app/controllers/api/api_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::ApiController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  # include Doorkeeper::Controller</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  protect_from_forgery with: :null_session</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  respond_to :json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def render_error(error, error_description, messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    render :json =&gt; ApiError.json(error, error_description, messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    if doorkeeper_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      @current_user ||= User.find(doorkeeper_token.resource_owner_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1f610f5dd1ad23c8f5ff0d5006d14bc05960237e">
  <div class="header">
    <h3>app/controllers/api/v1/my_posts_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>51</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::V1::MyPostsController &lt; Api::ApiController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  doorkeeper_for :all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    if page &gt; 1 || stale?(last_modified: current_user.posts.maximum(:updated_at))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      @posts = current_user.posts.alive.order(&quot;updated_at DESC&quot;).page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @post = current_user.posts.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if @post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        &quot;Requested post does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    fresh_when @post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    @post = current_user.posts.create(params[:post])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    unless @post.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      render_error(:invalid_parameter, &quot;Parameter Error&quot;, @post.errors.messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    render :action =&gt; :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    @post = current_user.posts.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @post.update_attributes(params[:post])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    unless @post.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      render_error(:invalid_parameter, &quot;Parameter Error&quot;, @post.errors.messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    render :action =&gt; :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    @post = current_user.posts.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @post.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    #@post.update_attribute(:deleted_at, Time.now)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    render :action =&gt; :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3504b0829f0a9e250447030a3239078ed86436bb">
  <div class="header">
    <h3>app/controllers/api/v1/posts_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::V1::PostsController &lt; Api::ApiController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    if page &gt; 1 || stale?(last_modified: Post.maximum(:updated_at))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @posts = Post.published.alive.order(&quot;updated_at DESC&quot;).page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @post = Post.published.alive.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    if @post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      @error = ApiError.new(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        &quot;Requested post does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      render :action =&gt; :error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    fresh_when @post, public: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ed63f20852340a42060b9639fb309a1775896130">
  <div class="header">
    <h3>app/controllers/api/v1/reports_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>69</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>69</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::V1::ReportsController &lt; Api::ApiController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  doorkeeper_for :all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	per_page = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  	@post = current_user.posts.find_by_id(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  	@station = @post.stations.find_by_id(params[:station_id]) if params[:station_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    if @post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        &quot;Requested yield report post does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    if page &gt; 1 || stale?(last_modified: @post.reports.maximum(:updated_at))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      # Ordered by parameters</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      if !params[:sort].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      	if (Report.column_names.include? params[:sort]) &amp;&amp; (Report.sort_names.include? params[:sort])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      	  @reports = params[:station_id] ? @station.reports.order(&quot;#{params[:sort]} ASC&quot;).page(page).per(per_page) : @post.reports.order(&quot;#{params[:sort]} ASC&quot;).page(page).per(per_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      	else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      	  render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        	:resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        	&quot;Parameter Error&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        	&quot;&#39;#{params[:sort]}&#39; is not a valid parameter.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      	  )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      	  return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      	# Ordered by published_at as default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      	@reports = params[:station_id] ? @station.reports.order(&quot;published_at ASC&quot;).page(page).per(per_page) : @post.reports.order(&quot;published_at ASC&quot;).page(page).per(per_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  	  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  	@post = current_user.posts.find_by_id(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    @report = @post.reports.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    if @report.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        &quot;Requested yield data does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    fresh_when @report, public: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    @post = current_user.posts.find_by_id(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    @report = @post.reports.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if @report.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        &quot;Requested yield data does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    @report.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    render :action =&gt; :show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f56640ba9f11c03b02c7c439e5468edb4205e673">
  <div class="header">
    <h3>app/controllers/api/v1/stations_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>36</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>36</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::V1::StationsController &lt; Api::ApiController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  doorkeeper_for :all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    per_page = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @post = current_user.posts.find_by_id(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    if @post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        &quot;Requested station list does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    if page &gt; 1 || stale?(last_modified: @post.stations.maximum(:updated_at))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      @stations = @post.stations.order(&quot;updated_at ASC&quot;).page(page).per(per_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  	@post = current_user.posts.find_by_id(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  	@station = @post.stations.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  	if @post.nil? || @station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        &quot;Requested station does not exist or you don&#39;t have permission to see it.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    fresh_when @station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8f823bffc87688e5d59311630d21844a1add5917">
  <div class="header">
    <h3>app/controllers/api/v1/users_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>24</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Api::V1::UsersController &lt; Api::ApiController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  doorkeeper_for :all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @user = User.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    if @user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      render_error(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        :resource_not_found,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        &quot;Not Found&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        &quot;Requested user does not exist.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    if @user.uid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      hash = current_user.facebook.get_object(@user.uid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      logger.debug &quot;facebook user: #{hash}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      @user.facebook_user = FacebookUser.new(hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    # expires_in 5.seconds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    # fresh_when @user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6b0a7b36a4a858e52021f6d4e311229a98e9e926">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="red">20.0 %</span> covered</h4>
    <div>
      <b>100</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>80</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  protect_from_forgery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Forbidden &lt; ActionController::ActionControllerError; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class IpAddressRejected &lt; ActionController::ActionControllerError; end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from Exception, with: :rescue500</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from Forbidden, with: :rescue403</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from IpAddressRejected, with: :rescue403</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from ActionController::RoutingError, with: :rescue404</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from ActiveRecord::RecordNotFound, with: :rescue404</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  rescue_from Timeout::Error, with: :rescue524</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_latest_time_yield(post, reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    last_record = post.reports.where(config: &#39;ALL&#39;).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    datetime = DateTime.parse(last_record.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    reports = reports.where(&#39;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        datetime.year, datetime.month, datetime.mday, datetime.hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    return reports.order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_target_date_yield(post, reports, build, target_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    if build == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      last_record = post.report_mains.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    elsif build == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      last_record = post.report_minis.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      last_record = reports.where(config: &#39;ALL&#39;, p_year: target_date.to_date.year, p_month: target_date.to_date.month, p_mday: target_date.to_date.day).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    datetime = DateTime.parse(last_record.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    if last_record.p_hour.between?(6, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        datetime.year, datetime.month, datetime.mday, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    elsif last_record.p_hour.between?(0, 5)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      # Show reports with timestamp after 6am yesterday to 5am today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND ((p_mday = ? AND p_hour &gt;= ?) OR (p_mday = ? AND p_hour &lt; ?))&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, datetime.day, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    if params[:my_post_id].present? # For station page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        return reports</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        # Show only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # For showing only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_today_yield(post, reports, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if build == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      last_record = post.report_mains.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    elsif build == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      last_record = post.report_minis.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      last_record = post.reports.where(config: &#39;ALL&#39;).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    datetime = DateTime.parse(last_record.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    if last_record.p_hour.between?(6, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        datetime.year, datetime.month, datetime.mday, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    elsif last_record.p_hour.between?(0, 5)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # Show reports with timestamp after 6am yesterday to 5am today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND ((p_mday = ? AND p_hour &gt;= ?) OR (p_mday = ? AND p_hour &lt; ?))&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, datetime.day, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    if params[:my_post_id].present? # For station page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        return reports</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        # Show only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # For showing only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_yesterday_yield(post, reports, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    if build == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      last_record = post.report_mains.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">    elsif build == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      last_record = post.report_minis.order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      last_record = post.reports.where(config: &#39;ALL&#39;).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    datetime = DateTime.parse(last_record.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    if last_record.p_hour.between?(6, 23)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      # Show reports with timestamp after 6am yesterday to 5am today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND ((p_mday = ? AND p_hour &gt;= ?) OR (p_mday = ? AND p_hour &lt; ?))&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, datetime.day, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    elsif last_record.p_hour.between?(0, 5)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      # Show reports with timestamp after 6am the day before yesterday to 5am yesterday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      reports = reports.where(&#39;p_year = ? AND p_month = ? AND ((p_mday = ? AND p_hour &gt;= ?) OR (p_mday = ? AND p_hour &lt; ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        (datetime - 2).year, (datetime - 2).month, (datetime - 2).day, 6, datetime.yesterday.day, 6)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    if params[:my_post_id].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">       return reports</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">     else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      # Show only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      # For showing only latest time of data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      latest_date = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      return reports = reports.where(published_at: latest_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def rescue400(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    @exception = e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    error_info = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">      :error =&gt; &quot;Bad request&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      :exception =&gt; &quot;#{e.class.name} : #{e.message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    error_info[:trace] = e.backtrace[0,10] if Rails.env.development?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      format.json{ render json: error_info.to_json, status: 400 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      format.html{ render &#39;errors/bad_request&#39;, status: 400 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">  def rescue403(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    @exception = e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    error_info = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      :error =&gt; &quot;Unauthorized&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      :exception =&gt; &quot;#{e.class.name} : #{e.message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    error_info[:trace] = e.backtrace[0,10] if Rails.env.development?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      format.json{ render json: error_info.to_json, status: 403 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      format.html{ render &#39;errors/forbidden&#39;, status: 403 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  def rescue404(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    @exception = e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    error_info = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      :error =&gt; &quot;Resource not found&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      :exception =&gt; &quot;#{e.class.name} : #{e.message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    error_info[:trace] = e.backtrace[0,10] if Rails.env.development?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      format.json{ render json: error_info.to_json, status: 404 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">      format.html{ render &#39;errors/not_found&#39;, status: 404 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">  def rescue500(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">    @exception = e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    error_info = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      :error =&gt; &quot;Internal server error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      :exception =&gt; &quot;#{e.class.name} : #{e.message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    error_info[:trace] = e.backtrace[0,10] if Rails.env.development?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      format.json{ render json: error_info.to_json, status: 500 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      format.html{ render &#39;errors/internal_server_error&#39;, status: 500 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">  def rescue524(e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    @exception = e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    error_info = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      :error =&gt; &quot;A timeout occurred&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      :exception =&gt; &quot;#{e.class.name} : #{e.message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    error_info[:trace] = e.backtrace[0,10] if Rails.env.development?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      format.json{ render json: error_info.to_json, status: 524 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      format.html{ render &#39;errors/timeout_occurred&#39;, status: 524 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5c06b0c1e66a4f18cb8125b12b0583b611aab730">
  <div class="header">
    <h3>app/controllers/configs_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ConfigsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  	@product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  	@post = @product.posts.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    if params[:build] == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      @report = @post.report_mains.find(params[:report_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      @station = @report.station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      # Get records in Report model that CONFIG match MAIN config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @reports_for_cart = @post.reports.where(&#39;config IN (?) AND station_name = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&#39;, @report.config.split(&#39;;&#39;), @report.station_name, @report.p_year, @report.p_month, @report.p_mday, @report.p_hour).order(&quot;published_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    elsif params[:build] == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      @report = @post.report_minis.find(params[:report_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      @station = @report.station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      # Get records in Report model that CONFIG match MINI config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      @reports_for_cart = @post.reports.where(&#39;config IN (?) AND station_name = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&#39;, @report.config.split(&#39;;&#39;), @report.station_name, @report.p_year, @report.p_month, @report.p_mday, @report.p_hour).order(&quot;published_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      @report = @post.reports.find(params[:report_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      @station = @report.station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      @reports_for_cart = @post.reports.where(&#39;config != ? AND station_name = ? AND published_at = ?&#39;, &#39;ALL&#39;, @report.station_name, @report.published_at).order(&quot;published_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  	@reports = @reports_for_cart.page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5327bd1136143f2409057bd098ef65b19c94164c">
  <div class="header">
    <h3>app/controllers/errors_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ErrorsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  def routing_error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    raise ActionController::RoutingError,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      &quot;No route matches #{request.path.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="67685c069bcbec0330dbb8f47df57c9a0ce8610f">
  <div class="header">
    <h3>app/controllers/main_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class MainController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    if user_signed_in?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      @my_posts = current_user.posts.page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @public_posts = Post.published.page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="87967e08287ab0e14285b31cf8f2dee4550ccabb">
  <div class="header">
    <h3>app/controllers/my_posts_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>102</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>102</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class MyPostsController &lt; InheritedResources::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  defaults :resource_class =&gt; Post, :collection_name =&gt; &#39;posts&#39;, :instance_name =&gt; &#39;post&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @posts = @product.posts.order(&#39;title&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @post = Post.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    build = params[:build].to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    if build == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      reports_by_all_config = @post.report_mains</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      reports_count = @post.report_mains.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    elsif build == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      reports_by_all_config = @post.report_minis</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      reports_count = @post.report_minis.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      reports_by_all_config = @post.reports.where(config: &#39;ALL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      reports_count = @post.reports.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    if reports_count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      if params[:date] == &#39;today&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        if reports_count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">          redirect_to my_post_path(@post), alert: &quot;No report found&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          @reports_for_cart = get_today_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      elsif params[:date] == &#39;yesterday&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        if reports_count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">          redirect_to my_post_path(@post), alert: &quot;No report found&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">          @reports_for_cart = get_yesterday_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      else # Today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        @reports_for_cart = get_today_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      reports_tmp = @reports_for_cart</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      @reports_for_cart = reports_tmp.order(&quot;published_at ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      @reports = reports_tmp.order(&quot;published_at DESC, seqno ASC&quot;).page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        format.html { redirect_to product_my_posts_path(@product), alert: &quot;No record was found in the selected build&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    @post = Post.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    create! { product_my_posts_path }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @post.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    @post.product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    @post.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    @post = Post.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    @post = Post.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    update! { product_my_post_path(@product, @post) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    @post = Post.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    @post.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      format.html { redirect_to product_my_posts_path(@product), notice: &quot;#{@post.title} was removed&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  def begin_of_association_chain</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">  def collection</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    @posts ||= end_of_association_chain.order(&quot;updated_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    # @posts ||= end_of_association_chain.page((params[:page] || 1).to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="abae0c29066908ba29d5ec305de0000dab6f4eab">
  <div class="header">
    <h3>app/controllers/omniauth_callbacks_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class OmniauthCallbacksController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  def facebook</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    @user = User.find_for_facebook_oauth(request.env[&quot;omniauth.auth&quot;], current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    if @user.persisted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      flash[:notice] = I18n.t &quot;devise.omniauth_callbacks.success&quot;, :kind =&gt; &quot;Facebook&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      sign_in_and_redirect @user, :event =&gt; :authentication</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      unless @user.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        flash[:notice] = @user.errors.full_messages.join(&quot;. &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        redirect_to new_user_session_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      session[&quot;devise.facebook_data&quot;] = request.env[&quot;omniauth.auth&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      redirect_to new_user_registration_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8d274312168a7a26ea826ff1e6292d14fb636399">
  <div class="header">
    <h3>app/controllers/posts_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class PostsController &lt; InheritedResources::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    redirect_to root_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="dde5b20768f432baebd71cf2696090c9a2b4edca">
  <div class="header">
    <h3>app/controllers/products_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>48</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ProductsController &lt; InheritedResources::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	@products = Product.find(:all, order: &#39;title&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  	@product = Product.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  	@product = Product.new(params[:product])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @product.user = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      if @product.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      	format.js</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        format.html { redirect_to products_path, notice: &quot;#{@product.title} was successfully created.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      	format.js</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        format.html { render action: &#39;new&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  	@product = Product.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @product.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      format.html { redirect_to products_path, notice: &quot;#{@product.title} was removed.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">  def update_builds_selector</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    @builds = Post.where(product_id: params[:product_id]).all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    #render partial: &#39;/shared/builds_selector&#39;, object: @builds</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">  def update_builds_menu</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @product = Product.find_by_title(params[:product_name].strip!)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    @builds = Post.where(product_id: @product).all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="91e0d17fa9b7d7d7331b202e3f9716c281609cab">
  <div class="header">
    <h3>app/controllers/reports_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>351</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>351</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ReportsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def autocomplete_station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    post_id = params[:my_post_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    term = params[:term]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    stations = Station.where(&#39;post_id = ? AND name LIKE ?&#39;, post_id, &quot;%#{term}%&quot;).order(:name).all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    render :json =&gt; stations.map { |s| {:id =&gt; s.id, :label =&gt; s.name, :value =&gt; s.name} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  def autocomplete_report_config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    post_id = params[:my_post_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    term = params[:term]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    reports = Report.where(&#39;post_id = ? AND config LIKE ?&#39;, post_id, &quot;%#{term}%&quot;).select(&quot;distinct(config)&quot;).order(:config).limit(10)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    render :json =&gt; reports.map { |r| {:id =&gt; r.id, :label =&gt; r.config, :value =&gt; r.config} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  # Navbar Global Search Box</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def autocomplete_station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    term = params[:term]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    stations = Station.where(&#39;name LIKE ?&#39;, &quot;%#{term}%&quot;).select(&quot;distinct(name)&quot;).order(:name).limit(10)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    render :json =&gt; stations.map { |s| {:id =&gt; s.id, :label =&gt; s.name, :value =&gt; s.name} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  def autocomplete_config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    term = params[:term]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    reports = Report.where(&#39;config LIKE ?&#39;, &quot;%#{term}%&quot;).select(&quot;distinct(config)&quot;).order(:config).limit(10)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    render :json =&gt; reports.map { |r| {:id =&gt; r.id, :label =&gt; r.config, :value =&gt; r.config} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  def search</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id]) if params[:product_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @post = Post.find(params[:my_post_id]) if params[:my_post_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    @station = @post.stations.find_by_name(params[:station]) if params[:station]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    # For rendering contents by click tab after search</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    if params[:from_station]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      @station = @post.stations.find(params[:from_station])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      reports_by_all_config = @station.reports.where(config: &#39;ALL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    elsif params[:from_report] &amp;&amp; params[:show_config] == &#39;all&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      # Get all configs of station at specific datetime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @report = @post.reports.find(params[:from_report])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      @station = @report.station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      @reports_for_cart = @post.reports.where(&#39;config != ? AND station_name = ? AND published_at = ?&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        &#39;ALL&#39;, @report.station_name, @report.published_at).order(&quot;published_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      @reports = @reports_for_cart.page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      if params[:my_post_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        if params[:build] == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          reports_by_all_config = @post.report_mains</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        elsif params[:build] == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">          reports_by_all_config = @post.report_minis</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          reports_by_all_config = @post.reports.where(config: &#39;ALL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    if params[:date] == &#39;today&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      if @post.reports.count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        redirect_to product_my_post_path(@product, @post), alert: &quot;No report found&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        redirect_to product_my_post_path(@product, @post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    elsif params[:date] == &#39;yesterday&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      if @post.reports.count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        redirect_to product_my_post_path(@product, @post), alert: &quot;No report found&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        redirect_to product_my_post_path(@product, @post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    elsif params[:commit] == &#39;Search&#39; || params[:commit] == &#39;GlobalSearch&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      # For search function</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      station = params[:station]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      config = params[:config]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      date_from = params[:date_range][0, 10] if params[:date_range]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      date_to = params[:date_range][13, 10] if params[:date_range]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      fix_datetime = params[:no_date_range] if params[:no_date_range]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      if params[:build].present? &amp;&amp; params[:build] == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        t = ReportMain.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        @reports_for_cart = ReportMain.where(post_id: @post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        @reports_for_cart = @reports_for_cart.where(t[:station_name].matches(&quot;#{station}&quot;)) if station.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      elsif params[:build].present? &amp;&amp; params[:build] == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        t = ReportMini.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        @reports_for_cart = ReportMini.where(post_id: @post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        @reports_for_cart = @reports_for_cart.where(t[:station_name].matches(&quot;#{station}&quot;)) if station.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        t = Report.arel_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        @reports_for_cart = Report.where(post_id: @post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        @reports_for_cart = @reports_for_cart.where(t[:station_name].matches(&quot;#{station}&quot;)) if station.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      if config.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        @reports_for_cart = @reports_for_cart.where(t[:config].matches(&quot;#{config}&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        # Only filter &quot;Config = ALL&quot; while searching from normal (Sum-All) page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        # Ignore doing this Config filter while searching from MAIN or MINI page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        if !params[:build].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          @reports_for_cart = @reports_for_cart.where(t[:config].matches(&quot;ALL&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      if date_from.present? &amp;&amp; date_to.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        if date_from != date_to # Search for multiple days (ex. Jun 20 ~ Jun 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">          # If search station, show data with each hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          if params[:station].present? &amp;&amp; params[:station] != &quot;&quot; &amp;&amp; params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">            @reports_for_cart = @reports_for_cart.where(&quot;(p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?) OR ((p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?)) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?)&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">              &quot;#{date_from.to_date.year}&quot;, &quot;#{date_from.to_date.month}&quot;, &quot;#{date_from.to_date.day}&quot;, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">              &quot;#{date_from.to_date.tomorrow.year}&quot;, &quot;#{date_to.to_date.year}&quot;, &quot;#{date_from.to_date.tomorrow.month}&quot;, &quot;#{date_to.to_date.month}&quot;, &quot;#{date_from.to_date.tomorrow.day}&quot;, &quot;#{date_to.to_date.day}&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">              &quot;#{date_to.to_date.tomorrow.year}&quot;, &quot;#{date_to.to_date.tomorrow.month}&quot;, &quot;#{date_to.to_date.tomorrow.day}&quot;, 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">            # Search build, show data with only latest hour in each day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">            @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) AND (p_hour &gt;= ?) ) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) AND (p_hour &lt; ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">              &quot;#{date_from.to_date.year}&quot;, &quot;#{date_to.to_date.year}&quot;, &quot;#{date_from.to_date.month}&quot;, &quot;#{date_to.to_date.month}&quot;, &quot;#{date_from.to_date.day}&quot;, &quot;#{date_to.to_date.day}&quot;, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">              &quot;#{date_from.to_date.tomorrow.year}&quot;, &quot;#{date_to.to_date.tomorrow.year}&quot;, &quot;#{date_from.to_date.tomorrow.month}&quot;, &quot;#{date_to.to_date.month}&quot;, &quot;#{date_from.to_date.tomorrow.day}&quot;, &quot;#{date_to.to_date.tomorrow.day}&quot;, 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">            # Define the date range for search feature</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">            search_date_range = (&quot;#{date_from}&quot;..&quot;#{date_to}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">            search_date_range.each do |the_date|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">              date_range_index = search_date_range.find_index(the_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">              #first_timestamp_of_date = @reports_for_cart.group([&quot;p_year&quot;, &quot;p_month&quot;, &quot;p_mday&quot;]).select(&quot;p_year, p_month, p_mday, Max(p_hour) as latest_hour&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">              #puts first_timestamp_of_date.p_mday.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">              record_of_midnight = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?&quot;, the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, 6).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">              latest_hour_of_tomorrow = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt; ?&quot;, the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, 6).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">              latest_hour_of_today = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt; ?&quot;, the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">              latest_hour_of_yesterday = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, the_date.to_date.yesterday.year, the_date.to_date.yesterday.month, the_date.to_date.yesterday.day, 6).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">              first_timestamp_of_date = @reports_for_cart.group([&quot;p_year&quot;, &quot;p_month&quot;, &quot;p_mday&quot;]).select(&quot;p_year, p_month, p_mday, Max(p_hour) as latest_hour&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">              last_timestamp_of_date = @reports_for_cart.group([&quot;p_year&quot;, &quot;p_month&quot;, &quot;p_mday&quot;]).select(&quot;p_year, p_month, p_mday, Max(p_mday) as last_day&quot;).order(&quot;p_mday DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">              # Check if tomorrow of the_date has data with (hour &lt; 6) for the_date.to_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">              if !record_of_midnight.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">                if !latest_hour_of_tomorrow.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">                  # Both record_of_midnight and latest_hour_of_tomorrow for the_date are found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">                  if !latest_hour_of_yesterday.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">                    puts &quot;ccccc&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">                    @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND (p_hour = ? OR p_hour = ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?))&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">                      the_date.to_date.tomorrow.tomorrow.year, search_date_range.last.to_date.tomorrow.year, the_date.to_date.tomorrow.tomorrow.month, search_date_range.last.to_date.tomorrow.month, the_date.to_date.tomorrow.tomorrow.day, search_date_range.last.to_date.tomorrow.day, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">                      the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, record_of_midnight.p_hour, latest_hour_of_tomorrow.p_hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">                      the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">                      search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">                    puts &quot;dddd&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">                    @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND (p_hour = ? OR p_hour = ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?))&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">                      the_date.to_date.tomorrow.tomorrow.year, search_date_range.last.to_date.tomorrow.year, the_date.to_date.tomorrow.tomorrow.month, search_date_range.last.to_date.tomorrow.month, the_date.to_date.tomorrow.tomorrow.day, search_date_range.last.to_date.tomorrow.day, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">                      the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, record_of_midnight.p_hour, latest_hour_of_tomorrow.p_hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">                      the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">                      search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">                  # latest_hour_of_tomorrow for the_date is not found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">                  puts &quot;ffff&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">                  @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?)&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">                    search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">                    the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, record_of_midnight.p_hour,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">                    the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">                # Check if there is latest hour (hour &gt; 6) exist for the_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">                if !latest_hour_of_today.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">                  puts &quot;first_timestamp_of_date: &quot; + first_timestamp_of_date.p_mday.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">                  puts &quot;last_timestamp_of_date: &quot; + last_timestamp_of_date.p_mday.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">                  #if search_date_range.find_index(the_date).equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">                  if first_timestamp_of_date.p_mday.equal? the_date.to_date.day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">                    if !search_date_range.find_index(the_date).equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">                      puts &quot;zzzz&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">                      @reports_for_cart = @reports_for_cart.where(&quot;(p_year = ? AND p_month = ? AND p_mday = ? AND (p_hour &lt; ? OR p_hour = ?)) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">                        the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6, latest_hour_of_today.p_hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">                        the_date.to_date.tomorrow.year, search_date_range.last.to_date.tomorrow.year, the_date.to_date.tomorrow.month, search_date_range.last.to_date.tomorrow.month, the_date.to_date.tomorrow.day, search_date_range.last.to_date.tomorrow.day, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">                        search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">                    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">                      puts &quot;aaaa&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">                      @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">                        the_date.to_date.tomorrow.year, search_date_range.last.to_date.tomorrow.year, the_date.to_date.tomorrow.month, search_date_range.last.to_date.tomorrow.month, the_date.to_date.tomorrow.day, search_date_range.last.to_date.tomorrow.day, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">                        the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, latest_hour_of_today.p_hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">                        search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">                  elsif search_date_range.find_index(the_date).between? 1, search_date_range.count - 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">                    puts &quot;bbbb&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">                    @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) ) OR (p_year = ? AND p_month = ? AND p_mday = ? AND (p_hour &lt; ? OR p_hour = ?)) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">                      the_date.to_date.tomorrow.year, search_date_range.last.to_date.tomorrow.year, the_date.to_date.tomorrow.month, search_date_range.last.to_date.tomorrow.month, the_date.to_date.tomorrow.day, search_date_range.last.to_date.tomorrow.day, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">                      the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6, latest_hour_of_today.p_hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">                      search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">                  elsif last_timestamp_of_date.p_mday.equal? the_date.to_date.day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">                    puts &quot;yyyy&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">                    @reports_for_cart = @reports_for_cart.where(&quot;(p_year = ? AND p_month = ? AND p_mday = ? AND (p_hour = ? OR p_hour &lt; ?)) OR ( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">                      the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, latest_hour_of_today.p_hour, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">                      search_date_range.first.to_date.year, the_date.to_date.yesterday.year, search_date_range.first.to_date.month, the_date.to_date.yesterday.month, search_date_range.first.to_date.day, the_date.to_date.yesterday.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">              # After handling last datetime timestamp (search_date_range.last), check if 2nd date of timestamp has midnight hour (hour &lt; 6), if yes then delete all records of 1st date of timestamp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">              if (search_date_range.find_index(the_date).equal? search_date_range.count - 1) &amp;&amp; record_of_midnight.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">                puts &quot;ggggg&quot; + the_date.to_date.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">                #latest_hour_of_first_date = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, search_date_range.first.to_date.year, search_date_range.first.to_date.month, search_date_range.first.to_date.day, 6).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">                midnight_hour_of_second_date = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?&quot;, search_date_range.first.to_date.tomorrow.year, search_date_range.first.to_date.tomorrow.month, search_date_range.first.to_date.tomorrow.day, 6).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">                if !midnight_hour_of_second_date.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">                  @reports_for_cart = @reports_for_cart.where(&quot;( (p_year BETWEEN ? AND ?) AND (p_month BETWEEN ? AND ?) AND (p_mday BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">                    search_date_range.first.to_date.tomorrow.year, search_date_range.last.to_date.year, search_date_range.first.to_date.tomorrow.month, search_date_range.last.to_date.month, search_date_range.first.to_date.tomorrow.day, search_date_range.last.to_date.day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">          the_date = &quot;#{date_from}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">          record_of_midnight = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?&quot;, the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, 6).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">          if !record_of_midnight.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">            puts &quot;mmmmm &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">            @reports_for_cart = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">              the_date.to_date.tomorrow.year, the_date.to_date.tomorrow.month, the_date.to_date.tomorrow.day, record_of_midnight.p_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">            puts &quot;nnnnn&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">            latest_hour_of_today = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, 6).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">            @reports_for_cart = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">              the_date.to_date.year, the_date.to_date.month, the_date.to_date.day, latest_hour_of_today.p_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">          #@reports_for_cart = @reports_for_cart.where(&quot;(p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &lt; ?)&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">          #  &quot;#{date_from.to_date.year}&quot;, &quot;#{date_from.to_date.month}&quot;, &quot;#{date_from.to_date.day}&quot;, 6, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">          #  &quot;#{date_from.to_date.tomorrow.year}&quot;, &quot;#{date_from.to_date.tomorrow.month}&quot;, &quot;#{date_from.to_date.tomorrow.day}&quot;, 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">          if params[:station] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">            latest_date = @reports_for_cart.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">            @reports_for_cart = @reports_for_cart.where(published_at: latest_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">      if fix_datetime.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        # Search config at specific datetime</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        @reports_for_cart = @reports_for_cart.where(&quot;p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">          fix_datetime.to_datetime.year, fix_datetime.to_datetime.month, fix_datetime.to_datetime.day, fix_datetime.to_datetime.hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      report_for_tmp = @reports_for_cart</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      @reports_for_cart = report_for_tmp.order(&quot;published_at ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">      @reports = report_for_tmp.order(&quot;published_at DESC, seqno ASC&quot;).page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">    @post = @product.posts.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">    if params[:build] == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">      @report = @post.report_mains.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">    elsif params[:build] == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">      @report = @post.report_minis.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">      @report = @post.reports.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    if request.post? &amp;&amp; params[:file].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      csv_files = params[:file]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">      imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">      filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      csv_files.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        # Prevent duplicated importing file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">        filename = sanitize_filename(file.original_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">        filename = filename.gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        line_count = `wc -l &quot;#{file.path}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">          duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">            format.json { render json: {error: filename + &#39; already exists.&#39;} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">          filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">            format.json { render json: {error: &#39;You are not allowed to upload &#39; + filename} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">          no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">          respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">            format.json { render json: { error: &#39;There is no row data in &#39; + filename } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">          trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">          trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">          model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">          if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">            Report.import_data(file.path, filename, post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">              count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">              # Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">              if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">                respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">                  format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">                respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">                  format.json { render json: { error: &#39;Data lost while importing from &#39; + filename } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">            # Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">            puts product_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">              product = Product.create(user_id: current_user.id, title: product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">            post = Post.create(user_id: current_user.id, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">            Report.import_data(file.path, filename, post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">              count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">              # Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">              if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">                respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">                  format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">                respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">                  format.json { render json: { error: &#39;Data lost while importing from &#39; + filename } }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">  def sanitize_filename(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">    return filename.strip do |name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">     # NOTE: File.basename doesn&#39;t work right with Windows paths on Unix</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">     # get only the filename, not the whole path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">     name.gsub!(/^.*(\\|\/)/, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">     # Strip out the non-ascii character</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">     name.gsub!(/[^0-9A-Za-z.\-]/, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="872414610b395d5e63c0d3c2a093b77b3c9ec68e">
  <div class="header">
    <h3>app/controllers/stations_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class StationsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	page = (params[:page] || 1).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  	@product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  	@post = Post.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    @station = @post.stations.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    # Get reports by date is parameters present</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    build = params[:build].to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    if build == &#39;main&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      reports_by_all_config = @station.report_mains</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    elsif build == &#39;mini&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      reports_by_all_config = @station.report_minis</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      reports_by_all_config = @station.reports.where(config: &#39;ALL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    if params[:date] == &#39;today&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      @reports_for_cart = get_today_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  	elsif params[:date] == &#39;yesterday&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  	  @reports_for_cart = get_yesterday_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    elsif params[:date_range].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      # For search feature! Show station&#39;s data with specific date from search box</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      the_date = params[:date_range]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      @reports_for_cart = get_target_date_yield(@post, reports_by_all_config, build, the_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    else # Same as &#39;Today&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      @reports_for_cart = get_today_yield(@post, reports_by_all_config, build)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">	  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    reports_tmp = @reports_for_cart</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @reports_for_cart = reports_tmp.order(&quot;published_at ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    @reports = reports_tmp.order(&quot;published_at DESC&quot;).page(page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d5dc5e13aaa0bf866b2723c708c6b9ac2b2c964d">
  <div class="header">
    <h3>app/controllers/yield_files_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>51</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class YieldFilesController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  before_filter :authenticate_user!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @post = Post.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    @files = @post.yield_files.order(&quot;created_at DESC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    @post = Post.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @file = @post.yield_files.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if @file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      if @file.file_name.include? &quot;Sum-Main&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        @reports = @post.report_mains.where(yield_file_id: @file).order(&quot;seqno ASC&quot;).page(params[:page])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      elsif @file.file_name.include? &quot;Sum-Mini&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        @reports = @post.report_minis.where(yield_file_id: @file).order(&quot;seqno ASC&quot;).page(params[:page])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        @reports = @post.reports.where(yield_file_id: @file).order(&quot;seqno ASC&quot;).page(params[:page])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">  	@post = Post.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    @reports = @post.reports.order(&quot;published_at ASC&quot;).page(params[:page])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">  	@file = @post.yield_files.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      format.html { redirect_to product_my_post_path(@product, @post), notice: &quot;Successfully removed &#39;#{@file.file_name}&#39;&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  def destroy_multiple</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    @product = Product.find(params[:product_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    @post = Post.find(params[:my_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    if params[:file_ids]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      YieldFile.where(id: params[:file_ids]).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      #YieldFile.destroy_all(id: params[:file_ids])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      respond_to do |format|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        format.js { head :ok }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        format.html { redirect_to product_my_post_yield_files_path(@product, @post), notice: &quot;Successfully removed #{params[:file_ids].count} selected files&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        format.json { head :no_content }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f9d49ec755a0b049fe2a2715cbfbd1939077d274">
  <div class="header">
    <h3>app/helpers/api/posts_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::PostsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="40171d8da8c6f3c06df53a2a7835a694306d0f19">
  <div class="header">
    <h3>app/helpers/api/v1/my_posts_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::V1::MyPostsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="84e75d5b106d81f847e14501665d1388e7d68011">
  <div class="header">
    <h3>app/helpers/api/v1/posts_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::V1::PostsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="db8683748106f78aae1b07828b63d36fd736040a">
  <div class="header">
    <h3>app/helpers/api/v1/reports_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::V1::ReportsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6ceec76f94f198e9b8775421b99df9ebdf97d2a7">
  <div class="header">
    <h3>app/helpers/api/v1/users_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::V1::UsersHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2f4ef67581b8fe2028bbc2acd63416352b02a4be">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4><span class="red">52.94 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # For breadcrumbs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_navigation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    @navigation ||= [ { :title =&gt; &#39;Home&#39;, :url =&gt; &#39;/&#39; } ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def navigation_add(title, url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  	ensure_navigation &lt;&lt; { :title =&gt; title, :url =&gt; url }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_navigation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  	render :partial =&gt; &#39;layouts/navigation&#39;, :locals =&gt; { :nav =&gt; ensure_navigation }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_yield_rate(yield_rate)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    render :partial =&gt; &#39;layouts/yield_rate&#39;, locals: { yield_rate: yield_rate }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_class(link_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    current_page?(link_path) ? &quot;active&quot; : &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_config_counts(report)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    return Report.where(&#39;post_id = ? AND config != ? AND station_name = ? AND published_at = ?&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      report.post_id, &#39;ALL&#39;, report.station_name, report.published_at).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_main_mini_config_counts(report)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    return Report.where(&#39;post_id = ? AND config IN (?) AND station_name = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour = ?&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      report.post_id, report.config.split(&#39;;&#39;), report.station_name, report.p_year, report.p_month, report.p_mday, report.p_hour).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_yield_counts(post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    return post.reports.where(config: &#39;ALL&#39;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="64f3f66b63d3a996930c963ef2f2b6db2400ebee">
  <div class="header">
    <h3>app/helpers/configs_helper.rb</h3>
    <h4><span class="red">8.11 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ConfigsHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def accu_yield_ratio_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    datetime = reports.first.published_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    # overflow_accu_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate &gt; ?&quot;, &#39;ALL&#39;, station, datetime, 100.00).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    # great_accu_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 99.51, 100.00).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # bad_accu_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 90.00, 99.50).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # worse_accu_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 0.00, 89.99).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # no_input_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate IS NULL&quot;, &#39;ALL&#39;, station, datetime).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    overflow_accu_yield = reports.where(&quot;yield_rate &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    great_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    bad_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    worse_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    no_input_yield = reports.where(&quot;yield_rate IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    overflow_accu_yield_rate = ((overflow_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    great_accu_yield_rate = ((great_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    bad_accu_yield_rate = ((bad_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    worse_accu_yield_rate = ((worse_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    range_array = [overflow_accu_yield, great_accu_yield, bad_accu_yield, worse_accu_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    title = [&#39;Overflow Accu Yield&#39;, &#39;Verified Accu Yield&#39;, &#39;Bad Accu Yield&#39;, &#39;Worse Accu Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    percent = [overflow_accu_yield_rate, great_accu_yield_rate, bad_accu_yield_rate, worse_accu_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def daily_yield_ratio_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    datetime = reports.first.published_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # overflow_daily_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate_today &gt; ?&quot;, &#39;ALL&#39;, station, datetime, 100.00).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # great_daily_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 99.51, 100.00).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # bad_daily_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 90.00, 99.50).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # worse_daily_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, &#39;ALL&#39;, station, datetime, 0.00, 89.99).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # no_input_yield = Report.where(&quot;config != ? AND station_name = ? AND published_at = ? AND yield_rate_today IS NULL&quot;, &#39;ALL&#39;, station, datetime).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    overflow_daily_yield = reports.where(&quot;yield_rate_today &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    great_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    bad_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    worse_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    no_input_yield = reports.where(&quot;yield_rate_today IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    overflow_daily_yield_rate = ((overflow_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    great_daily_yield_rate = ((great_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    bad_daily_yield_rate = ((bad_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    worse_daily_yield_rate = ((worse_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    range_array = [overflow_daily_yield, great_daily_yield, bad_daily_yield, worse_daily_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    title = [&#39;Overflow Daily Yield&#39;, &#39;Verified Daily Yield&#39;, &#39;Bad Daily Yield&#39;, &#39;Worse Daily Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    percent = [overflow_daily_yield_rate, great_daily_yield_rate, bad_daily_yield_rate, worse_daily_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bde0854b6686455c7010062d9e6f6bce913404e3">
  <div class="header">
    <h3>app/helpers/errors_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ErrorsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2c84dc224c262868a116e6cbc2c650de89207174">
  <div class="header">
    <h3>app/helpers/main_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module MainHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="8942d1033cd2037b35210de4b934e7d61c53eb49">
  <div class="header">
    <h3>app/helpers/my_posts_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module MyPostsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ecd6d6aa86ad1552a5ac64e7f97d233a41a3f128">
  <div class="header">
    <h3>app/helpers/omniauth_callbacks_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module OmniauthCallbacksHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5e0b98d4b2349863dfbe08cdd227c4976fc0bbd9">
  <div class="header">
    <h3>app/helpers/posts_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module PostsHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="452d201139ca113c7327ae7ffa28118a0a00e017">
  <div class="header">
    <h3>app/helpers/reports_helper.rb</h3>
    <h4><span class="red">7.5 %</span> covered</h4>
    <div>
      <b>80</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>74</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ReportsHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def worst_yield_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    start_time = reports.last.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    end_time = reports.first.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    post_id = reports.first.post_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    if controller.controller_name == &quot;reports&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      # For search build page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      datetime = reports.select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # For general build page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      datetime = Report.where(&quot;post_id = ? AND config = ? AND published_at BETWEEN ? AND ?&quot;, post_id, &#39;ALL&#39;, start_time, end_time).select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    datetime.map do |date|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      published_at: date.published_at.to_datetime.to_formatted_s(:long),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # No.1 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      worst_accu_yield: Report.group_accu_yield_by_date(date.published_at).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      worst_daily_yield: Report.group_daily_yield_by_date(date.published_at).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      worst_fp_accu_yield: Report.group_fp_accu_yield_by_date(date.published_at).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      worst_fp_daily_yield: Report.group_fp_daily_yield_by_date(date.published_at).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      worst_accu_station: Report.group_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      worst_daily_station: Report.group_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      worst_fp_accu_station: Report.group_fp_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      worst_fp_daily_station: Report.group_fp_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      # No.2 Worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      worse_accu_yield: Report.group_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      worse_daily_yield: Report.group_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      worse_fp_accu_yield: Report.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      worse_fp_daily_yield: Report.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      worse_accu_station: Report.group_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      worse_daily_station: Report.group_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      worse_fp_accu_station: Report.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      worse_fp_daily_station: Report.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # No.3 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      bad_accu_yield: Report.group_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      bad_daily_yield: Report.group_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      bad_fp_accu_yield: Report.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      bad_fp_daily_yield: Report.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      bad_accu_station: Report.group_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      bad_daily_station: Report.group_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      bad_fp_accu_station: Report.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      bad_fp_daily_station: Report.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      # No.4 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      bad2_accu_yield: Report.group_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      bad2_daily_yield: Report.group_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      bad2_fp_accu_yield: Report.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      bad2_fp_daily_yield: Report.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      bad2_accu_station: Report.group_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      bad2_daily_station: Report.group_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      bad2_fp_accu_station: Report.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      bad2_fp_daily_station: Report.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # No.5 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      bad3_accu_yield: Report.group_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      bad3_daily_yield: Report.group_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      bad3_fp_accu_yield: Report.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      bad3_fp_daily_yield: Report.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      bad3_accu_station: Report.group_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      bad3_daily_station: Report.group_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      bad3_fp_accu_station: Report.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      bad3_fp_daily_station: Report.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def worst_yield_chart_main_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    start_time = reports.last.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    end_time = reports.first.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    post_id = reports.first.post_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if controller.controller_name == &quot;reports&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      # For search build page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      datetime = reports.select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      datetime = ReportMain.where(&quot;post_id = ? AND published_at BETWEEN ? AND ?&quot;, post_id, start_time, end_time).select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    datetime.map do |date|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      published_at: date.published_at.to_datetime.to_formatted_s(:long),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # No.1 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      worst_accu_yield: ReportMain.group_accu_yield_by_date(date.published_at).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      worst_daily_yield: ReportMain.group_daily_yield_by_date(date.published_at).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      worst_fp_accu_yield: ReportMain.group_fp_accu_yield_by_date(date.published_at).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      worst_fp_daily_yield: ReportMain.group_fp_daily_yield_by_date(date.published_at).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      worst_accu_station: ReportMain.group_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      worst_daily_station: ReportMain.group_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      worst_fp_accu_station: ReportMain.group_fp_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      worst_fp_daily_station: ReportMain.group_fp_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      # No.2 Worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      worse_accu_yield: ReportMain.group_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      worse_daily_yield: ReportMain.group_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      worse_fp_accu_yield: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      worse_fp_daily_yield: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      worse_accu_station: ReportMain.group_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      worse_daily_station: ReportMain.group_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      worse_fp_accu_station: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      worse_fp_daily_station: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      # No.3 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      bad_accu_yield: ReportMain.group_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      bad_daily_yield: ReportMain.group_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      bad_fp_accu_yield: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      bad_fp_daily_yield: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      bad_accu_station: ReportMain.group_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      bad_daily_station: ReportMain.group_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      bad_fp_accu_station: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      bad_fp_daily_station: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      # No.4 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      bad2_accu_yield: ReportMain.group_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      bad2_daily_yield: ReportMain.group_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      bad2_fp_accu_yield: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      bad2_fp_daily_yield: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      bad2_accu_station: ReportMain.group_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      bad2_daily_station: ReportMain.group_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      bad2_fp_accu_station: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      bad2_fp_daily_station: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      # No.5 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      bad3_accu_yield: ReportMain.group_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      bad3_daily_yield: ReportMain.group_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      bad3_fp_accu_yield: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      bad3_fp_daily_yield: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      bad3_accu_station: ReportMain.group_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      bad3_daily_station: ReportMain.group_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      bad3_fp_accu_station: ReportMain.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      bad3_fp_daily_station: ReportMain.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">  def worst_yield_chart_mini_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    start_time = reports.last.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    end_time = reports.first.published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    post_id = reports.first.post_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    if controller.controller_name == &quot;reports&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      # For search build page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      datetime = reports.select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      datetime = ReportMini.where(&quot;post_id = ? AND published_at BETWEEN ? AND ?&quot;, post_id, start_time, end_time).select(&quot;distinct(published_at)&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    datetime.map do |date|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      published_at: date.published_at.to_datetime.to_formatted_s(:long),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      # No.1 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      worst_accu_yield: ReportMini.group_accu_yield_by_date(date.published_at).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      worst_daily_yield: ReportMini.group_daily_yield_by_date(date.published_at).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      worst_fp_accu_yield: ReportMini.group_fp_accu_yield_by_date(date.published_at).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      worst_fp_daily_yield: ReportMini.group_fp_daily_yield_by_date(date.published_at).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      worst_accu_station: ReportMini.group_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      worst_daily_station: ReportMini.group_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      worst_fp_accu_station: ReportMini.group_fp_accu_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      worst_fp_daily_station: ReportMini.group_fp_daily_yield_by_date(date.published_at).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      # No.2 Worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      worse_accu_yield: ReportMini.group_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      worse_daily_yield: ReportMini.group_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      worse_fp_accu_yield: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      worse_fp_daily_yield: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      worse_accu_station: ReportMini.group_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      worse_daily_station: ReportMini.group_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      worse_fp_accu_station: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      worse_fp_daily_station: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(1).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      # No.3 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      bad_accu_yield: ReportMini.group_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      bad_daily_yield: ReportMini.group_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      bad_fp_accu_yield: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      bad_fp_daily_yield: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      bad_accu_station: ReportMini.group_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      bad_daily_station: ReportMini.group_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      bad_fp_accu_station: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      bad_fp_daily_station: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(2).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      # No.4 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      bad2_accu_yield: ReportMini.group_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      bad2_daily_yield: ReportMini.group_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      bad2_fp_accu_yield: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      bad2_fp_daily_yield: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      bad2_accu_station: ReportMini.group_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      bad2_daily_station: ReportMini.group_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      bad2_fp_accu_station: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      bad2_fp_daily_station: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(3).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      # No.5 worst yield rate &amp; station name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      bad3_accu_yield: ReportMini.group_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      bad3_daily_yield: ReportMini.group_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      bad3_fp_accu_yield: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_accu_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      bad3_fp_daily_yield: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:worst_fp_daily_yield),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      bad3_accu_station: ReportMini.group_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      bad3_daily_station: ReportMini.group_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      bad3_fp_accu_station: ReportMini.group_fp_accu_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      bad3_fp_daily_station: ReportMini.group_fp_daily_yield_by_date(date.published_at).offset(4).first.try(:station_name) || &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">  def config_accu_yield_bar_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    config = reports.first.config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    datetime_start = reports.minimum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    datetime_end = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      # If parameter present, show each hour&#39;s report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      overflow_accu_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate &gt; ?&quot;, config, station, datetime_start, datetime_end, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">      great_accu_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, config, station, datetime_start, datetime_end, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      bad_accu_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, config, station, datetime_start, datetime_end, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">      worse_accu_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, config, station, datetime_start, datetime_end, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      no_input_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate IS NULL&quot;, config, station, datetime_start, datetime_end).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      # By default, only show latest hour&#39;s report for each day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      overflow_accu_yield = reports.where(&quot;yield_rate &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      great_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      bad_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      worse_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;yield_rate IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">    overflow_accu_yield_rate = ((overflow_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    great_accu_yield_rate = ((great_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    bad_accu_yield_rate = ((bad_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    worse_accu_yield_rate = ((worse_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    range_array = [overflow_accu_yield, great_accu_yield, bad_accu_yield, worse_accu_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    title = [&#39;Overflow Accu Yield&#39;, &#39;Verified Accu Yield&#39;, &#39;Bad Accu Yield&#39;, &#39;Worse Accu Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    percent = [overflow_accu_yield_rate, great_accu_yield_rate, bad_accu_yield_rate, worse_accu_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">  def config_daily_yield_bar_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">    config = reports.first.config</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">    datetime_start = reports.minimum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">    datetime_end = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">    if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # If parameter present, show each hour&#39;s report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      overflow_daily_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate_today &gt; ?&quot;, config, station, datetime_start, datetime_end, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">      great_daily_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, config, station, datetime_start, datetime_end, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      bad_daily_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, config, station, datetime_start, datetime_end, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      worse_daily_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, config, station, datetime_start, datetime_end, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      no_input_yield = Report.where(&quot;config = ? AND station_name = ? AND published_at BETWEEN ? AND ? AND yield_rate_today IS NULL&quot;, config, station, datetime_start, datetime_end).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      # By default, only show latest hour&#39;s report for each day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">      overflow_daily_yield = reports.where(&quot;yield_rate_today &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">      great_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      bad_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">      worse_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;yield_rate_today IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">    overflow_daily_yield_rate = ((overflow_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">    great_daily_yield_rate = ((great_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    bad_daily_yield_rate = ((bad_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    worse_daily_yield_rate = ((worse_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    range_array = [overflow_daily_yield, great_daily_yield, bad_daily_yield, worse_daily_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">    title = [&#39;Overflow Daily Yield&#39;, &#39;Verified Daily Yield&#39;, &#39;Bad Daily Yield&#39;, &#39;Worse Daily Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">    percent = [overflow_daily_yield_rate, great_daily_yield_rate, bad_daily_yield_rate, worse_daily_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="542127bc654deec3b1947806f236ac8ddf09546f">
  <div class="header">
    <h3>app/helpers/stations_helper.rb</h3>
    <h4><span class="red">5.66 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>50</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">module StationsHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  def station_accu_yield_ratio_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    build = reports.first.post_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    datetime_start = reports.minimum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    datetime_end = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    if params[:data_period].present? &amp;&amp; params[:data_period] == &quot;hourly&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      # If parameter present, show each hour&#39;s report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      overflow_accu_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate &gt; ?&quot;, datetime_start, datetime_end, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      great_accu_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, datetime_start, datetime_end, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      bad_accu_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, datetime_start, datetime_end, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      worse_accu_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, datetime_start, datetime_end, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate IS NULL&quot;, datetime_start, datetime_end).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # By default, only show latest hour&#39;s report for each day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      overflow_accu_yield = reports.where(&quot;yield_rate &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      great_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      bad_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      worse_accu_yield = reports.where(&quot;yield_rate &gt;= ? AND yield_rate &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;yield_rate IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    overflow_accu_yield_rate = ((overflow_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    great_accu_yield_rate = ((great_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    bad_accu_yield_rate = ((bad_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    worse_accu_yield_rate = ((worse_accu_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    range_array = [overflow_accu_yield, great_accu_yield, bad_accu_yield, worse_accu_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    title = [&#39;Overflow Accu Yield&#39;, &#39;Verified Accu Yield&#39;, &#39;Bad Accu Yield&#39;, &#39;Worst Accu Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    percent = [overflow_accu_yield_rate, great_accu_yield_rate, bad_accu_yield_rate, worse_accu_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def station_daily_yield_ratio_chart_data(reports)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    station = reports.first.station_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    build = reports.first.post_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    datetime_start = reports.minimum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    datetime_end = reports.maximum(&#39;published_at&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    if params[:hourly_data].present? &amp;&amp; params[:hourly_data] != &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      # If parameter present, show each hour&#39;s report</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      overflow_daily_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate_today &gt; ?&quot;, datetime_start, datetime_end, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      great_daily_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, datetime_start, datetime_end, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      bad_daily_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, datetime_start, datetime_end, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      worse_daily_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, datetime_start, datetime_end, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;published_at BETWEEN ? AND ? AND yield_rate_today IS NULL&quot;, datetime_start, datetime_end).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # By default, only show latest hour&#39;s report for each day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      overflow_daily_yield = reports.where(&quot;yield_rate_today &gt; ?&quot;, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      great_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 99.51, 100.00).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      bad_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 90.00, 99.50).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      worse_daily_yield = reports.where(&quot;yield_rate_today &gt;= ? AND yield_rate_today &lt;= ?&quot;, 0.00, 89.99).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      no_input_yield = reports.where(&quot;yield_rate_today IS NULL&quot;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    overflow_daily_yield_rate = ((overflow_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    great_daily_yield_rate = ((great_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    bad_daily_yield_rate = ((bad_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    worse_daily_yield_rate = ((worse_daily_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    no_input_yield_rate = ((no_input_yield.to_f / reports.count.to_f) * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    range_array = [overflow_daily_yield, great_daily_yield, bad_daily_yield, worse_daily_yield, no_input_yield]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">    title = [&#39;Overflow Daily Yield&#39;, &#39;Verified Daily Yield&#39;, &#39;Bad Daily Yield&#39;, &#39;Worst Daily Yield&#39;, &#39;No Input&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    percent = [overflow_daily_yield_rate, great_daily_yield_rate, bad_daily_yield_rate, worse_daily_yield_rate, no_input_yield_rate]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    range_array.map.with_index do |range, index| {  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      value: range,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      label: title[index],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      percent: percent[index]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5cf37ba875a4a669db10d86c8506d17e212f3ff0">
  <div class="header">
    <h3>app/models/admin_user.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class AdminUser &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Include default devise modules. Others available are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # :token_authenticatable, :encryptable, :confirmable, :lockable, :timeoutable and :omniauthable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :database_authenticatable, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">         :recoverable, :rememberable, :trackable, :validatable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Setup accessible (or protected) attributes for your model</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessible :email, :password, :password_confirmation, :remember_me</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # attr_accessible :title, :body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9ba4b4a10151ccaa91d70b490d00295b357ca2fa">
  <div class="header">
    <h3>app/models/api_error.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ApiError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessor :error, :error_description, :messages</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def self.json(error, error_description, messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    self.new(error, error_description, messages).to_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def initialize(error, error_description, messages)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @error = error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @error_description = error_description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    @messages = messages</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b0f5bed65edbfbd7027a6c6b8749275504b0e38f">
  <div class="header">
    <h3>app/models/device.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Device &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessible :enabled, :uuid, :user, :platform</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  validates_uniqueness_of :token, scope: :user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5a9f4b2d7151036b7308a50cb37332619dfd3f5e">
  <div class="header">
    <h3>app/models/facebook_user.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class FacebookUser</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessor :id, :name, :first_name, :last_name, :username, :gender</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def initialize(hash = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @hash = hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  def id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @hash[:id.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @hash[:name.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @hash[:first_name.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def last_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @hash[:last_name.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  def username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    @hash[:username.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def gender</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    @hash[:gender.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  def inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @hash.inspect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f773582fe9a446cb7d928628d202b7f096342534">
  <div class="header">
    <h3>app/models/post.rb</h3>
    <h4><span class="red">72.41 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Post &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessible :content, :published_at, :title, :publish, :user_id, :product_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :publish</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessible :current_year, :current_month, :current_mday, :current_hour, :current_year_main, :current_month_main, :current_mday_main, :current_hour_main, :current_year_mini, :current_month_mini, :current_mday_mini, :current_hour_mini</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :product</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :reports, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :report_mains, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :report_minis, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :yield_files, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :stations, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :title, presence: true, length: { :minimum =&gt; 3, :maximum =&gt; 255 }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :content, length: { :minimum =&gt; 0, :maximum =&gt; 10000 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  #before_save :set_published_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :published, where(&quot;published_at IS NOT NULL&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :alive, where(&quot;deleted_at IS NULL&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :my, lambda { |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    where(:user_id =&gt; user.id).order(&quot;updated_at DESC&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :accessible, lambda { |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    where(&quot;user_id = ? OR published_at IS NOT NULL&quot;, user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def published</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    published_at != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def deleted</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    deleted_at != nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    if (publish == true || publish == &quot;true&quot; || publish == &quot;1&quot;) &amp;&amp; published_at.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      self.published_at = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    elsif (publish != true &amp;&amp; publish != &quot;true&quot; &amp;&amp; publish != &quot;1&quot;) &amp;&amp; published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      self.published_at = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4b28cf76e7b8bbb50ffac1fc56cd0bc89e448617">
  <div class="header">
    <h3>app/models/product.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Product &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessible :title, :user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  has_many :posts, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  validates :title, presence: true, length: { :minimum =&gt; 3, :maximum =&gt; 255 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  paginates_per 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4bd578208df1e60b497da5ee90daca8ee1c52200">
  <div class="header">
    <h3>app/models/report.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>835</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>835</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &quot;activerecord-import/base&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">ActiveRecord::Import.require_adapter(&#39;mysql2&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class Report &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  attr_accessible :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  belongs_to :yield_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  belongs_to :station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  validates :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, presence: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  # Set yield report records per page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  paginates_per 20</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  before_validation do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    if published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      self.p_year = published_at.year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      self.p_month = published_at.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      self.p_mday = published_at.mday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      self.p_hour = published_at.hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  # Caculate yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  # If timestamp of hour is 6am, Get year, month, day, post_id and station_name of the base record, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  # and update each record&#39;s daily yield that belong to the same day with base record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  before_create do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if self.p_hour.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      records = Report.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        self.post_id, self.station_name, self.config, self.p_year, self.p_month, self.p_mday, 7, 23, self.p_mday + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if records.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          output_today = (record.first_pass.to_i - self.first_pass.to_i) + (record.retest_pass.to_i - self.retest_pass.to_i) + (record.test_waive.to_i - self.test_waive.to_i) + (record.design_waive.to_i - self.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          (record.cof_waive.to_i - self.cof_waive.to_i) + (record.ntf.to_i - self.ntf.to_i) + (record.failure_waive.to_i - self.failure_waive.to_i) + (record.repaire_ok.to_i - self.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          input_today = record.input.to_i - self.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            yield_rate_today = yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      # Get first record with same day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 7).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        #   if self.config == &#39;ALL&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        #     base_record_without_station = Report.where(&quot;post_id = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, &#39;ALL&#39;, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        #   else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        #     base_record_without_station = Report.where(&quot;post_id = ? AND config != ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, &#39;ALL&#39;, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        #     record = Report.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.year, p_month: datetime.month, p_mday: datetime.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        #   Report.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        # base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        #   if self.config == &#39;ALL&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        #     base_record_without_station = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, &#39;ALL&#39;, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        #   else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        #     base_record_without_station = Report.where(&quot;post_id = ? AND station_name = ? AND config != ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, &#39;ALL&#39;, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        #     record = Report.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.yesterday.year, p_month: datetime.yesterday.month, p_mday: datetime.yesterday.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        #   Report.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        # base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        output_today = (self.first_pass.to_i - base_record.first_pass.to_i) + (self.retest_pass.to_i - base_record.retest_pass.to_i) + (self.test_waive.to_i - base_record.test_waive.to_i) + (self.design_waive.to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">          (self.cof_waive.to_i - base_record.cof_waive.to_i) + (self.ntf.to_i - base_record.ntf.to_i) + (self.failure_waive.to_i - base_record.failure_waive.to_i) + (self.repaire_ok.to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        input_today = self.input.to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          self.yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          self.yield_rate_today = self.yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">          self.fp_yield_rate_today = ( (self.first_pass.to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          self.fp_yield_rate_today = self.fp_yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">          self.yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          self.fp_yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        self.yield_rate_today = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">  SORT_NAMES = %w(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    published_at model stage seqno station_name yield_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">  )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">  def self.sort_names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    SORT_NAMES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">  def base_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      return Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6, self.p_hour-1).first.equal? nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      look_from_yesterday = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, 23).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      look_from_today = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 0, self.p_hour-1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      return look_from_yesterday.nil? &amp;&amp; look_from_today.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    else # datetime.hour is 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">  def self.group_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    reports = where(&quot;config = ? AND yield_rate IS NOT NULL AND published_at = ?&quot;, &#39;ALL&#39;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate) as worst_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">  def self.group_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    reports = where(&quot;config = ? AND yield_rate_today IS NOT NULL AND published_at = ?&quot;, &#39;ALL&#39;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate_today) as worst_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">  def self.group_fp_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    reports = where(&quot;config = ? AND fp_yield_rate IS NOT NULL AND published_at = ?&quot;, &#39;ALL&#39;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate) as worst_fp_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">  def self.group_fp_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    reports = where(&quot;config = ? AND fp_yield_rate_today IS NOT NULL AND published_at = ?&quot;, &#39;ALL&#39;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate_today) as worst_fp_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">  # Insert rows on specific line in a file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">  def self.write_at(fname, at_line, sdat)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    open(fname, &#39;r+&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      while (at_line-=1) &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        f.readline</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      pos = f.pos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">      rest = f.read</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      f.seek pos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      f.write sdat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      f.write rest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">  # The &#39;import&#39; function can be used both on web and rake script</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">  def self.import_data(file, filename, post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    # Check filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    if csvfile = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      yf_id = csvfile.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      line_count = CSV.open(file, &quot;r&quot;).readlines.count - 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      # Set published_at from file name, and create the file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      yield_file = YieldFile.create(post_id: post.id, file_name: filename, total_row: line_count, published_at: file_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      yf_id = yield_file.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    # Define the folder path of XML files, and then delete all files before importing new csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    file_model_stage_name = filename[filename.index(&#39;20&#39;)+12..filename.index(&#39;.csv&#39;)-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    file_stage_name = file_model_stage_name[file_model_stage_name.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    file_model_name = file_model_stage_name.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    GC.disable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">    Report.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">        :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">      CSV.foreach(file, {encoding: &quot;UTF-8&quot;, quote_char: &#39;&quot;&#39;, col_sep: &#39;,&#39;, row_sep: :auto, headers: true}) do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        # Create station model and set station_id to Report obj</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        if station = Station.find_by_name_and_post_id(row[&#39;Station&#39;], post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">          station = Station.create(post_id: post.id, yield_file_id: yf_id, name: row[&#39;Station&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        # Caculate accumulative yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        if !row[&#39;Input&#39;].to_i.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">          total = row[&#39;PFirstPass&#39;].to_i + row[&#39;PRetestPass&#39;].to_i + row[&#39;TestWF&#39;].to_i + row[&#39;DesignWF&#39;].to_i + row[&#39;COFWF&#39;].to_i + row[&#39;NTF&#39;].to_i + row[&#39;FailureWF&#39;].to_i + row[&#39;RepairOK&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">          yield_rate = ( (total.to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">          fp_yield_rate = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">          fp_yield_rate_today = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">          yield_rate = 99999 # Input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">          fp_yield_rate = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">          fp_yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">        if Time.parse(row[&#39;Date&#39;]).hour.to_i.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          records_to_be_upfate = Report.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">            ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">            post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, Time.parse(row[&#39;Date&#39;]).year.to_i, Time.parse(row[&#39;Date&#39;]).month.to_i, Time.parse(row[&#39;Date&#39;]).day.to_i, 7, 23, Time.parse(row[&#39;Date&#39;]).day.to_i + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">          if records_to_be_upfate.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">            Parallel.each(records_to_be_upfate, in_threads: 4) do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">              ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">              #records_to_be_upfate.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">                output_today = (record.first_pass.to_i - row[&#39;PFirstPass&#39;].to_i) + (record.retest_pass.to_i - row[&#39;PRetestPass&#39;].to_i) + (record.test_waive.to_i - row[&#39;TestWF&#39;].to_i) + (record.design_waive.to_i - row[&#39;DesignWF&#39;].to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">                (record.cof_waive.to_i - row[&#39;COFWF&#39;].to_i) + (record.ntf.to_i - row[&#39;NTF&#39;].to_i) + (record.failure_waive.to_i - row[&#39;FailureWF&#39;].to_i) + (record.repaire_ok.to_i - row[&#39;RepairOK&#39;].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">                input_today = record.input.to_i - row[&#39;Input&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">                yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">                record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">          input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">          output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">          yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">          datetime = DateTime.parse(row[&#39;Date&#39;].to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">            base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">          elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">            base_record = Report.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">          if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">            output_today = (row[&#39;PFirstPass&#39;].to_i - base_record.first_pass.to_i) + (row[&#39;PRetestPass&#39;].to_i - base_record.retest_pass.to_i) + (row[&#39;TestWF&#39;].to_i - base_record.test_waive.to_i) + (row[&#39;DesignWF&#39;].to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">              (row[&#39;COFWF&#39;].to_i - base_record.cof_waive.to_i) + (row[&#39;NTF&#39;].to_i - base_record.ntf.to_i) + (row[&#39;FailureWF&#39;].to_i - base_record.failure_waive.to_i) + (row[&#39;RepairOK&#39;].to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">            input_today = row[&#39;Input&#39;].to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">            yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">            fp_yield_rate_today = input_today &gt; 0 ? ( ( (row[&#39;PFirstPass&#39;].to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">            input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">            output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">            yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        time_now = Time.now.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">        #record = &quot;(#{post.id}, #{yf_id}, #{sta_id}, &#39;#{row[&#39;Model&#39;].strip}&#39;, &#39;#{row[&#39;Stage&#39;].strip}&#39;, #{row[&#39;Seqno&#39;]}, &#39;#{row[&#39;Config&#39;]}&#39;, &#39;#{row[&#39;Station&#39;]}&#39;, #{row[&#39;Input&#39;]}, #{row[&#39;PFirstPass&#39;]}, #{row[&#39;PRetestPass&#39;]}, #{row[&#39;Fail&#39;]}, #{row[&#39;RetestProcess&#39;]}, #{row[&#39;TestWF&#39;]}, #{row[&#39;DesignWF&#39;]}, #{row[&#39;COFWF&#39;]}, #{row[&#39;RDArea&#39;]}, #{row[&#39;BPL&#39;]}, #{row[&#39;NTF&#39;]}, #{row[&#39;FailureWF&#39;]}, #{row[&#39;RepairOK&#39;]}, #{row[&#39;INLRepair&#39;]}, #{row[&#39;DIP&#39;]}, #{row[&#39;Defect&#39;]}, #{row[&#39;Fail_Borrow&#39;]}, #{row[&#39;Pass_Borrow&#39;]}, &#39;#{row[&#39;Type&#39;]}&#39;, #{yield_rate}, NULL, #{fp_yield_rate}, #{fp_yield_rate_today}, &#39;#{row[&#39;Date&#39;]}&#39;, #{Time.parse(row[&#39;Date&#39;]).year}, #{Time.parse(row[&#39;Date&#39;]).month}, #{Time.parse(row[&#39;Date&#39;]).day}, #{Time.parse(row[&#39;Date&#39;]).hour}, &#39;#{time_now}&#39;, &#39;#{time_now}&#39;)&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">        #records += records.length == 0 ? &quot;#{record}&quot; : &quot;, #{record}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        record = [post.id, yf_id, sta_id, row[&#39;Model&#39;].strip.to_s, row[&#39;Stage&#39;].strip.to_s, row[&#39;Seqno&#39;], row[&#39;Config&#39;].to_s, row[&#39;Station&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">          row[&#39;Input&#39;], row[&#39;PFirstPass&#39;], row[&#39;PRetestPass&#39;], row[&#39;Fail&#39;], row[&#39;RetestProcess&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">          row[&#39;TestWF&#39;], row[&#39;DesignWF&#39;], row[&#39;COFWF&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">          row[&#39;RDArea&#39;], row[&#39;BPL&#39;], row[&#39;NTF&#39;], row[&#39;FailureWF&#39;], row[&#39;RepairOK&#39;], row[&#39;INLRepair&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">          row[&#39;DIP&#39;], row[&#39;Defect&#39;], row[&#39;Fail_Borrow&#39;], row[&#39;Pass_Borrow&#39;], row[&#39;Type&#39;].to_s, yield_rate, yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">          fp_yield_rate, fp_yield_rate_today, row[&#39;Date&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">          Time.parse(row[&#39;Date&#39;]).year, Time.parse(row[&#39;Date&#39;]).month, Time.parse(row[&#39;Date&#39;]).day, Time.parse(row[&#39;Date&#39;]).hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          time_now, time_now, input_today, output_today]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">        records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      #values = records.map{ |record| &quot;(#{record.join(&quot;,&quot;)})&quot; }.join(&quot;,&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      #values = records.map{|record| &quot;(#{record.map! {|c| record.find_index(c)==3 || record.find_index(c)==4 ? c=&#39;\&#39;c\&#39;&#39; : c}.join(&#39;,&#39;)})&quot;}.join(&#39;,&#39;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      values = records.map{ |record| &quot;(#{record[0]}, #{record[1]}, #{record[2]}, &#39;#{record[3]}&#39;, &#39;#{record[4]}&#39;, #{record[5]}, &#39;#{record[6]}&#39;, &#39;#{record[7]}&#39;, #{record[8]}, #{record[9]}, #{record[10]}, #{record[11]}, #{record[12]}, #{record[13]}, #{record[14]}, #{record[15]}, #{record[16]}, #{record[17]}, #{record[18]}, #{record[19]}, #{record[20]}, #{record[21]}, #{record[22]}, #{record[23]}, #{record[24]}, #{record[25]}, &#39;#{record[26]}&#39;, #{record[27]}, #{record[28]}, #{record[29]}, #{record[30]}, &#39;#{record[31]}&#39;, #{record[32]}, #{record[33]}, #{record[34]}, #{record[35]}, &#39;#{record[36]}&#39;, &#39;#{record[37]}&#39;, &#39;#{record[38]}&#39;, &#39;#{record[39]}&#39;)&quot; }.join(&quot;,&quot;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      sql = &quot;INSERT INTO `#{self.table_name}` (`post_id`,`yield_file_id`,`station_id`,`model`,`stage`,`seqno`,`config`,`station_name`,`input`,`first_pass`,`retest_pass`,`fail`,`retest_process`,`test_waive`,`design_waive`,`cof_waive`,`rd_area`,`bpl`,`ntf`,`failure_waive`,`repaire_ok`,`inl_repaire`,`dip`,`defect`,`fail_borrow`,`pass_borrow`,`yield_type`,`yield_rate`,`yield_rate_today`,`fp_yield_rate`,`fp_yield_rate_today`,`published_at`,`p_year`,`p_month`,`p_mday`,`p_hour`,`created_at`,`updated_at`,`input_today`,`output_today`) VALUES #{values}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">      #ActiveRecord::Base.connection.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do |conn|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">        conn.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">    the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">    the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    post.update_attributes(current_year: the_year, current_month: the_month, current_mday: the_day, current_hour: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    # Delete last hour&#39;s records from database (For always only keep 2 groups of hourly records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    # the_post = Post.find_by_id(post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    # the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    # the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    # the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">    # the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    # if !the_post.current_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">    #   if !the_post.current_hour.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    #     if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    #       check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year, the_post.current_month, the_post.current_mday, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">    #       grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    #       if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    #         puts &quot;Deleting old timestamp records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    #         Report.where(stage: file_model_stage_name, p_year: the_post.current_year, p_month: the_post.current_month, p_mday: the_post.current_mday, p_hour: the_post.current_hour).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    #       end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    #     end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">    # # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">    # Post.find_by_id(post.id).update_attributes(current_year: the_year, current_month: the_month, current_mday: the_day, current_hour: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">  def self.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    the_year = the_post.current_year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    the_month = the_post.current_month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    the_day = the_post.current_mday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">    the_hour = the_post.current_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    if !the_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      datetime = DateTime.parse(the_year.to_s + sprintf(&#39;%02d&#39;, the_month).to_s + the_day.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">      if the_hour.to_i == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">        check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(1, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">        check_base_record = Report.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">          the_year, the_month, the_day, 0, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(6, 7)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">          yesterday_latest_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(8, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">          yesterday_latest_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">              file_model_stage_name, the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">            check_base_record = Report.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">      if !check_base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">        grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        if grup_hour.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">          puts &quot;Deleting overdue Sum-All and Sum-Config records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          check_base_record.destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">        puts &quot;No overdue records to be delete!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">  def self.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    the_year = latest_datetime[0..3]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">    the_month = latest_datetime[4..5]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">    the_day = latest_datetime[6..7]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    the_hour = latest_datetime[8..9]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">    if !the_post.current_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      if !the_post.current_hour.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">        if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">          check_base_record = Report.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year, the_post.current_month, the_post.current_mday, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">          grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">          if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">            puts &quot;Deleting overdue Sum-All and Sum-Config records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">            Report.where(stage: file_model_stage_name, p_year: the_post.current_year, p_month: the_post.current_month, p_mday: the_post.current_mday, p_hour: the_post.current_hour).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">    the_post.update_attributes(current_year: the_year, current_month: the_month, current_mday: the_day, current_hour: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">  def self.export_dummy_xml(target_stage, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="441">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="442">
          
          
          <code class="ruby">    puts &quot;Start generating dummy XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">    stage_name = target_stage.to_s[target_stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">    model_name = target_stage.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">    xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">    sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">    sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">    today_yield_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">    sum_config_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;C.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">    sum_config_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;CF.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + target_stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + latest_datetime.to_s + &quot;&lt;/pubDate&gt;\n&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    # Write dummy xml content to the files </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">    File.open(sum_all_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">    File.open(sum_all_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">    File.open(sum_config_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="472">
          
          
          <code class="ruby">    File.open(sum_config_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="473">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">    # Generate dummy XML folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">    FileUtils.mkdir_p station_xml_folder unless Dir.exist?(station_xml_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">    sum_config_dir = xml_root_dir + &quot;/&quot; +  model_name.to_s + &quot;C&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">    FileUtils.mkdir_p sum_config_dir unless Dir.exist?(sum_config_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">    config_xml_folder = xml_root_dir + &quot;/&quot; +  model_name.to_s + &quot;byConfig&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">    FileUtils.mkdir_p config_xml_folder unless Dir.exist?(config_xml_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">  def self.export_to_xml(target_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">    model_stage = Post.uniq.pluck(:title)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">    puts &quot;Start exporting Sum-All and Sum-Config XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">    start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">    GC.disable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">    model_stage.each do |s|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">      if s.eql? target_stage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">        stage_name = s.to_s[s.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">        model_name = s.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">        xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">        station_xml_folder = xml_root_dir + &quot;/&quot; + model_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">        # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">        FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">        # Generating station&#39;s XML files for Sum-All data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby">        sum_all_latest_record = Report.where(&quot;stage = ? AND config = ?&quot;, s, &#39;ALL&#39;).order(&quot;published_at DESC&quot;).limit(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">        sum_all_records = Report.where(&quot;stage = ? AND config = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="508">
          
          
          <code class="ruby">          s, &#39;ALL&#39;, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="509">
          
          
          <code class="ruby">        #sum_all_records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="510">
          
          
          <code class="ruby">        Parallel.each(sum_all_records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="512">
          
          
          <code class="ruby">            self.generate_station_xml(r)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="513">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="514">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">        sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="516">
          
          
          <code class="ruby">        sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="517">
          
          
          <code class="ruby">        today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="518">
          
          
          <code class="ruby">        fp_today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">        # Generate root XML file in specific stage folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">        self.generate_root_xml(sum_all_records, sum_all_root_xml_filename, sum_all_fp_root_xml_filename, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="521">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="522">
          
          
          <code class="ruby">        # Generating station&#39;s XML files for Sum-Config data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="523">
          
          
          <code class="ruby">        sum_config_latest_record = Report.where(&quot;stage = ? AND config != ?&quot;, s, &#39;ALL&#39;).order(&quot;published_at DESC&quot;).limit(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">        sum_config_records = Report.where(&quot;stage = ? AND config != ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">          s, &#39;ALL&#39;, sum_config_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">        # Generate station&#39;s XML file for Sum-Config records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">        #sum_config_records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">        Parallel.each(sum_config_records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="530">
          
          
          <code class="ruby">            self.generate_station_xml(r)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="532">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="533">
          
          
          <code class="ruby">        sum_config_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_config_latest_record.model.to_s + &quot;C.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="534">
          
          
          <code class="ruby">        sum_config_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_config_latest_record.model.to_s + &quot;CF.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="535">
          
          
          <code class="ruby">        # Generate root XML file in specific stage folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="536">
          
          
          <code class="ruby">        self.generate_config_root_xml(sum_config_records, sum_config_root_xml_filename, sum_config_fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">        # Insert station&#39;s configs data into station&#39;s XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">        sum_config_records_by_station = Report.where(&quot;stage = ? AND config != ? AND published_at = ? AND yield_rate IS NOT NULL&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="540">
          
          
          <code class="ruby">          s, &#39;ALL&#39;, sum_all_latest_record.published_at).select(&quot;distinct(station_name)&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">        Parallel.each(sum_config_records_by_station, in_threads: 4) do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="543">
          
          
          <code class="ruby">          #sum_config_records_by_station.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="544">
          
          
          <code class="ruby">            line_data = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">            xml_filename = record.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">            records = Report.where(&quot;stage = ? AND config != ? AND station_name = ? AND published_at = ? AND yield_rate IS NOT NULL&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">              s, &#39;ALL&#39;, record.station_name, sum_config_latest_record.published_at).order(&quot;yield_rate ASC, seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">            records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">              # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">              output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">              if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="552">
          
          
          <code class="ruby">                wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="554">
          
          
          <code class="ruby">                last_station = Report.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="555">
          
          
          <code class="ruby">                if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">                  wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="557">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">                  last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">                  wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">                  wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="562">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">              # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">              y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">              model_name = r.model.to_s + &#39;C&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">              line_data &lt;&lt; &quot;&lt;item&gt;\n&lt;title&gt;&quot; + r.config.to_s + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + r.config.to_s + &quot;.xml&lt;/link&gt;\n&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">            # Insert config data into station&#39;s XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="569">
          
          
          <code class="ruby">            source_xml_filename = station_xml_folder + &quot;/&quot; + xml_filename + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">            if File.exist?(source_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">              self.write_at(source_xml_filename, 4, line_data.join(&quot;&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">        # Generate XML files that separated out by config for yield_rate and fp_yield_rate to specific folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">        config_xml_folder = xml_root_dir + &quot;/&quot; + sum_config_latest_record.model.to_s + &quot;byConfig&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="577">
          
          
          <code class="ruby">        FileUtils.mkdir_p config_xml_folder unless Dir.exist?(config_xml_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="578">
          
          
          <code class="ruby">        sum_config_records_by_config = Report.where(&quot;stage = ? AND config != ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="579">
          
          
          <code class="ruby">          s, &#39;ALL&#39;, sum_config_latest_record.published_at).select(&quot;distinct(config)&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="580">
          
          
          <code class="ruby">        Parallel.each(sum_config_records_by_config, in_threads: 4) do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="581">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="582">
          
          
          <code class="ruby">          #sum_config_records_by_config.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">            xml_filename = record.config.to_s.gsub(/[^-\p{Alnum}]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">            records = Report.where(&quot;stage = ? AND config = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="585">
          
          
          <code class="ruby">              s, record.config, sum_config_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">            records_fp = records.where(&quot;fp_yield_rate IS NOT NULL&quot;).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">            config_xml_filename = config_xml_folder + &quot;/&quot; + xml_filename + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby">            config_today_xml_filename = config_xml_folder + &quot;/&quot; + xml_filename + &quot;_T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">            config_fp_xml_filename = config_xml_folder + &quot;/&quot; + xml_filename + &quot;_F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="591">
          
          
          <code class="ruby">            config_fp_today_xml_filename = config_xml_folder + &quot;/&quot; + xml_filename + &quot;_FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="592">
          
          
          <code class="ruby">            self.generate_config_xml(records, config_xml_filename, config_today_xml_filename, config_fp_xml_filename, config_fp_today_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="593">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="594">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="597">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="598">
          
          
          <code class="ruby">    puts &quot;Completed exporting XML files in #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="601">
          
          
          <code class="ruby">  def self.generate_station_xml(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">    xml_header = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;title&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot; Detail&quot; + &quot;&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="603">
          
          
          <code class="ruby">    xml_model = &quot;&lt;item&gt;&lt;title&gt;Model&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.model.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">    xml_stage = &quot;&lt;item&gt;&lt;title&gt;Stage&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.stage.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">    xml_config = &quot;&lt;item&gt;&lt;title&gt;Config&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.config.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">    xml_station = &quot;&lt;item&gt;&lt;title&gt;Station&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">    xml_input = &quot;&lt;item&gt;&lt;title&gt;Input&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.input.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">    xml_first_pass = &quot;&lt;item&gt;&lt;title&gt;FirstPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.first_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">    xml_retest_pass = &quot;&lt;item&gt;&lt;title&gt;RetestPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">    xml_fail = &quot;&lt;item&gt;&lt;title&gt;FailOnlineFail&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">    xml_retest_process = &quot;&lt;item&gt;&lt;title&gt;RetestProcess&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_process.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="612">
          
          
          <code class="ruby">    xml_test_waive = &quot;&lt;item&gt;&lt;title&gt;TestWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.test_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">    xml_design_waive = &quot;&lt;item&gt;&lt;title&gt;DesignWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.design_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby">    xml_cof_waive = &quot;&lt;item&gt;&lt;title&gt;COFWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.cof_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">    xml_rd_area = &quot;&lt;item&gt;&lt;title&gt;RDArea&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.rd_area.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="616">
          
          
          <code class="ruby">    xml_bpl = &quot;&lt;item&gt;&lt;title&gt;BoundtoPL&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.bpl.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby">    xml_ntf = &quot;&lt;item&gt;&lt;title&gt;NTF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.ntf.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">    xml_failure_waive = &quot;&lt;item&gt;&lt;title&gt;FailureWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.failure_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">    xml_repaire_ok = &quot;&lt;item&gt;&lt;title&gt;RepairOK&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.repaire_ok.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">    xml_inl_repaire = &quot;&lt;item&gt;&lt;title&gt;INLRepair&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.inl_repaire.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">    xml_dip = &quot;&lt;item&gt;&lt;title&gt;DIPScrap&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.dip.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="622">
          
          
          <code class="ruby">    xml_defect = &quot;&lt;item&gt;&lt;title&gt;Defect&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.defect.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="623">
          
          
          <code class="ruby">    xml_fail_borrow = &quot;&lt;item&gt;&lt;title&gt;Fail_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">    xml_pass_borrow = &quot;&lt;item&gt;&lt;title&gt;Pass_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.pass_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="625">
          
          
          <code class="ruby">    xml_yield_type = &quot;&lt;item&gt;&lt;title&gt;Type&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.yield_type.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">    xml_ctime = &quot;&lt;item&gt;&lt;title&gt;CTime&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby">    xml_footer = &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="629">
          
          
          <code class="ruby">    base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">    stage_name = record.stage.to_s[record.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="631">
          
          
          <code class="ruby">    if record.config.to_s.eql? &quot;ALL&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="632">
          
          
          <code class="ruby">      # Folder name for Sum-All files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="633">
          
          
          <code class="ruby">      xml_target_dir = base_dir + stage_name + &quot;/&quot; + record.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">      # Folder name for Sum-Config files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">      xml_target_dir = base_dir + stage_name + &quot;/&quot; + record.model.to_s + &quot;C&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="637">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">    # Create xml folder if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_target_dir unless Dir.exist?(xml_target_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">    # Define the xml file path (And removes all non-alphanumber characters from station_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">    if record.config.to_s.eql? &quot;ALL&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="642">
          
          
          <code class="ruby">      # XML file name for Sum-All files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="643">
          
          
          <code class="ruby">      local_filename = xml_target_dir + &quot;/&quot; + record.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="644">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">      # XML file name for Sum-Config files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="646">
          
          
          <code class="ruby">      local_filename = xml_target_dir + &quot;/&quot; + record.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + record.config.to_s + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="647">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="648">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">    File.open(local_filename, &#39;w&#39;) { |f| f.write(xml_header + xml_model + xml_stage + xml_config + xml_station + xml_input + xml_first_pass + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">      xml_retest_pass + xml_fail + xml_retest_process + xml_test_waive + xml_design_waive + xml_cof_waive + xml_rd_area + xml_bpl + xml_ntf + xml_failure_waive + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">      xml_repaire_ok + xml_inl_repaire + xml_dip + xml_defect + xml_fail_borrow + xml_pass_borrow + xml_yield_type + xml_ctime + xml_footer) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="653">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">  def self.generate_config_xml(records, config_xml_filename, config_today_xml_filename, fp_config_xml_filename, config_fp_today_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">    tmp2 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="658">
          
          
          <code class="ruby">    tmp3 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">    tmp4 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">    records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="661">
          
          
          <code class="ruby">      # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">      output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">      if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="664">
          
          
          <code class="ruby">        wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="666">
          
          
          <code class="ruby">        last_station = Report.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">        if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="670">
          
          
          <code class="ruby">          last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">          wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">          wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="673">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="674">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">      # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="676">
          
          
          <code class="ruby">      y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="677">
          
          
          <code class="ruby">      y_rate_t = r.yield_rate_today.nil? ? &#39;No Input&#39; : r.yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="678">
          
          
          <code class="ruby">      # Counting FirstPass yield rate, if fp_yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="679">
          
          
          <code class="ruby">      fp_yield_rate = r.fp_yield_rate.nil? ? &#39;No Input&#39; : r.fp_yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">      fp_yield_rate_t = r.fp_yield_rate_today.nil? ? &#39;No Input&#39; : r.fp_yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">      # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="682">
          
          
          <code class="ruby">      if r.config.to_s.eql? &quot;ALL&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="683">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="684">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="685">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="686">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="688">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + r.config.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">        model_name = r.model.to_s + &#39;C&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">      # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">      stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="693">
          
          
          <code class="ruby">      # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">      tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="695">
          
          
          <code class="ruby">      tmp2 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_t + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="696">
          
          
          <code class="ruby">      tmp3 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + fp_yield_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="697">
          
          
          <code class="ruby">      tmp4 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + fp_yield_rate_t + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="698">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="699">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">    tmp2 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="701">
          
          
          <code class="ruby">    tmp3 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">    tmp4 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="703">
          
          
          <code class="ruby">    # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="704">
          
          
          <code class="ruby">    File.open(config_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="705">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="706">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">    File.open(config_today_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">      f &lt;&lt; tmp2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="709">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="710">
          
          
          <code class="ruby">    File.open(fp_config_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="711">
          
          
          <code class="ruby">      f &lt;&lt; tmp3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="712">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="713">
          
          
          <code class="ruby">    File.open(config_fp_today_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="714">
          
          
          <code class="ruby">      f &lt;&lt; tmp4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="715">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="716">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="717">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="718">
          
          
          <code class="ruby">  def self.generate_root_xml(records, sum_config_root_xml_filename, sum_config_fp_root_xml_filename, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="719">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="720">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="721">
          
          
          <code class="ruby">    tmp2 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="722">
          
          
          <code class="ruby">    tmp3 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="723">
          
          
          <code class="ruby">    tmp4 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="724">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="725">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="726">
          
          
          <code class="ruby">        #records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="728">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="729">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="730">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="731">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="732">
          
          
          <code class="ruby">          last_station = Report.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="733">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="734">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="735">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="736">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="737">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="738">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="739">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="740">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="741">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="742">
          
          
          <code class="ruby">        y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="743">
          
          
          <code class="ruby">        y_rate_fp = r.fp_yield_rate.nil? ? &#39;No Input&#39; : r.fp_yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="744">
          
          
          <code class="ruby">        y_rate_t = r.yield_rate_today.nil? ? &#39;No Input&#39; : r.yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">        y_rate_t_fp = r.fp_yield_rate_today.nil? ? &#39;No Input&#39; : r.fp_yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="746">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="747">
          
          
          <code class="ruby">        if r.config.to_s.eql? &quot;ALL&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="748">
          
          
          <code class="ruby">          station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="749">
          
          
          <code class="ruby">          xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">          model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="751">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="752">
          
          
          <code class="ruby">          station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &#39;:&#39; + r.config.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="753">
          
          
          <code class="ruby">          xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + r.config.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="754">
          
          
          <code class="ruby">          model_name = r.model.to_s + &#39;C&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="755">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="756">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="757">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="758">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="760">
          
          
          <code class="ruby">        tmp2 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + r.fp_yield_rate.to_s + &quot;%&quot; + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="761">
          
          
          <code class="ruby">        tmp3 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input_today.to_s + &quot; Output:&quot; + r.output_today.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_t + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="762">
          
          
          <code class="ruby">        tmp4 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input_today.to_s + &quot; Output:&quot; + r.output_today.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_t_fp + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="763">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="765">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">    tmp2 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">    tmp3 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="768">
          
          
          <code class="ruby">    tmp4 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="770">
          
          
          <code class="ruby">    File.open(sum_config_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="771">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="772">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="773">
          
          
          <code class="ruby">    File.open(sum_config_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="774">
          
          
          <code class="ruby">      f &lt;&lt; tmp2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="775">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="777">
          
          
          <code class="ruby">      f &lt;&lt; tmp3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="779">
          
          
          <code class="ruby">    File.open(fp_today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="780">
          
          
          <code class="ruby">      f &lt;&lt; tmp4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="783">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="784">
          
          
          <code class="ruby">  def self.generate_config_root_xml(records, sum_config_root_xml_filename, sum_config_fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="785">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="786">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="787">
          
          
          <code class="ruby">    tmp2 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">        #records.each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="792">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="793">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="795">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="796">
          
          
          <code class="ruby">          last_station = Report.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="797">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="798">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="799">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="800">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="801">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="802">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="803">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="804">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="805">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="806">
          
          
          <code class="ruby">        y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="807">
          
          
          <code class="ruby">        y_rate_fp = r.fp_yield_rate.nil? ? &#39;No Input&#39; : r.fp_yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="808">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="809">
          
          
          <code class="ruby">        if r.config.to_s.eql? &quot;ALL&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="810">
          
          
          <code class="ruby">          station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="811">
          
          
          <code class="ruby">          xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="812">
          
          
          <code class="ruby">          model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="813">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="814">
          
          
          <code class="ruby">          station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &#39;:&#39; + r.config.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="815">
          
          
          <code class="ruby">          xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + r.config.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="816">
          
          
          <code class="ruby">          model_name = r.model.to_s + &#39;C&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="817">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="818">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="819">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="820">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="821">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="822">
          
          
          <code class="ruby">        tmp2 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_fp + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="823">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="824">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="825">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="826">
          
          
          <code class="ruby">    tmp2 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="827">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="828">
          
          
          <code class="ruby">    File.open(sum_config_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="829">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="830">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="831">
          
          
          <code class="ruby">    File.open(sum_config_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="832">
          
          
          <code class="ruby">      f &lt;&lt; tmp2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="833">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="834">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="835">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="d0a1a867f88d54143d9c9ac746bb2566d8d51d70">
  <div class="header">
    <h3>app/models/report_main.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>675</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>675</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &quot;activerecord-import/base&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">ActiveRecord::Import.require_adapter(&#39;mysql2&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class ReportMain &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  attr_accessible :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  belongs_to :yield_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  belongs_to :station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  validates :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, presence: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  # Set yield report records per page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  paginates_per 20</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  before_validation do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    if published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      self.p_year = published_at.year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      self.p_month = published_at.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      self.p_mday = published_at.mday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      self.p_hour = published_at.hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  # Caculate yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  # If timestamp of hour is 6am, Get year, month, day, post_id and station_name of the base record, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  # and update each record&#39;s daily yield that belong to the same day with base record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  before_create do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if self.p_hour.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      records = ReportMain.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        self.post_id, self.station_name, self.config, self.p_year, self.p_month, self.p_mday, 7, 23, self.p_mday + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if records.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          output_today = (record.first_pass.to_i - self.first_pass.to_i) + (record.retest_pass.to_i - self.retest_pass.to_i) + (record.test_waive.to_i - self.test_waive.to_i) + (record.design_waive.to_i - self.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          (record.cof_waive.to_i - self.cof_waive.to_i) + (record.ntf.to_i - self.ntf.to_i) + (record.failure_waive.to_i - self.failure_waive.to_i) + (record.repaire_ok.to_i - self.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          input_today = record.input.to_i - self.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            yield_rate_today = yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      # Get first record with same day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        # base_record = Report.where(post_id: post, station_name: self.station_name, config: self.config, p_year: datetime.year, p_month: datetime.month, p_mday: datetime.day, p_hour: 6).limit(1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 7).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        #   base_record_without_station = ReportMain.where(&quot;post_id = ? AND station_name = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        #     record = ReportMain.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.year, p_month: datetime.month, p_mday: datetime.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        #   ReportMain.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        # base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        # base_record = Report.where(post_id: post, station_name: self.station_name, config: self.config, p_year: datetime.yesterday.year, p_month: datetime.yesterday.month, p_mday: datetime.yesterday.day, p_hour: 6).limit(1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        #   base_record_without_station = ReportMain.where(&quot;post_id = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        #     record = ReportMain.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.yesterday.year, p_month: datetime.yesterday.month, p_mday: datetime.yesterday.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        #   ReportMain.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        # base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        output_today = (self.first_pass.to_i - base_record.first_pass.to_i) + (self.retest_pass.to_i - base_record.retest_pass.to_i) + (self.test_waive.to_i - base_record.test_waive.to_i) + (self.design_waive.to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          (self.cof_waive.to_i - base_record.cof_waive.to_i) + (self.ntf.to_i - base_record.ntf.to_i) + (self.failure_waive.to_i - base_record.failure_waive.to_i) + (self.repaire_ok.to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        input_today = self.input.to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          self.yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          self.yield_rate_today = yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          self.fp_yield_rate_today = ( (self.first_pass.to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          self.fp_yield_rate_today = self.fp_yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">          self.yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">          self.fp_yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        # If base_record not found, set current record as base_record!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        self.yield_rate_today = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">  SORT_NAMES = %w(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    published_at model stage seqno station_name yield_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">  )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  def self.sort_names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    SORT_NAMES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">  def base_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      return ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6, self.p_hour-1).first.equal? nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      look_from_yesterday = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, 23).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      look_from_today = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 0, self.p_hour-1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      return look_from_yesterday.nil? &amp;&amp; look_from_today.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    else # datetime.hour is 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">  def self.group_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    reports = where(&quot;yield_rate IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate) as worst_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">  def self.group_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    reports = where(&quot;yield_rate_today IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate_today) as worst_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">  def self.group_fp_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    reports = where(&quot;fp_yield_rate IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate) as worst_fp_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">  def self.group_fp_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    reports = where(&quot;fp_yield_rate_today IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate_today) as worst_fp_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">  # The &#39;import&#39; function can be used both on web and rake script</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">  def self.import_data(file, filename, post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    # Check filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    if csvfile = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      yf_id = csvfile.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      line_count = CSV.open(file, &quot;r&quot;).readlines.count - 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      # Set published_at from file name, and create the file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      yield_file = YieldFile.create(post_id: post.id, file_name: filename, total_row: line_count, published_at: file_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      yf_id = yield_file.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    # Define the folder path of XML files, and then delete all files before importing new csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    file_model_stage_name = filename[filename.index(&#39;20&#39;)+12..filename.index(&#39;.csv&#39;)-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    file_stage_name = file_model_stage_name[file_model_stage_name.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    file_model_name = file_model_stage_name.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    # if filename.include? &quot;Sum-Config&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    #   # All XML files in JHxC folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    #   files_to_clear = base_dir + file_stage_name.to_s + &quot;/&quot; + file_model_name.to_s + &quot;C/*&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    # else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    #   # All XML files in JHx folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    #   files_to_clear = base_dir + file_stage_name.to_s + &quot;/&quot; + file_model_name.to_s+ &quot;/*&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    # FileUtils.rm_rf Dir.glob(files_to_clear)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">    ReportMain.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">        :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      CSV.foreach(file, {encoding: &quot;UTF-8&quot;, quote_char: &#39;&quot;&#39;, col_sep: &#39;,&#39;, row_sep: :auto, headers: true}) do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        # Create station model and set station_id to Report obj</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        if station = Station.find_by_name_and_post_id(row[&#39;Station&#39;], post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">          station = Station.create(post_id: post.id, yield_file_id: yf_id, name: row[&#39;Station&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">        # Caculate accumulative yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">        if !row[&#39;Input&#39;].to_i.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">          total = row[&#39;PFirstPass&#39;].to_i + row[&#39;PRetestPass&#39;].to_i + row[&#39;TestWF&#39;].to_i + row[&#39;DesignWF&#39;].to_i + row[&#39;COFWF&#39;].to_i + row[&#39;NTF&#39;].to_i + row[&#39;FailureWF&#39;].to_i + row[&#39;RepairOK&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">          yield_rate = ( (total.to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">          fp_yield_rate = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">          fp_yield_rate_today = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">          yield_rate = 99999 # Input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">          fp_yield_rate = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">          fp_yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        if Time.parse(row[&#39;Date&#39;]).hour.to_i.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">          records_to_be_update = ReportMain.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">            ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">            post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, Time.parse(row[&#39;Date&#39;]).year.to_i, Time.parse(row[&#39;Date&#39;]).month.to_i, Time.parse(row[&#39;Date&#39;]).day.to_i, 7, 23, Time.parse(row[&#39;Date&#39;]).day.to_i + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">          if records_to_be_update.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">            Parallel.each(records_to_be_update, in_threads: 4) do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">              ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">                output_today = (record.first_pass.to_i - row[&#39;PFirstPass&#39;].to_i) + (record.retest_pass.to_i - row[&#39;PRetestPass&#39;].to_i) + (record.test_waive.to_i - row[&#39;TestWF&#39;].to_i) + (record.design_waive.to_i - row[&#39;DesignWF&#39;].to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">                (record.cof_waive.to_i - row[&#39;COFWF&#39;].to_i) + (record.ntf.to_i - row[&#39;NTF&#39;].to_i) + (record.failure_waive.to_i - row[&#39;FailureWF&#39;].to_i) + (record.repaire_ok.to_i - row[&#39;RepairOK&#39;].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">                input_today = record.input.to_i - row[&#39;Input&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">                yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">                record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">          input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">          output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">          yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">          datetime = DateTime.parse(row[&#39;Date&#39;].to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">          if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">            base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">          elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">            base_record = ReportMain.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">          if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">            output_today = (row[&#39;PFirstPass&#39;].to_i - base_record.first_pass.to_i) + (row[&#39;PRetestPass&#39;].to_i - base_record.retest_pass.to_i) + (row[&#39;TestWF&#39;].to_i - base_record.test_waive.to_i) + (row[&#39;DesignWF&#39;].to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">              (row[&#39;COFWF&#39;].to_i - base_record.cof_waive.to_i) + (row[&#39;NTF&#39;].to_i - base_record.ntf.to_i) + (row[&#39;FailureWF&#39;].to_i - base_record.failure_waive.to_i) + (row[&#39;RepairOK&#39;].to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">            input_today = row[&#39;Input&#39;].to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">            yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">            fp_yield_rate_today = input_today &gt; 0 ? ( ( (row[&#39;PFirstPass&#39;].to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">            output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">            yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        time_now = Time.now.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        #record = &quot;(#{post.id}, #{yf_id}, #{sta_id}, &#39;#{row[&#39;Model&#39;].strip}&#39;, &#39;#{row[&#39;Stage&#39;].strip}&#39;, #{row[&#39;Seqno&#39;]}, &#39;#{row[&#39;Config&#39;]}&#39;, &#39;#{row[&#39;Station&#39;]}&#39;, #{row[&#39;Input&#39;]}, #{row[&#39;PFirstPass&#39;]}, #{row[&#39;PRetestPass&#39;]}, #{row[&#39;Fail&#39;]}, #{row[&#39;RetestProcess&#39;]}, #{row[&#39;TestWF&#39;]}, #{row[&#39;DesignWF&#39;]}, #{row[&#39;COFWF&#39;]}, #{row[&#39;RDArea&#39;]}, #{row[&#39;BPL&#39;]}, #{row[&#39;NTF&#39;]}, #{row[&#39;FailureWF&#39;]}, #{row[&#39;RepairOK&#39;]}, #{row[&#39;INLRepair&#39;]}, #{row[&#39;DIP&#39;]}, #{row[&#39;Defect&#39;]}, #{row[&#39;Fail_Borrow&#39;]}, #{row[&#39;Pass_Borrow&#39;]}, &#39;#{row[&#39;Type&#39;]}&#39;, #{yield_rate}, NULL, #{fp_yield_rate}, #{fp_yield_rate_today}, &#39;#{row[&#39;Date&#39;]}&#39;, #{Time.parse(row[&#39;Date&#39;]).year}, #{Time.parse(row[&#39;Date&#39;]).month}, #{Time.parse(row[&#39;Date&#39;]).day}, #{Time.parse(row[&#39;Date&#39;]).hour}, &#39;#{time_now}&#39;, &#39;#{time_now}&#39;)&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">        #records += records.length == 0 ? &quot;#{record}&quot; : &quot;, #{record}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">        record = [post.id, yf_id, sta_id, row[&#39;Model&#39;].strip.to_s, row[&#39;Stage&#39;].strip.to_s, row[&#39;Seqno&#39;], row[&#39;Config&#39;].to_s, row[&#39;Station&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">          row[&#39;Input&#39;], row[&#39;PFirstPass&#39;], row[&#39;PRetestPass&#39;], row[&#39;Fail&#39;], row[&#39;RetestProcess&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">          row[&#39;TestWF&#39;], row[&#39;DesignWF&#39;], row[&#39;COFWF&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">          row[&#39;RDArea&#39;], row[&#39;BPL&#39;], row[&#39;NTF&#39;], row[&#39;FailureWF&#39;], row[&#39;RepairOK&#39;], row[&#39;INLRepair&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">          row[&#39;DIP&#39;], row[&#39;Defect&#39;], row[&#39;Fail_Borrow&#39;], row[&#39;Pass_Borrow&#39;], row[&#39;Type&#39;].to_s, yield_rate, yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">          fp_yield_rate, fp_yield_rate_today, row[&#39;Date&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">          Time.parse(row[&#39;Date&#39;]).year, Time.parse(row[&#39;Date&#39;]).month, Time.parse(row[&#39;Date&#39;]).day, Time.parse(row[&#39;Date&#39;]).hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">          time_now, time_now, input_today, output_today]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">        records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      #values = records.map{ |record| &quot;(#{record.join(&quot;,&quot;)})&quot; }.join(&quot;,&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      #values = records.map{|record| &quot;(#{record.map! {|c| record.find_index(c)==3 || record.find_index(c)==4 ? c=&#39;\&#39;c\&#39;&#39; : c}.join(&#39;,&#39;)})&quot;}.join(&#39;,&#39;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      values = records.map{ |record| &quot;(#{record[0]}, #{record[1]}, #{record[2]}, &#39;#{record[3]}&#39;, &#39;#{record[4]}&#39;, #{record[5]}, &#39;#{record[6]}&#39;, &#39;#{record[7]}&#39;, #{record[8]}, #{record[9]}, #{record[10]}, #{record[11]}, #{record[12]}, #{record[13]}, #{record[14]}, #{record[15]}, #{record[16]}, #{record[17]}, #{record[18]}, #{record[19]}, #{record[20]}, #{record[21]}, #{record[22]}, #{record[23]}, #{record[24]}, #{record[25]}, &#39;#{record[26]}&#39;, #{record[27]}, #{record[28]}, #{record[29]}, #{record[30]}, &#39;#{record[31]}&#39;, #{record[32]}, #{record[33]}, #{record[34]}, #{record[35]}, &#39;#{record[36]}&#39;, &#39;#{record[37]}&#39;, &#39;#{record[38]}&#39;, &#39;#{record[39]}&#39;)&quot; }.join(&quot;,&quot;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      sql = &quot;INSERT INTO `#{self.table_name}` (`post_id`,`yield_file_id`,`station_id`,`model`,`stage`,`seqno`,`config`,`station_name`,`input`,`first_pass`,`retest_pass`,`fail`,`retest_process`,`test_waive`,`design_waive`,`cof_waive`,`rd_area`,`bpl`,`ntf`,`failure_waive`,`repaire_ok`,`inl_repaire`,`dip`,`defect`,`fail_borrow`,`pass_borrow`,`yield_type`,`yield_rate`,`yield_rate_today`,`fp_yield_rate`,`fp_yield_rate_today`,`published_at`,`p_year`,`p_month`,`p_mday`,`p_hour`,`created_at`,`updated_at`,`input_today`,`output_today`) VALUES #{values}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      #ActiveRecord::Base.connection.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do |conn|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">        conn.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">    the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">    the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">    post.update_attributes(current_year_main: the_year, current_month_main: the_month, current_mday_main: the_day, current_hour_main: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">    # # Delete last hour&#39;s records from database (For always only keep 2 groups of hourly records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    # the_post = Post.find_by_id(post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    # the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    # the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">    # the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">    # the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    # if !the_post.current_hour_main.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    #   if !the_post.current_hour_main.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    #     if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour_main.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">    #       check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year_main, the_post.current_month_main, the_post.current_mday_main, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">    #       grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    #       if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">    #         puts &quot;Deleting old timestamp MAIN records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    #         ReportMain.where(stage: file_model_stage_name, p_year: the_post.current_year_main, p_month: the_post.current_month_main, p_mday: the_post.current_mday_main, p_hour: the_post.current_hour_main).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    #       end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    #     end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">    # # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    # Post.find_by_id(post.id).update_attributes(current_year_main: the_year, current_month_main: the_month, current_mday_main: the_day, current_hour_main: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">  def self.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    the_year = the_post.current_year_main</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    the_month = the_post.current_month_main</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    the_day = the_post.current_mday_main</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    the_hour = the_post.current_hour_main</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    if !the_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">      datetime = DateTime.parse(the_year.to_s + sprintf(&#39;%02d&#39;, the_month).to_s + the_day.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">      if the_hour.to_i == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">        check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(1, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">        check_base_record = ReportMain.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">          the_year, the_month, the_day, 0, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(6, 7)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">          yesterday_latest_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(8, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">          yesterday_latest_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">              file_model_stage_name, the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">            check_base_record = ReportMain.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      if !check_base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">        grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">        if grup_hour.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">          puts &quot;Deleting overdue Sum-Main records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">          check_base_record.destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">        puts &quot;No overdue records to be delete!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">  def self.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">    the_year = latest_datetime[0..3]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    the_month = latest_datetime[4..5]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">    the_day = latest_datetime[6..7]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">    the_hour = latest_datetime[8..9]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    if !the_post.current_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">      if !the_post.current_hour.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">        if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">          check_base_record = ReportMain.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year_main, the_post.current_month_main, the_post.current_mday_main, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">          grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">          if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">            puts &quot;Deleting overdue Sum-All and Sum-Config records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">            ReportMain.where(stage: file_model_stage_name, p_year: the_post.current_year_main, p_month: the_post.current_month_main, p_mday: the_post.current_mday_main, p_hour: the_post.current_hour_main).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">    the_post.update_attributes(current_year_main: the_year, current_month_main: the_month, current_mday_main: the_day, current_hour_main: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">  def self.export_dummy_xml(target_stage, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">    puts &quot;Start generating dummy (Main) XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    stage_name = target_stage.to_s[target_stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    model_name = target_stage.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">    xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">    # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">    today_yield_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="441">
          
          
          <code class="ruby">    fp_today_yield_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + target_stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + latest_datetime.to_s + &quot;&lt;/pubDate&gt;\n&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">    # Write dummy xml content to the files </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">    File.open(sum_all_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    File.open(sum_all_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">    File.open(fp_today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    # Generate dummy XML folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;Main&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">    FileUtils.mkdir_p station_xml_folder unless Dir.exist?(station_xml_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">  def self.export_to_xml(target_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">    model_stage = Post.uniq.pluck(:title)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">    puts &quot;Start to exporting Main-build XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">    start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">    model_stage.each do |s|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="472">
          
          
          <code class="ruby">      if s.eql? target_stage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="473">
          
          
          <code class="ruby">        stage_name = s.to_s[s.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">        model_name = s.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">        xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">        station_xml_folder = xml_root_dir + &quot;/&quot; + model_name + &quot;Main&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby">        # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">        FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">        # Generating station&#39;s XML files for Sum-All data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">        sum_all_latest_record = ReportMain.where(&quot;stage = ?&quot;, s).order(&quot;published_at DESC&quot;).limit(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">        sum_all_records = ReportMain.where(&quot;stage = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">        sum_all_records_fp = ReportMain.where(&quot;stage = ? AND published_at = ? AND fp_yield_rate IS NOT NULL&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">        today_yield_records = ReportMain.where(&quot;stage = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">        # Generate station&#39;s XML file for Sum-All records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">        Parallel.each(sum_all_records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">            self.generate_station_xml(r)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">        sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">        sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">        today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">        fp_today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Main_FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">        # Generate root XML file in specific stage folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">        self.generate_root_xml(sum_all_records, sum_all_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">        self.generate_fp_root_xml(sum_all_records, sum_all_records_fp, sum_all_fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">        self.generate_today_yield_root_xml(today_yield_records, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">        #self.generate_fp_today_yield_root_xml(today_yield_records, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby">    puts &quot;Completed exporting (Main) XML files in #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="508">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="509">
          
          
          <code class="ruby">  def self.generate_station_xml(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="510">
          
          
          <code class="ruby">    xml_header = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;title&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot; Detail&quot; + &quot;&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    xml_model = &quot;&lt;item&gt;&lt;title&gt;Model&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.model.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="512">
          
          
          <code class="ruby">    xml_stage = &quot;&lt;item&gt;&lt;title&gt;Stage&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.stage.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="513">
          
          
          <code class="ruby">    xml_config = &quot;&lt;item&gt;&lt;title&gt;Config&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.config.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="514">
          
          
          <code class="ruby">    xml_station = &quot;&lt;item&gt;&lt;title&gt;Station&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    xml_input = &quot;&lt;item&gt;&lt;title&gt;Input&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.input.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="516">
          
          
          <code class="ruby">    xml_first_pass = &quot;&lt;item&gt;&lt;title&gt;FirstPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.first_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="517">
          
          
          <code class="ruby">    xml_retest_pass = &quot;&lt;item&gt;&lt;title&gt;RetestPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="518">
          
          
          <code class="ruby">    xml_fail = &quot;&lt;item&gt;&lt;title&gt;FailOnlineFail&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">    xml_retest_process = &quot;&lt;item&gt;&lt;title&gt;RetestProcess&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_process.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">    xml_test_waive = &quot;&lt;item&gt;&lt;title&gt;TestWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.test_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="521">
          
          
          <code class="ruby">    xml_design_waive = &quot;&lt;item&gt;&lt;title&gt;DesignWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.design_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="522">
          
          
          <code class="ruby">    xml_cof_waive = &quot;&lt;item&gt;&lt;title&gt;COFWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.cof_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="523">
          
          
          <code class="ruby">    xml_rd_area = &quot;&lt;item&gt;&lt;title&gt;RDArea&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.rd_area.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">    xml_bpl = &quot;&lt;item&gt;&lt;title&gt;BoundtoPL&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.bpl.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">    xml_ntf = &quot;&lt;item&gt;&lt;title&gt;NTF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.ntf.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">    xml_failure_waive = &quot;&lt;item&gt;&lt;title&gt;FailureWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.failure_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">    xml_repaire_ok = &quot;&lt;item&gt;&lt;title&gt;RepairOK&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.repaire_ok.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">    xml_inl_repaire = &quot;&lt;item&gt;&lt;title&gt;INLRepair&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.inl_repaire.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">    xml_dip = &quot;&lt;item&gt;&lt;title&gt;DIPScrap&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.dip.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="530">
          
          
          <code class="ruby">    xml_defect = &quot;&lt;item&gt;&lt;title&gt;Defect&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.defect.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">    xml_fail_borrow = &quot;&lt;item&gt;&lt;title&gt;Fail_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="532">
          
          
          <code class="ruby">    xml_pass_borrow = &quot;&lt;item&gt;&lt;title&gt;Pass_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.pass_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="533">
          
          
          <code class="ruby">    xml_yield_type = &quot;&lt;item&gt;&lt;title&gt;Type&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.yield_type.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="534">
          
          
          <code class="ruby">    xml_ctime = &quot;&lt;item&gt;&lt;title&gt;CTime&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="535">
          
          
          <code class="ruby">    xml_footer = &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="536">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">    stage_name = record.stage.to_s[record.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">    xml_target_dir = base_dir + stage_name + &quot;/&quot; + record.model.to_s + &quot;Main&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="540">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    # Create xml folder if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_target_dir unless Dir.exist?(xml_target_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="543">
          
          
          <code class="ruby">    # Define the xml file path (And removes all non-alphanumber characters from station_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="544">
          
          
          <code class="ruby">    local_filename = xml_target_dir + &quot;/&quot; + record.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    File.open(local_filename, &#39;w&#39;) { |f| f.write(xml_header + xml_model + xml_stage + xml_config + xml_station + xml_input + xml_first_pass + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">      xml_retest_pass + xml_fail + xml_retest_process + xml_test_waive + xml_design_waive + xml_cof_waive + xml_rd_area + xml_bpl + xml_ntf + xml_failure_waive + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">      xml_repaire_ok + xml_inl_repaire + xml_dip + xml_defect + xml_fail_borrow + xml_pass_borrow + xml_yield_type + xml_ctime + xml_footer) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">  def self.generate_root_xml(records, root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="552">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="554">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="555">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="557">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">          last_station = ReportMain.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="562">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="569">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">        y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="577">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="578">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="579">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="580">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Main/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="581">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="582">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="585">
          
          
          <code class="ruby">    File.open(root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">  def self.generate_fp_root_xml(records, records_fp, fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="591">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="592">
          
          
          <code class="ruby">    # XML file path for showing FirstPass yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="593">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="594">
          
          
          <code class="ruby">    Parallel.each(records_fp, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="597">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="598">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="601">
          
          
          <code class="ruby">          last_station = ReportMain.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="603">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">        # Counting FirstPass yield rate, if fp_yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">        fp_yield_rate = r.fp_yield_rate.nil? ? &#39;No Input&#39; : r.fp_yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="612">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="616">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + fp_yield_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Main/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="622">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="623">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="625">
          
          
          <code class="ruby">    File.open(fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="629">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">  def self.generate_today_yield_root_xml(records, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="631">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="632">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="633">
          
          
          <code class="ruby">    tmp2 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="637">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">          last_station = ReportMain.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="642">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="643">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="644">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="646">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="647">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="648">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">        y_rate = r.yield_rate_today.nil? ? &#39;No Input&#39; : r.yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby">        y_rate_fp = r.fp_yield_rate_today.nil? ? &#39;No Input&#39; : r.fp_yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="653">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="658">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="661">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Main/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">        tmp2 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_fp + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Main/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="664">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="666">
          
          
          <code class="ruby">    tmp2 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="670">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">    File.open(fp_today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">      f &lt;&lt; tmp2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="673">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="674">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="37de5ee36a45db602a4fc80a13718d194d432001">
  <div class="header">
    <h3>app/models/report_mini.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>673</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>673</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &quot;activerecord-import/base&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">ActiveRecord::Import.require_adapter(&#39;mysql2&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">class ReportMini &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  attr_accessible :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  belongs_to :yield_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  belongs_to :station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  validates :post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    :fail_borrow, :pass_borrow, :yield_type, :published_at, :p_year, :p_month, :p_mday, :p_hour, presence: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  # Set yield report records per page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  paginates_per 20</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  before_validation do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    if published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      self.p_year = published_at.year</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      self.p_month = published_at.month</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      self.p_mday = published_at.mday</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      self.p_hour = published_at.hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">  # Caculate yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">  # If timestamp of hour is 6am, Get year, month, day, post_id and station_name of the base record, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">  # and update each record&#39;s daily yield that belong to the same day with base record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">  before_create do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if self.p_hour.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      records = ReportMini.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        self.post_id, self.station_name, self.config, self.p_year, self.p_month, self.p_mday, 7, 23, self.p_mday + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      if records.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          output_today = (record.first_pass.to_i - self.first_pass.to_i) + (record.retest_pass.to_i - self.retest_pass.to_i) + (record.test_waive.to_i - self.test_waive.to_i) + (record.design_waive.to_i - self.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">          (record.cof_waive.to_i - self.cof_waive.to_i) + (record.ntf.to_i - self.ntf.to_i) + (record.failure_waive.to_i - self.failure_waive.to_i) + (record.repaire_ok.to_i - self.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          input_today = record.input.to_i - self.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">            yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            yield_rate_today = yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">            yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      # Get first record with same day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 7).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        #   base_record_without_station = ReportMini.where(&quot;post_id = ? AND station_name = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        #     record = ReportMini.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.year, p_month: datetime.month, p_mday: datetime.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        #   ReportMini.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        # base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        # # If base_record hour have no station, create record data from current hour for the station at base_record hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        # if base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        #   base_record_without_station = ReportMini.where(&quot;post_id = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        #   records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        #   columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        #   begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        #     # Create report items from CSV rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        #     record = ReportMini.new(post_id: self.post_id, yield_file_id: base_record_without_station.yield_file_id, station_id: self.station_id, model: self.model.strip, stage: self.stage.strip, seqno: self.seqno, config: self.config, station_name: self.station_name, input: self.input, first_pass: self.first_pass, retest_pass: self.retest_pass, fail: self.fail, retest_process: self.retest_process, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        #       test_waive: self.test_waive, design_waive: self.design_waive, cof_waive: self.cof_waive, rd_area: self.rd_area, bpl: self.bpl, ntf: self.ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        #       failure_waive: self.failure_waive, repaire_ok: self.repaire_ok, inl_repaire: self.inl_repaire, dip: self.dip, defect: self.defect, fail_borrow: self.fail_borrow, pass_borrow: self.pass_borrow, yield_type: self.yield_type, yield_rate: self.yield_rate, yield_rate_today: self.yield_rate_today, fp_yield_rate: self.fp_yield_rate, fp_yield_rate_today: self.fp_yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        #       published_at: base_record_without_station.published_at, p_year: datetime.yesterday.year, p_month: datetime.yesterday.month, p_mday: datetime.yesterday.day, p_hour: base_record_without_station.p_hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        #     )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        #     records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        #   rescue ActiveRecord::RecordInvalid =&gt; invalid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        #     puts invalid.record.errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        #   records.each do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        #     record.run_callbacks(:create) { false }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        #   ReportMini.import columns, records, validate: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        # # Then check base_record again</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        # base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        output_today = (self.first_pass.to_i - base_record.first_pass.to_i) + (self.retest_pass.to_i - base_record.retest_pass.to_i) + (self.test_waive.to_i - base_record.test_waive.to_i) + (self.design_waive.to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          (self.cof_waive.to_i - base_record.cof_waive.to_i) + (self.ntf.to_i - base_record.ntf.to_i) + (self.failure_waive.to_i - base_record.failure_waive.to_i) + (self.repaire_ok.to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        input_today = self.input.to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        if !input_today.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          self.yield_rate_today = (output_today.to_f / input_today.to_f) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">          self.yield_rate_today = yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          self.fp_yield_rate_today = ( (self.first_pass.to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          self.fp_yield_rate_today = self.fp_yield_rate_today.round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          self.yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">          self.fp_yield_rate_today = nil # Subtracted input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        # If base_record not found, set current record as base_record!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        self.yield_rate_today = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">  SORT_NAMES = %w(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    published_at model stage seqno station_name yield_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">  )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">  def self.sort_names</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    SORT_NAMES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">  def base_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    datetime = DateTime.parse(self.published_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      return ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.year, datetime.month, datetime.day, 6, self.p_hour-1).first.equal? nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">    elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      look_from_yesterday = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6, 23).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      look_from_today = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, self.post_id, self.station_name, self.config, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 0, self.p_hour-1).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      return look_from_yesterday.nil? &amp;&amp; look_from_today.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    else # datetime.hour is 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">  def self.group_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    reports = where(&quot;yield_rate IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate) as worst_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">  def self.group_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    reports = where(&quot;yield_rate_today IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(yield_rate_today) as worst_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">  def self.group_fp_accu_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">    reports = where(&quot;fp_yield_rate IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate) as worst_fp_accu_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_accu_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">  def self.group_fp_daily_yield_by_date(date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    reports = where(&quot;fp_yield_rate_today IS NOT NULL AND published_at = ?&quot;, date_time)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    reports = reports.group(&quot;station_name&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    reports = reports.select(&quot;station_name, min(fp_yield_rate_today) as worst_fp_daily_yield&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    reports = reports.order(&quot;worst_fp_daily_yield ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">  # The &#39;import&#39; function can be used both on web and rake script</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">  def self.import_data(file, filename, post)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    # Check filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    if csvfile = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      yf_id = csvfile.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      line_count = CSV.open(file, &quot;r&quot;).readlines.count - 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      # Set published_at from file name, and create the file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      yield_file = YieldFile.create(post_id: post.id, file_name: filename, total_row: line_count, published_at: file_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      yf_id = yield_file.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    # Define the folder path of XML files, and then delete all files before importing new csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    file_model_stage_name = filename[filename.index(&#39;20&#39;)+12..filename.index(&#39;.csv&#39;)-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    file_stage_name = file_model_stage_name[file_model_stage_name.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    file_model_name = file_model_stage_name.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    # if filename.include? &quot;Sum-Config&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    #   # All XML files in JHxC folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    #   files_to_clear = base_dir + file_stage_name.to_s + &quot;/&quot; + file_model_name.to_s + &quot;C/*&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    # else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    #   # All XML files in JHx folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    #   files_to_clear = base_dir + file_stage_name.to_s + &quot;/&quot; + file_model_name.to_s+ &quot;/*&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    # FileUtils.rm_rf Dir.glob(files_to_clear)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    ReportMini.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      records = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      columns = [:post_id, :yield_file_id, :station_id, :model, :stage, :seqno, :config, :station_name, :input, :first_pass, :retest_pass, :fail, :retest_process, :test_waive, :design_waive, :cof_waive, :rd_area, :bpl, :ntf, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        :failure_waive, :repaire_ok, :inl_repaire, :dip, :defect, :fail_borrow, :pass_borrow, :yield_type, :yield_rate, :yield_rate_today, :fp_yield_rate, :fp_yield_rate_today, :published_at, :p_year, :p_month, :p_mday, :p_hour]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      CSV.foreach(file, {encoding: &quot;UTF-8&quot;, quote_char: &#39;&quot;&#39;, col_sep: &#39;,&#39;, row_sep: :auto, headers: true}) do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        # Create station model and set station_id to Report obj</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">        if station = Station.find_by_name_and_post_id(row[&#39;Station&#39;], post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">          station = Station.create(post_id: post.id, yield_file_id: yf_id, name: row[&#39;Station&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">          sta_id = station.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        # Caculate accumulative yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">        if !row[&#39;Input&#39;].to_i.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">          total = row[&#39;PFirstPass&#39;].to_i + row[&#39;PRetestPass&#39;].to_i + row[&#39;TestWF&#39;].to_i + row[&#39;DesignWF&#39;].to_i + row[&#39;COFWF&#39;].to_i + row[&#39;NTF&#39;].to_i + row[&#39;FailureWF&#39;].to_i + row[&#39;RepairOK&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">          yield_rate = ( (total.to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">          fp_yield_rate = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">          # Caculate FirstPass yield rate today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">          fp_yield_rate_today = ( (row[&#39;PFirstPass&#39;].to_f / row[&#39;Input&#39;].to_f) * 100 ).round(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">          yield_rate = 99999 # Input is 0, show &#39;N/A&#39; in page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">          fp_yield_rate = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">          fp_yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">        if Time.parse(row[&#39;Date&#39;]).hour.to_i.equal? 6</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">          records_to_be_update = ReportMini.where(&#39;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">            ((p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_mday = ? AND p_hour BETWEEN ? AND ?))&#39;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">            post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, Time.parse(row[&#39;Date&#39;]).year.to_i, Time.parse(row[&#39;Date&#39;]).month.to_i, Time.parse(row[&#39;Date&#39;]).day.to_i, 7, 23, Time.parse(row[&#39;Date&#39;]).day.to_i + 1, 0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">          if records_to_be_update.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">            Parallel.each(records_to_be_update, in_threads: 4) do |record|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">              ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">                output_today = (record.first_pass.to_i - row[&#39;PFirstPass&#39;].to_i) + (record.retest_pass.to_i - row[&#39;PRetestPass&#39;].to_i) + (record.test_waive.to_i - row[&#39;TestWF&#39;].to_i) + (record.design_waive.to_i - row[&#39;DesignWF&#39;].to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">                (record.cof_waive.to_i - row[&#39;COFWF&#39;].to_i) + (record.ntf.to_i - row[&#39;NTF&#39;].to_i) + (record.failure_waive.to_i - row[&#39;FailureWF&#39;].to_i) + (record.repaire_ok.to_i - row[&#39;RepairOK&#39;].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">                input_today = record.input.to_i - row[&#39;Input&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">                yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">                record.update_attribute(:yield_rate_today, yield_rate_today)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">          input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">          output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">          yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">          datetime = DateTime.parse(row[&#39;Date&#39;].to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">          if datetime.hour.between?(7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">            base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.year, datetime.month, datetime.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">          elsif datetime.hour.between?(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">            # If no base_record at 6am, get the record that &#39;p_hour&#39; mostly close to 6 am as base_record </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">            base_record = ReportMini.where(&quot;post_id = ? AND station_name = ? AND config = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour &gt;= ?&quot;, post.id, row[&#39;Station&#39;].to_s, row[&#39;Config&#39;].to_s, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 6).order(&quot;p_hour ASC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">          if base_record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">            output_today = (row[&#39;PFirstPass&#39;].to_i - base_record.first_pass.to_i) + (row[&#39;PRetestPass&#39;].to_i - base_record.retest_pass.to_i) + (row[&#39;TestWF&#39;].to_i - base_record.test_waive.to_i) + (row[&#39;DesignWF&#39;].to_i - base_record.design_waive.to_i) + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">              (row[&#39;COFWF&#39;].to_i - base_record.cof_waive.to_i) + (row[&#39;NTF&#39;].to_i - base_record.ntf.to_i) + (row[&#39;FailureWF&#39;].to_i - base_record.failure_waive.to_i) + (row[&#39;RepairOK&#39;].to_i - base_record.repaire_ok.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">            input_today = row[&#39;Input&#39;].to_i - base_record.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">            yield_rate_today = input_today &gt; 0 ? ( (output_today.to_f / input_today.to_f) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">            fp_yield_rate_today = input_today &gt; 0 ? ( ( (row[&#39;PFirstPass&#39;].to_f - base_record.first_pass.to_f) / input_today.to_f ) * 100 ).round(2) : 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">            input_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">            output_today = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            yield_rate_today = 99999</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        time_now = Time.now.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        #record = &quot;(#{post.id}, #{yf_id}, #{sta_id}, &#39;#{row[&#39;Model&#39;].strip}&#39;, &#39;#{row[&#39;Stage&#39;].strip}&#39;, #{row[&#39;Seqno&#39;]}, &#39;#{row[&#39;Config&#39;]}&#39;, &#39;#{row[&#39;Station&#39;]}&#39;, #{row[&#39;Input&#39;]}, #{row[&#39;PFirstPass&#39;]}, #{row[&#39;PRetestPass&#39;]}, #{row[&#39;Fail&#39;]}, #{row[&#39;RetestProcess&#39;]}, #{row[&#39;TestWF&#39;]}, #{row[&#39;DesignWF&#39;]}, #{row[&#39;COFWF&#39;]}, #{row[&#39;RDArea&#39;]}, #{row[&#39;BPL&#39;]}, #{row[&#39;NTF&#39;]}, #{row[&#39;FailureWF&#39;]}, #{row[&#39;RepairOK&#39;]}, #{row[&#39;INLRepair&#39;]}, #{row[&#39;DIP&#39;]}, #{row[&#39;Defect&#39;]}, #{row[&#39;Fail_Borrow&#39;]}, #{row[&#39;Pass_Borrow&#39;]}, &#39;#{row[&#39;Type&#39;]}&#39;, #{yield_rate}, NULL, #{fp_yield_rate}, #{fp_yield_rate_today}, &#39;#{row[&#39;Date&#39;]}&#39;, #{Time.parse(row[&#39;Date&#39;]).year}, #{Time.parse(row[&#39;Date&#39;]).month}, #{Time.parse(row[&#39;Date&#39;]).day}, #{Time.parse(row[&#39;Date&#39;]).hour}, &#39;#{time_now}&#39;, &#39;#{time_now}&#39;)&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        #records += records.length == 0 ? &quot;#{record}&quot; : &quot;, #{record}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        record = [post.id, yf_id, sta_id, row[&#39;Model&#39;].strip.to_s, row[&#39;Stage&#39;].strip.to_s, row[&#39;Seqno&#39;], row[&#39;Config&#39;].to_s, row[&#39;Station&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">          row[&#39;Input&#39;], row[&#39;PFirstPass&#39;], row[&#39;PRetestPass&#39;], row[&#39;Fail&#39;], row[&#39;RetestProcess&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">          row[&#39;TestWF&#39;], row[&#39;DesignWF&#39;], row[&#39;COFWF&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">          row[&#39;RDArea&#39;], row[&#39;BPL&#39;], row[&#39;NTF&#39;], row[&#39;FailureWF&#39;], row[&#39;RepairOK&#39;], row[&#39;INLRepair&#39;], </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">          row[&#39;DIP&#39;], row[&#39;Defect&#39;], row[&#39;Fail_Borrow&#39;], row[&#39;Pass_Borrow&#39;], row[&#39;Type&#39;].to_s, yield_rate, yield_rate_today, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">          fp_yield_rate, fp_yield_rate_today, row[&#39;Date&#39;].to_s, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">          Time.parse(row[&#39;Date&#39;]).year, Time.parse(row[&#39;Date&#39;]).month, Time.parse(row[&#39;Date&#39;]).day, Time.parse(row[&#39;Date&#39;]).hour, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">          time_now, time_now, input_today, output_today]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">        records &lt;&lt; record</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      #values = records.map{ |record| &quot;(#{record.join(&quot;,&quot;)})&quot; }.join(&quot;,&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      #values = records.map{|record| &quot;(#{record.map! {|c| record.find_index(c)==3 || record.find_index(c)==4 ? c=&#39;\&#39;c\&#39;&#39; : c}.join(&#39;,&#39;)})&quot;}.join(&#39;,&#39;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      values = records.map{ |record| &quot;(#{record[0]}, #{record[1]}, #{record[2]}, &#39;#{record[3]}&#39;, &#39;#{record[4]}&#39;, #{record[5]}, &#39;#{record[6]}&#39;, &#39;#{record[7]}&#39;, #{record[8]}, #{record[9]}, #{record[10]}, #{record[11]}, #{record[12]}, #{record[13]}, #{record[14]}, #{record[15]}, #{record[16]}, #{record[17]}, #{record[18]}, #{record[19]}, #{record[20]}, #{record[21]}, #{record[22]}, #{record[23]}, #{record[24]}, #{record[25]}, &#39;#{record[26]}&#39;, #{record[27]}, #{record[28]}, #{record[29]}, #{record[30]}, &#39;#{record[31]}&#39;, #{record[32]}, #{record[33]}, #{record[34]}, #{record[35]}, &#39;#{record[36]}&#39;, &#39;#{record[37]}&#39;, &#39;#{record[38]}&#39;, &#39;#{record[39]}&#39;)&quot; }.join(&quot;,&quot;).gsub(&#39;99999&#39;, &#39;NULL&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      sql = &quot;INSERT INTO `#{self.table_name}` (`post_id`,`yield_file_id`,`station_id`,`model`,`stage`,`seqno`,`config`,`station_name`,`input`,`first_pass`,`retest_pass`,`fail`,`retest_process`,`test_waive`,`design_waive`,`cof_waive`,`rd_area`,`bpl`,`ntf`,`failure_waive`,`repaire_ok`,`inl_repaire`,`dip`,`defect`,`fail_borrow`,`pass_borrow`,`yield_type`,`yield_rate`,`yield_rate_today`,`fp_yield_rate`,`fp_yield_rate_today`,`published_at`,`p_year`,`p_month`,`p_mday`,`p_hour`,`created_at`,`updated_at`,`input_today`,`output_today`) VALUES #{values}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      #ActiveRecord::Base.connection.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do |conn|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        conn.execute(sql)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">    the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">    the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    post.update_attributes(current_year_mini: the_year, current_month_mini: the_month, current_mday_mini: the_day, current_hour_mini: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">    # # Delete last hour&#39;s records from database (For always only keep 2 groups of hourly records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">    # the_post = Post.find_by_id(post.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">    # the_year = filename[filename.index(&#39;20&#39;), 4]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    # the_month = filename[filename.index(&#39;20&#39;)+4, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    # the_day = filename[filename.index(&#39;20&#39;)+6, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    # the_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">    # if !the_post.current_hour_mini.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">    #   if !the_post.current_hour_mini.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    #     if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour_mini.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    #       check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year_mini, the_post.current_month_mini, the_post.current_mday_mini, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    #       grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">    #       if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">    #         puts &quot;Deleting old timestamp MINI records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    #         ReportMini.where(stage: file_model_stage_name, p_year: the_post.current_year_mini, p_month: the_post.current_month_mini, p_mday: the_post.current_mday_mini, p_hour: the_post.current_hour_mini).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">    #       end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    #     end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    # # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    # Post.find_by_id(post.id).update_attributes(current_year_mini: the_year, current_month_mini: the_month, current_mday_mini: the_day, current_hour_mini: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">  def self.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">    the_year = the_post.current_year_mini</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    the_month = the_post.current_month_mini</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    the_day = the_post.current_mday_mini</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    the_hour = the_post.current_hour_mini</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    if !the_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      datetime = DateTime.parse(the_year.to_s + sprintf(&#39;%02d&#39;, the_month).to_s + the_day.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">      if the_hour.to_i == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">        check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(1, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">        check_base_record = ReportMini.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">          file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">          the_year, the_month, the_day, 0, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(6, 7)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">          yesterday_latest_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">              file_model_stage_name, the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">      elsif the_hour.to_i.between?(8, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">        yesterday_latest_midnight_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">          file_model_stage_name, the_year, the_month, the_day, 0, 5).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">        if yesterday_latest_midnight_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">          yesterday_latest_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">            file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23).order(&quot;published_at DESC&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">          if !yesterday_latest_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, yesterday_latest_record.p_hour.to_i-1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">          if yesterday_latest_midnight_record.p_hour == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">              the_year, the_month, the_day, 7, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">            check_base_record = ReportMini.where(&quot;stage = ? AND ( (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) OR (p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?) )&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">              file_model_stage_name, datetime.yesterday.year, datetime.yesterday.month, datetime.yesterday.day, 7, 23,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">              the_year, the_month, the_day, 0, yesterday_latest_midnight_record.p_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      if !check_base_record.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">        grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">        if grup_hour.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">          puts &quot;Deleting overdue Sum-Mini records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">          check_base_record.destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        puts &quot;No overdue records to be delete!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">  def self.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">    # Delete overdue data records from database (Always keep only 2 groups of hourly timestamp records)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">    the_post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    the_year = latest_datetime[0..3]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">    the_month = latest_datetime[4..5]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">    the_day = latest_datetime[6..7]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    the_hour = latest_datetime[8..9]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">    if !the_post.current_hour.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">      if !the_post.current_hour.to_s.eql? the_hour.to_i.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">        if !(the_hour.to_i &gt;= 6 &amp;&amp; the_post.current_hour.to_i &lt; 6)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">          check_base_record = ReportMini.where(&quot;stage = ? AND p_year = ? AND p_month = ? AND p_mday = ? AND p_hour BETWEEN ? AND ?&quot;, file_model_stage_name, the_post.current_year_mini, the_post.current_month_mini, the_post.current_mday_mini, 6, the_hour.to_i-1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">          grup_hour = check_base_record.group(&quot;p_hour&quot;).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">          if grup_hour.count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">            puts &quot;Deleting overdue Sum-All and Sum-Config records from database...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">            ReportMini.where(stage: file_model_stage_name, p_year: the_post.current_year_mini, p_month: the_post.current_month_mini, p_mday: the_post.current_mday_mini, p_hour: the_post.current_hour_mini).destroy_all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">    # Then, update timestamp fields of post record to save the current timestamp of csv file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">    the_post.update_attributes(current_year_mini: the_year, current_month_mini: the_month, current_mday_mini: the_day, current_hour_mini: the_hour)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">  def self.export_dummy_xml(target_stage, latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">    puts &quot;Start generating dummy (Mini) XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">    stage_name = target_stage.to_s[target_stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">    model_name = target_stage.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">    # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">    sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    today_yield_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    fp_today_yield_xml_filename = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="441">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + target_stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + latest_datetime.to_s + &quot;&lt;/pubDate&gt;\n&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="442">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">    # Write dummy xml content to the files </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">    File.open(sum_all_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    File.open(sum_all_fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">    File.open(fp_today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    # Generate dummy XML folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">    station_xml_folder = xml_root_dir + &quot;/&quot; + model_name.to_s + &quot;Mini&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    FileUtils.mkdir_p station_xml_folder unless Dir.exist?(station_xml_folder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">  def self.export_to_xml(target_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">    model_stage = Post.uniq.pluck(:title)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">    puts &quot;Start to exporting Mini-build XML files to &quot; + base_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">    start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">    model_stage.each do |s|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">      if s.eql? target_stage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">        stage_name = s.to_s[s.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="472">
          
          
          <code class="ruby">        model_name = s.to_s.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="473">
          
          
          <code class="ruby">        xml_root_dir = base_dir + stage_name.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">        station_xml_folder = xml_root_dir + &quot;/&quot; + model_name + &quot;Mini&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">        # Create folder for XML files if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">        FileUtils.mkdir_p xml_root_dir unless Dir.exist?(xml_root_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">        # Generating station&#39;s XML files for Sum-All data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby">        sum_all_latest_record = ReportMini.where(&quot;stage = ?&quot;, s).order(&quot;published_at DESC&quot;).limit(1)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">        sum_all_records = ReportMini.where(&quot;stage = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">        sum_all_records_fp = ReportMini.where(&quot;stage = ? AND published_at = ? AND fp_yield_rate IS NOT NULL&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">        today_yield_records = ReportMini.where(&quot;stage = ? AND published_at = ?&quot;, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">          s, sum_all_latest_record.published_at).order(&quot;seqno ASC&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">        # Generate station&#39;s XML file for Sum-All records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">        Parallel.each(sum_all_records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">          ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">            self.generate_station_xml(r)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">        sum_all_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">        sum_all_fp_root_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_F.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">        today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_T.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">        fp_today_yield_xml_filename = xml_root_dir + &quot;/&quot; + sum_all_latest_record.model.to_s + &quot;byConfig&quot; + &quot;/&quot; + &quot;Mini_FT.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">        # Generate root XML file in specific stage folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">        self.generate_root_xml(sum_all_records, sum_all_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">        self.generate_fp_root_xml(sum_all_records, sum_all_records_fp, sum_all_fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">        self.generate_today_yield_root_xml(today_yield_records, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">        #self.generate_fp_today_yield_root_xml(today_yield_records, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">    puts &quot;Completed exporting (Mini) XML files in #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">  def self.generate_station_xml(record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="508">
          
          
          <code class="ruby">    xml_header = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;title&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot; Detail&quot; + &quot;&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="509">
          
          
          <code class="ruby">    xml_model = &quot;&lt;item&gt;&lt;title&gt;Model&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.model.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="510">
          
          
          <code class="ruby">    xml_stage = &quot;&lt;item&gt;&lt;title&gt;Stage&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.stage.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    xml_config = &quot;&lt;item&gt;&lt;title&gt;Config&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.config.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="512">
          
          
          <code class="ruby">    xml_station = &quot;&lt;item&gt;&lt;title&gt;Station&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="513">
          
          
          <code class="ruby">    xml_input = &quot;&lt;item&gt;&lt;title&gt;Input&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.input.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="514">
          
          
          <code class="ruby">    xml_first_pass = &quot;&lt;item&gt;&lt;title&gt;FirstPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.first_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    xml_retest_pass = &quot;&lt;item&gt;&lt;title&gt;RetestPass&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_pass.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="516">
          
          
          <code class="ruby">    xml_fail = &quot;&lt;item&gt;&lt;title&gt;FailOnlineFail&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="517">
          
          
          <code class="ruby">    xml_retest_process = &quot;&lt;item&gt;&lt;title&gt;RetestProcess&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.retest_process.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="518">
          
          
          <code class="ruby">    xml_test_waive = &quot;&lt;item&gt;&lt;title&gt;TestWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.test_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">    xml_design_waive = &quot;&lt;item&gt;&lt;title&gt;DesignWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.design_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">    xml_cof_waive = &quot;&lt;item&gt;&lt;title&gt;COFWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.cof_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="521">
          
          
          <code class="ruby">    xml_rd_area = &quot;&lt;item&gt;&lt;title&gt;RDArea&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.rd_area.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="522">
          
          
          <code class="ruby">    xml_bpl = &quot;&lt;item&gt;&lt;title&gt;BoundtoPL&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.bpl.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="523">
          
          
          <code class="ruby">    xml_ntf = &quot;&lt;item&gt;&lt;title&gt;NTF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.ntf.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">    xml_failure_waive = &quot;&lt;item&gt;&lt;title&gt;FailureWF&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.failure_waive.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">    xml_repaire_ok = &quot;&lt;item&gt;&lt;title&gt;RepairOK&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.repaire_ok.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">    xml_inl_repaire = &quot;&lt;item&gt;&lt;title&gt;INLRepair&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.inl_repaire.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">    xml_dip = &quot;&lt;item&gt;&lt;title&gt;DIPScrap&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.dip.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">    xml_defect = &quot;&lt;item&gt;&lt;title&gt;Defect&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.defect.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">    xml_fail_borrow = &quot;&lt;item&gt;&lt;title&gt;Fail_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.fail_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="530">
          
          
          <code class="ruby">    xml_pass_borrow = &quot;&lt;item&gt;&lt;title&gt;Pass_Borrow&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.pass_borrow.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">    xml_yield_type = &quot;&lt;item&gt;&lt;title&gt;Type&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.yield_type.to_s + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="532">
          
          
          <code class="ruby">    xml_ctime = &quot;&lt;item&gt;&lt;title&gt;CTime&lt;/title&gt;\n&lt;pubDate&gt;&quot; + record.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;1&lt;/link&gt;&lt;yield&gt;1&lt;/yield&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="533">
          
          
          <code class="ruby">    xml_footer = &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="535">
          
          
          <code class="ruby">    base_dir = base_dir = &quot;/Users/&quot; + ENV[&#39;USER&#39;] + &quot;/desktop/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="536">
          
          
          <code class="ruby">    stage_name = record.stage.to_s[record.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">    xml_target_dir = base_dir + stage_name + &quot;/&quot; + record.model.to_s + &quot;Mini&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">    # Create xml folder if it does not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="540">
          
          
          <code class="ruby">    FileUtils.mkdir_p xml_target_dir unless Dir.exist?(xml_target_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    # Define the xml file path (And removes all non-alphanumber characters from station_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">    local_filename = xml_target_dir + &quot;/&quot; + record.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;) + &quot;.xml&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="544">
          
          
          <code class="ruby">    File.open(local_filename, &#39;w&#39;) { |f| f.write(xml_header + xml_model + xml_stage + xml_config + xml_station + xml_input + xml_first_pass + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">      xml_retest_pass + xml_fail + xml_retest_process + xml_test_waive + xml_design_waive + xml_cof_waive + xml_rd_area + xml_bpl + xml_ntf + xml_failure_waive + </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">      xml_repaire_ok + xml_inl_repaire + xml_dip + xml_defect + xml_fail_borrow + xml_pass_borrow + xml_yield_type + xml_ctime + xml_footer) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">  def self.generate_root_xml(records, root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="552">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="554">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="555">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="557">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">          last_station = ReportMini.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="562">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="569">
          
          
          <code class="ruby">        y_rate = r.yield_rate.nil? ? &#39;No Input&#39; : r.yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="577">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="578">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Mini/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="579">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="580">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="581">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="582">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">    File.open(root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="585">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">  def self.generate_fp_root_xml(records, records_fp, fp_root_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">    # XML file path for showing FirstPass yield</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="591">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="592">
          
          
          <code class="ruby">    Parallel.each(records_fp, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="593">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="594">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="597">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="598">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">          last_station = ReportMini.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="601">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="603">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">        # Counting FirstPass yield rate, if fp_yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">        fp_yield_rate = r.fp_yield_rate.nil? ? &#39;No Input&#39; : r.fp_yield_rate.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="612">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="616">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + fp_yield_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Mini/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="622">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="623">
          
          
          <code class="ruby">    File.open(fp_root_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="625">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">  def self.generate_today_yield_root_xml(records, today_yield_xml_filename, fp_today_yield_xml_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="629">
          
          
          <code class="ruby">    server_url = &quot;http://csmcfa01.quantacn.com:8087/PPP/TestXML/&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">    tmp = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="631">
          
          
          <code class="ruby">    tmp2 = &quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;&lt;rss version=\&quot;2.0\&quot;&gt;&lt;channel&gt;\n&lt;Ntitle A=\&quot;&quot; + records.first.stage.to_s + &quot;\&quot;&gt;&lt;/Ntitle&gt;\n&lt;pubDate&gt;&quot; + records.first.published_at.to_s.gsub(&#39; UTC&#39;, &#39;&#39;) + &quot;&lt;/pubDate&gt;\n&lt;link&gt;&lt;/link&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="632">
          
          
          <code class="ruby">    Parallel.each(records, in_threads: 4) do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="633">
          
          
          <code class="ruby">      ActiveRecord::Base.connection_pool.with_connection do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">        # Counting Output &amp; WIP of each station</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">        output = r.first_pass.to_i + r.retest_pass.to_i + r.test_waive.to_i + r.design_waive.to_i + r.cof_waive.to_i + r.ntf.to_i + r.failure_waive.to_i + r.repaire_ok.to_i + r.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">        if r.seqno.to_s.eql? &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="637">
          
          
          <code class="ruby">          wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">          last_station = ReportMini.find_by_seqno_and_stage_and_config_and_published_at(r.seqno - 1, r.stage, r.config, r.published_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">          if last_station.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">            wip = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="642">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="643">
          
          
          <code class="ruby">            last_station_output = last_station.first_pass.to_i + last_station.retest_pass.to_i + last_station.test_waive.to_i + last_station.design_waive.to_i + last_station.cof_waive.to_i + last_station.ntf.to_i + last_station.failure_waive.to_i + last_station.repaire_ok.to_i + last_station.inl_repaire.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="644">
          
          
          <code class="ruby">            wip = last_station_output - last_station.pass_borrow.to_i - r.input.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">            wip = 0 if wip &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="646">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="647">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="648">
          
          
          <code class="ruby">        # If yield_rate is NULL in database, convert it to &#39;No Input&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">        y_rate = r.yield_rate_today.nil? ? &#39;No Input&#39; : r.yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">        y_rate_fp = r.fp_yield_rate_today.nil? ? &#39;No Input&#39; : r.fp_yield_rate_today.to_s + &#39;%&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">        # For separating the XML file contents from &#39;Sum-All&#39; and &#39;Sum-Config&#39; file type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby">        station_name = r.station_name.to_s.gsub(&#39;/&#39;, &#39;_&#39;).gsub(&#39;&amp;&#39;, &#39;_&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="653">
          
          
          <code class="ruby">        xml_filename = r.station_name.to_s.gsub(/[^0-9a-z]/i, &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">        model_name = r.model.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">        # Get stage name without model (ex. EVT)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">        stage_name = r.stage.to_s[r.stage.to_s.index(&#39;-&#39;)+1..-1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="658">
          
          
          <code class="ruby">        # Write data from csv row data to XML file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">        tmp &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Mini/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">        tmp2 &lt;&lt; &quot;&lt;item&gt;&lt;title&gt;&quot; + station_name + &quot;&lt;/title&gt;\n&lt;pubDate&gt;Input:&quot; + r.input.to_s + &quot; Output:&quot; + output.to_s + &quot; WIP:&quot; + wip.to_s + &quot; FAIL:&quot; + r.fail.to_s + &quot;&lt;/pubDate&gt;\n&lt;yield&gt;&quot; + y_rate_fp + &quot;&lt;/yield&gt;\n&lt;sflow&gt;&quot; + r.seqno.to_s + &quot;&lt;/sflow&gt;\n&lt;link&gt;&quot; + server_url + stage_name + &quot;/&quot; + model_name + &quot;Main/&quot; + xml_filename + &quot;.xml&lt;/link&gt;&lt;/item&gt;\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="661">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">    tmp &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="664">
          
          
          <code class="ruby">    tmp2 &lt;&lt; &quot;&lt;/channel&gt;&lt;/rss&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">    # Write xml content to the file </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="666">
          
          
          <code class="ruby">    File.open(today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">      f &lt;&lt; tmp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">    File.open(fp_today_yield_xml_filename, &#39;w&#39;) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="670">
          
          
          <code class="ruby">      f &lt;&lt; tmp2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="673">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7cc9ea4465c93015ca10915b71dd35c613265931">
  <div class="header">
    <h3>app/models/station.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Station &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessible :post_id, :yield_file_id, :name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  belongs_to :yield_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  has_many :reports, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  has_many :report_mains, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  has_many :report_minis, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  validates :name, :post_id, :yield_file_id, presence: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d22cad171f75d0128802dd301ea944158bb639b">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">46.15 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class User &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Include default devise modules. Others available are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # :token_authenticatable, :encryptable, :confirmable, :lockable, :timeoutable and :omniauthable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  devise :database_authenticatable, :registerable,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">         :recoverable, :rememberable, :trackable, :validatable,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">         :omniauthable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Setup accessible (or protected) attributes for your model</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessible :email, :password, :password_confirmation, :remember_me</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # attr_accessible :title, :body</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessible :provider, :uid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :facebook_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :posts, :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :products, :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :access_grants, :dependent =&gt; :destroy, :class_name =&gt; &quot;Doorkeeper::AccessGrant&quot;, :foreign_key =&gt; &quot;resource_owner_id&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :access_tokens, :dependent =&gt; :destroy, :class_name =&gt; &quot;Doorkeeper::AccessToken&quot;, :foreign_key =&gt; &quot;resource_owner_id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # validates_presence_of   :email, :if =&gt; :email_required?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # validates_uniqueness_of :email, :allow_blank =&gt; true, :if =&gt; :email_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # validates_format_of     :email, :with  =&gt; email_regexp, :allow_blank =&gt; true, :if =&gt; :email_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # validates_presence_of     :password, :if =&gt; :password_required?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # validates_confirmation_of :password, :if =&gt; :password_required?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # validates_length_of       :password, :within =&gt; password_length, :allow_blank =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find_for_facebook_oauth(auth, signed_in_resource = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    user = User.where(provider: auth.provider, uid: auth.uid).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    unless user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      user = User.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # name: auth.extra.raw_info.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        provider: auth.provider,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        uid: auth.uid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        email: auth.info.email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        password: Devise.friendly_token[0, 20]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    if user.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      user.facebook_token = auth.credentials.token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      user.facebook_expires_at = Time.at(auth.credentials.expires_at)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.new_with_session(params, session)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    super.tap do |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      if data = session[&quot;devise.facebook_data&quot;] &amp;&amp; session[&quot;devise.facebook_data&quot;][&quot;extra&quot;][&quot;raw_info&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        user.email = data[&quot;email&quot;] if user.email.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  def facebook</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    if !@facebook &amp;&amp; facebook_token &amp;&amp; facebook_expires_at &gt; Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      @facebook = Koala::Facebook::API.new(facebook_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    @facebook</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="796298c4d1a463e34a8d433d9e01dcd06c25b99f">
  <div class="header">
    <h3>app/models/yield_file.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class YieldFile &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attr_accessible :post_id, :file_name, :total_row, :published_at</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  has_many :reports, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  has_many :report_mains, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  has_many :report_minis, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  has_many :stations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  validates :file_name, presence: true, uniqueness: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  validates :post_id, :total_row, :published_at, presence: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  validates :total_row, numericality: { only_integer: true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  before_create do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  	file_extension = File.extname(self.file_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    if !file_extension.downcase == &#39;.csv&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  after_create do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    # If failed to import reports, delete the yield file from database </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    unless Report.where(&#39;yield_file_id = ?&#39;, self.id).first.equal? nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      self.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f4ec721e9f370fffeb55c366aa07298942d65952">
  <div class="header">
    <h3>lib/tasks/clean_overdue_data_dvt.rake</h3>
    <h4><span class="red">10.81 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :clean_overdue_records_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	puts &#39;Start the process deleting overdue records at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHC-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHD-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHE-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHF-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">	puts &#39;All deleting process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="9fb8d7e951ade8298f9a2bd8d8f8300cfdc13778">
  <div class="header">
    <h3>lib/tasks/clean_overdue_data_gl_dvt.rake</h3>
    <h4><span class="red">10.81 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :clean_overdue_records_gl_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	puts &#39;Start the process deleting overdue records at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHC-GL-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHD-GL-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHE-GL-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">	file_model_stage_name = &quot;JHF-GL-DVT&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">	post = Post.find_by_title(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">	if !post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">		puts &quot;Deleting &quot; + file_model_stage_name + &quot; overdue records...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">		Report.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">		ReportMain.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">		ReportMini.delete_overdue_records_beta(file_model_stage_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">	puts &#39;All deleting process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="97a368b9d37950528de35672f61955fed5bc3af9">
  <div class="header">
    <h3>lib/tasks/import_jhc_dvt.rake</h3>
    <h4><span class="red">2.88 %</span> covered</h4>
    <div>
      <b>139</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>135</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhc_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	puts &#39;Fetching CSV files from target folder...&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">	imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	d = Dir.new(&#39;/Users/david/desktop/CSV_to_import/JHC&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">	#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">	# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">	#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">	csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">	# Only import DVT files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">	# csvs.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">	# 	filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	# 	if filename.include? &quot;JHC-AB&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	# 		filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">	# 	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">	puts &#39;Start running auto importing process at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">	#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">	date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">	date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">	date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">	csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">		file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">		file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">		if filename.include? &quot;JHC-DVT.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">			# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">			if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">				if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">				elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">			# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">			elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">				if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">	# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">		file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">		check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">	latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">		if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">			filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">	filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">		#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">		line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">	        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">	        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">			                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">		    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">	        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">	        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">			                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">		    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">	        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">	        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">			                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">		    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">		    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">		    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">	            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">	            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">	              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">	            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">	            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">	            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">	            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">		            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">		            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">		        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">		            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">		            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">		        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">		            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">		            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">		        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">	puts filtered_csvs_from_base_and_latest_hour.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    	Report.export_to_xml(&quot;JHC-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">	if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    	ReportMain.export_to_xml(&quot;JHC-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">		ReportMini.export_to_xml(&quot;JHC-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">	# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">	if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">		Report.export_dummy_xml(&quot;JHC-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">	if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">		ReportMain.export_dummy_xml(&quot;JHC-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">	if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">		ReportMini.export_dummy_xml(&quot;JHC-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">	# Delete overdue records from database (Do this at the end of rake task, because it costs long time to finish!)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">	# file_model_stage_name = &quot;JHC-DVT&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">	# if imported_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">	# 	Report.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">	# if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"> #    	ReportMain.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"> #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"> #    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">	# 	ReportMini.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0144b9eb4dc051a78c9157db1db597a8ccc98ecb">
  <div class="header">
    <h3>lib/tasks/import_jhd_dvt.rake</h3>
    <h4><span class="red">2.82 %</span> covered</h4>
    <div>
      <b>142</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhd_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">	# copying CSV files from network folders to local folders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	batfile_path = &quot;#{Rails.root}/lib/tasks/copy_csv_files.bat&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">	puts &quot;Starting Copying CSV files from network folders&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	system(batfile_path) # Execute .bat file to copying csv files from network folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">	puts &quot;Completed Copying CSV files!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	puts &#39;Start running auto importing process at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">	imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">	d = Dir.new(&#39;/Users/david/desktop/CSV_to_import/JHD&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">	#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">	csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">	# Only import DVT files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	# csvs.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	# 	filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">	# 	if filename.include? &quot;JHD-AB&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">	# 		filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">	# 	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">	#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">	date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">	date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">	date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">	csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">		file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">		file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">		if filename.include? &quot;JHD-DVT.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">			# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">			if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">				if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">				elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">			# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">			elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">				if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">	# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">		file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">		check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">	latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">		if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">			filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">	filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">		#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">		line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">	        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">	        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">			                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">		    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">	        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">	        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">			                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">		    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">	        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">	        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">			                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">		    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">		    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">		    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">	            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">	            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">	              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">	            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">	            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">	            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">	            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">		            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">		            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">		        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">		            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">		            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">		        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">		            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">		            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">		        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">	puts filtered_csvs_from_base_and_latest_hour.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">		Report.export_to_xml(&quot;JHD-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">	if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    	ReportMain.export_to_xml(&quot;JHD-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">		ReportMini.export_to_xml(&quot;JHD-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">	if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">		Report.export_dummy_xml(&quot;JHD-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">	if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">		ReportMain.export_dummy_xml(&quot;JHD-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">	if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">		ReportMini.export_dummy_xml(&quot;JHD-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">	# Delete overdue records from database (Do this at the end of rake task, because it costs long time to finish!)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">	# file_model_stage_name = &quot;JHD-DVT&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">	# if imported_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">	# 	Report.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">	# if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"> #    	ReportMain.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"> #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"> #    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">	# 	ReportMini.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="490ad2a4d9c4ce1e83d4733353d36955dc36e25f">
  <div class="header">
    <h3>lib/tasks/import_jhe_dvt.rake</h3>
    <h4><span class="red">2.82 %</span> covered</h4>
    <div>
      <b>142</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhe_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">	# copying CSV files from network folders to local folders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	batfile_path = &quot;#{Rails.root}/lib/tasks/copy_csv_files.bat&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">	puts &quot;Starting Copying CSV files from network folders&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	system(batfile_path) # Execute .bat file to copying csv files from network folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">	puts &quot;Completed Copying CSV files!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	puts &#39;Start running auto importing process at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">	imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">	d = Dir.new(&#39;/Users/david/desktop/CSV_to_import/JHE&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">	#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">	csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">	# Only import DVT files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	# csvs.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	# 	filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">	# 	if filename.include? &quot;JHE-AB&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">	# 		filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">	# 	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">	#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">	date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">	date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">	date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">	csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">		file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">		file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">		if filename.include? &quot;JHE-DVT.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">			# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">			if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">				if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">				elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">			# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">			elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">				if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">	# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">		file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">		check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">	latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">		if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">			filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">	filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">		#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">		line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">	        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">	        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">			                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">		    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">	        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">	        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">			                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">		    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">	        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">	        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">			                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">		    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">		    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">		    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">	            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">	            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">	              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">	            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">	            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">	            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">	            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">		            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">		            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">		        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">		            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">		            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">		        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">		            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">		            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">		        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">	puts filtered_csvs_from_base_and_latest_hour.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">	puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">	end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">	puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">	# Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">		Report.export_to_xml(&quot;JHE-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">	if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    	ReportMain.export_to_xml(&quot;JHE-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">		ReportMini.export_to_xml(&quot;JHE-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">	if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">		Report.export_dummy_xml(&quot;JHE-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">	if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">		ReportMain.export_dummy_xml(&quot;JHE-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">	if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">		ReportMini.export_dummy_xml(&quot;JHE-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">	# Delete overdue records from database (Do this at the end of rake task, because it costs long time to finish!)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">	# file_model_stage_name = &quot;JHE-DVT&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">	# if imported_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">	# 	Report.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">	# if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"> #    	ReportMain.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"> #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"> #    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">	# 	ReportMini.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="6bdc78e1cb37a545f0a43aee4cc1b7255d8f8ef6">
  <div class="header">
    <h3>lib/tasks/import_jhe_pvte.rake</h3>
    <h4><span class="red">2.82 %</span> covered</h4>
    <div>
      <b>142</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhe_pvte, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	prefer_stages = [&quot;JHE-PVTe&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	prefer_stages.each do |prefer_stage|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">		puts &quot;Start auto importing process for &quot; + prefer_stage</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">		start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">		imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">		imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">		imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">	    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">	    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">	    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">	    mounted_folder = &#39;/Users/david/desktop/CSV_to_import/&#39; + prefer_stage.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">	    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">		d = Dir.new(mounted_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">		#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">		# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">		#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">		prefered_date_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%Y%m%d%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">		prefered_filename = &#39;*Sum-*&#39; + prefered_date_hour.to_s + &#39;*.csv&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		csvs = Dir[ File.join(d, &#39;**&#39;, prefered_filename) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">		#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">		date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">		date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">			</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">		csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">			file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">			file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">			if filename.include? prefer_stage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">				# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">				if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">					if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">					elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">				# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">				elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">					if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">		# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">			file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">			check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">		latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">			if (filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">				filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">			#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">			line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">	        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">	        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">	        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">	        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">	        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">	        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">	        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">	        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">	        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">	        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">	        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">	        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">	        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">	        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">	        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">	        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">	        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">	        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">	        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">	        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">		        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">		        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">				                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">			    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">		        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">		        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">				                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">			    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">		        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">		        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">				                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">			    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">			    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">			    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">		            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">		            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">		              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">		            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">		            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">		            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">			            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">			            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">			        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">			            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">			            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">			        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;06&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">			            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">			            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">	        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">		puts filtered_csvs.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">	    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">	    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">	    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">			Report.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">		if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">	    	ReportMain.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">	    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">	    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">			ReportMini.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">		# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">		if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">			Report.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">		if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">			ReportMain.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">		if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">			ReportMini.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">		end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">		puts &quot;Auto importing process for &quot; + prefer_stage + &quot; completed in #{(end_time - start_time)} seconds\n\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4d08ef2950c290b1776de1f8019b5803b80c46fe">
  <div class="header">
    <h3>lib/tasks/import_jhf_dvt.rake</h3>
    <h4><span class="red">2.82 %</span> covered</h4>
    <div>
      <b>142</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhf_dvt, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">	# copying CSV files from network folders to local folders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	batfile_path = &quot;#{Rails.root}/lib/tasks/copy_csv_files.bat&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">	puts &quot;Starting Copying CSV files from network folders&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">	system(batfile_path) # Execute .bat file to copying csv files from network folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">	puts &quot;Completed Copying CSV files!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	puts &#39;Start running auto importing process at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">	imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">	d = Dir.new(&#39;/Users/david/desktop/CSV_to_import/JHF&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">	#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">	csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">	# Only import DVT files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	# csvs.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	# 	filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">	# 	if filename.include? &quot;JHF-AB&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">	# 		filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">	# 	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">	#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">	date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">	date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">	date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">	csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">		file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">		file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">		if filename.include? &quot;JHF-DVT.csv&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">			# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">			if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">				if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">				elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">			# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">			elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">				if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">					filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">	# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">		file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">		check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">	latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">	filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">		if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">			filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">	filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">		#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">		filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">		line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">	        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">	        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">			                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">		    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">	        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">	        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">			                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">		    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">	        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">	        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">	        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">	        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">	        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">	        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">			                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">			                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">			            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">			                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">			                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">			                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">		    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">		    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">		    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">	            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">	            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">	              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">	            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">	            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">	            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">	            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">		            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">		            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">		        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">		            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">		            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">		        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">		            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">		            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">		            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">		            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">		            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">		            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">		            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">		            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">		            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">		            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">		            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">		            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">		        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">	puts filtered_csvs_from_base_and_latest_hour.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">		Report.export_to_xml(&quot;JHF-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">	if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    	ReportMain.export_to_xml(&quot;JHF-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">		ReportMini.export_to_xml(&quot;JHF-DVT&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">	if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">		Report.export_dummy_xml(&quot;JHF-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">	if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">		ReportMain.export_dummy_xml(&quot;JHF-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">	if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">		ReportMini.export_dummy_xml(&quot;JHF-DVT&quot;, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">	# Delete overdue records from database (Do this at the end of rake task, because it costs long time to finish!)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">	# file_model_stage_name = &quot;JHF-DVT&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">	# if imported_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">	# 	Report.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">	# if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"> #    	ReportMain.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"> #    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"> #    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">	# 	ReportMini.delete_overdue_records(file_model_stage_name, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">	# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="45f3ae5f02adb3c091ba3b5dafba7ad75ea38f85">
  <div class="header">
    <h3>lib/tasks/import_jhh_ab.rake</h3>
    <h4><span class="red">2.8 %</span> covered</h4>
    <div>
      <b>143</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>139</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhh_ab, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	prefer_stages = [&quot;JHH-AB&quot;, &quot;JHH-IM-AB&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	prefer_stages.each do |prefer_stage|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">		puts &quot;Fetching CSV files from target folder...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">		imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">		imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">		imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">	    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">	    mounted_folder = &#39;/Users/david/desktop/CSV_to_import/JHH&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">	    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		d = Dir.new(mounted_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">		#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">		# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">		#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">		cur_date_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%Y%m%d%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">		csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| !p.include?(cur_date_hour) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">		puts &quot;Start auto importing process for &quot; + prefer_stage + &quot;at #{start_time}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">		#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">		date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">		date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">		date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">			</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">		csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">			file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">			file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">			if filename.include? prefer_stage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">				# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">				if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">					if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">					elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">				# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">				elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">					if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">		# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">			file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">			check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">		latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">			if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">				filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">			#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">			line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">	        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">	        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">	        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">	        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">	        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">	        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">	        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">	        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">	        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">	        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">	        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">	        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">	        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">	        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">	        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">	        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">	        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">	        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">	        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">	        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">		        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">		        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">				                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">			    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">		        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">		        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">				                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">			    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">		        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">		        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">				                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">			    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">			    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">			    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">		            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">		            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">		              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">		            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">		            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">		            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">			            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">			            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">			        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">			            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">			            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">			        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">			            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">			            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">	        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">		puts filtered_csvs.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">		puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    	end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">    	puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">	    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">	    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">	    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">			Report.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">		if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">	    	ReportMain.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">	    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">	    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">			ReportMini.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">		# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">		if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">			Report.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">		if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">			ReportMain.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">		if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">			ReportMini.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b6a793c740e74e8cc9f87009a41036dfceebc160">
  <div class="header">
    <h3>lib/tasks/import_jhk_p2.rake</h3>
    <h4><span class="red">2.82 %</span> covered</h4>
    <div>
      <b>142</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhk_p2, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	prefer_stages = [&quot;JHK-P2&quot;, &quot;JHK-IM-P2&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	prefer_stages.each do |prefer_stage|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">		puts &quot;Fetching CSV files from target folder...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">		imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">		imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">		imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">	    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">	    mounted_folder = &#39;/Users/david/desktop/CSV_to_import/JHK&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">	    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		d = Dir.new(mounted_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">		#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">		# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">		#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">		csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">		start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		puts &quot;Start auto importing process for &quot; + prefer_stage + &quot;at #{start_time}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">		#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">		date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">		date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">			</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">		csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">			file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">			file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">			if filename.include? prefer_stage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">				# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">				if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">					if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">					elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">				# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">				elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">					if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">		# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">			file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">			check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">		latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">			if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">				filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">			#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">			line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">	        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">	        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">	        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">	        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">	        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">	        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">	        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">	        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">	        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">	        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">	        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">	        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">	        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">	        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">	        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">	        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">	        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">	        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">	        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">	        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">		        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">		        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">				                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">			    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">		        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">		        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">				                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">			    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">		        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">		        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">				                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">			    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">			    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">			    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">		            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">		            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">		              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">		            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">		            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">		            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">			            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">			            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">			        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">			            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">			            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">			        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">			            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">			            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">	        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">		puts filtered_csvs.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">		puts &#39;Auto importing process completed at &#39; + Time.now.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    	end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">    	puts &quot;Time elapsed #{(end_time - start_time)} seconds&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">	    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">	    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">	    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">			Report.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">		if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">	    	ReportMain.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">	    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">	    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">			ReportMini.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">		# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">		if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">			Report.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">		if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">			ReportMain.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">		if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">			ReportMini.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7c6ef95ec1f6bf8ac055cf05be6cf899a1046900">
  <div class="header">
    <h3>lib/tasks/import_jhx_dvt_mix.rake</h3>
    <h4><span class="red">2.84 %</span> covered</h4>
    <div>
      <b>141</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>137</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhx_dvt_mix, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	prefer_stages = [&quot;JHC-DVT&quot;, &quot;JHD-DVT&quot;, &quot;JHE-DVT&quot;, &quot;JHF-DVT&quot;, &quot;JHC-GL-DVT&quot;, &quot;JHD-GL-DVT&quot;, &quot;JHE-GL-DVT&quot;, &quot;JHF-GL-DVT&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	prefer_stages.each do |prefer_stage|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">		puts &quot;Fetching CSV files from target folder...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">		imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">		imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">		imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">	    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">	    mounted_folder = &#39;/Users/david/desktop/CSV_to_import/&#39; + prefer_stage.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">	    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		d = Dir.new(mounted_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">		#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">		# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">		#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">		csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">		start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		puts &quot;Start auto importing process for &quot; + prefer_stage + &quot;at #{start_time}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">		#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">		date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">		date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">			</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">		csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">			file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">			file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">			if filename.include? prefer_stage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">				# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">				if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">					if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">					elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">				# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">				elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">					if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">		# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">			file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">			check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">		latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">			if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">				filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">			#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">			line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">	        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">	        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">	        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">	        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">	        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">	        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">	        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">	        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">	        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">	        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">	        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">	        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">	        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">	        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">	        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">	        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">	        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">	        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">	        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">	        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">		        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">		        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">				                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">			    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">		        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">		        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">				                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">			    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">		        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">		        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">				                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">			    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">			    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">			    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">		            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">		            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">		              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">		            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">		            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">		            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">			            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">			            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">			        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">			            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">			            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">			        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">			            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">			            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">	        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">		puts filtered_csvs.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">	    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">	    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">	    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">			Report.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">		if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">	    	ReportMain.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">	    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">	    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">			ReportMini.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">		# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">		if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">			Report.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">		if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">			ReportMain.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">		if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">			ReportMini.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">		end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">		puts &quot;Auto importing process for &quot; + prefer_stage + &quot; completed in #{(end_time - start_time)} seconds\n\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7c17231eb03eb5a7fcc5bde9e337642a9a4abcd1">
  <div class="header">
    <h3>lib/tasks/import_jhx_pvte.rake</h3>
    <h4><span class="red">2.8 %</span> covered</h4>
    <div>
      <b>143</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>139</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">desc &quot;This task is called for importing CSV files into YesPanda database&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">task :import_jhx_pvte, [:filename] =&gt; :environment do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">	prefer_stages = [&quot;JHC-PVTe&quot;, &quot;JHD-PVTe&quot;, &quot;JHE-PVTe&quot;, &quot;JHF-PVTe&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">	prefer_stages.each do |prefer_stage|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">		puts &quot;Fetching CSV files from target folder...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">		imported_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">		imported_main_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">		imported_mini_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">	    duplicated_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">	    filtered_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">	    no_row_files = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">	    filtered_csvs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">	    check_filename_datetime = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">	    generate_dummy_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">	    generate_dummy_main_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">	    generate_dummy_min_xml = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">	    mounted_folder = &#39;/Users/david/desktop/CSV_to_import/&#39; + prefer_stage.split(&#39;-&#39;)[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">	    # Define the folder of CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		d = Dir.new(mounted_folder)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">		#Dir.chdir(d)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">		# This will recursively find all csv files in a given directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">		#csvs = d.entries.select {|csv| /^.+\.csv$/.match(csv)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">		#csvs = Dir[ File.join(d, &#39;**&#39;, &#39;*.csv&#39;) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">		prefered_date_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%Y%m%d%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">		prefered_filename = &#39;*Sum-*&#39; + prefered_date_hour.to_s + &#39;*.csv&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">		csvs = Dir[ File.join(d, &#39;**&#39;, prefered_filename) ].reject { |p| File.directory? p }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">		start_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">		puts &quot;Start auto importing process for &quot; + prefer_stage + &quot;at #{start_time}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">		#Only import today&#39;s CSV files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">		date_today = DateTime.parse(Date.today.to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">		date_today_hour = DateTime.parse(Time.now.to_s).strftime(&#39;%H&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">		date_yesterday = DateTime.parse((Date.today-1).to_s).strftime(&#39;%Y%m%d&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">			</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">		csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">			file_date = filename[filename.index(&#39;20&#39;), 8]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">			file_hour = filename[filename.index(&#39;20&#39;)+8, 2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">			if filename.include? prefer_stage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">				# If currnet hour is between 00~05, then keep CSV files of today(00am ~ 05am) and yesterday(06am ~ 23pm)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">				if date_today_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">					if file_date.eql?(date_yesterday) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">					elsif file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(00, 05)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">				# If currnet hour is between 06~23, then keep CSV files of today(06am ~ 23pm)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">				elsif date_today_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">					if file_date.eql?(date_today) &amp;&amp; file_hour.to_i.between?(06, 23)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">						filtered_csvs &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">		# Get latest datetime stamp from csv filename lists</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">			file_datetime = filename[filename.index(&#39;20&#39;), 12]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">			check_filename_datetime &lt;&lt; file_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">		latest_datetime = check_filename_datetime.max</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">		filtered_csvs.select do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">			if (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">				filtered_csvs_from_base_and_latest_hour &lt;&lt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">		filtered_csvs_from_base_and_latest_hour.select do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">			#filepath = File.absolute_path(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">			filename = File.basename(file).gsub(&#39;_&#39;, &#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">			line_count = `wc -l &quot;#{file}&quot;`.strip.split(&#39; &#39;)[0].to_i - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">	        # Check if csv file already existed (imported) in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">	        if YieldFile.exists?(file_name: filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">	        	duplicated_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">	        	puts filename.to_s + &#39; duplicated!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">	        # For now, we only accept importing &#39;Sum-All&#39; and &#39;Sum-Config&#39; files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">	        elsif !filename.include? &quot;Sum-&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">	        	filtered_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">	        # Do nothing when CSV files contain no row data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">	        elsif line_count.equal? 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">	        	if (filename.include? &quot;Sum-All&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">	        		generate_dummy_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Main&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">	        		generate_dummy_main_xml = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">	        	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; (filename.include? latest_datetime)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">	        		generate_dummy_min_xml = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">	        	no_row_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">	        	next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">	        else # Process the CSV files that we actually need</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">	        	trim_index1 = filename.index(&#39;20&#39;) + 12</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">	        	trim_index2 = filename.index(&#39;.csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">	        	model_stage = filename[trim_index1, (trim_index2 - trim_index1)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">	        	if post = Post.find_by_title(model_stage)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">	        		if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">		        		ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">		        			count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">				                imported_main_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">			    	elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">		        		ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">		        			count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">				                imported_mini_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">			    	elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">		        		Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">		        		# Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">		        		if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">		        			count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">		        			# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">		        			if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">				                imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">				                puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">				            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">				                # If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">				                file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">				                puts &#39;Data lost while importing from &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">				            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">				        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">			    	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">			    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">			    	# Create Product and Post name, if it doesn&#39;t exist in database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">		            product_name = model_stage[0, model_stage.index(&#39;-&#39;)]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">		            unless product = Product.find_by_title(product_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">		              product = Product.create(user_id: &#39;1&#39;, title: product_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">		            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">		            post = Post.create(user_id: &#39;1&#39;, product_id: product.id, title: model_stage, published_at: Time.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">		            # Then import yield records</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">		            if (filename.include? &quot;Sum-Main&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">			            ReportMain.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">			            	count = ReportMain.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">			        elsif (filename.include? &quot;Sum-Min&quot;) &amp;&amp; ((filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">			            ReportMini.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">			            	count = ReportMini.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">			        elsif (filename.include? latest_datetime) || (filename.include? date_today + &quot;0600&quot;) # For handling &#39;Sum-All&#39; and &#39;Sum-Config&#39; csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">			            Report.import_data(file, filename, post)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">			            # Check total imported row counts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">			            if file = YieldFile.find_by_file_name(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">			            	count = Report.where(post_id: post, yield_file_id: file).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">			            	# Check if CSV row numbers equal to record numbers that imported to database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">			            	if count.equal? file.total_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">			            		imported_files &lt;&lt; file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">			            		puts filename.to_s + &#39; successfully imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">			            	else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">			            		# If row counts are not equal, rollback all the imported rows</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">			            		file.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">			            		puts &#39;Data lost while importing &#39; + filename.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">			            	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">			            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">			        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">	        	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">	        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">		puts filtered_csvs.count.to_s + &#39; CSV files processed, &#39; + filtered_files.count.to_s + &#39; filtered, &#39; + duplicated_files.count.to_s + &#39; duplicated, &#39; + no_row_files.count.to_s + &#39; no row files, and &#39; + (imported_files.count + imported_main_files.count + imported_mini_files.count).to_s + &#39; files imported!&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">	    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">	    # Export XML files to specific local folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">	    if imported_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">			Report.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">		if imported_main_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">	    	ReportMain.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">	    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">	    if imported_mini_files.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">			ReportMini.export_to_xml(prefer_stage)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">		# Export blank XML files for no-row csv files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">		if generate_dummy_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">			Report.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">		if generate_dummy_main_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">			ReportMain.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">		if generate_dummy_min_xml</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">			ReportMini.export_dummy_xml(prefer_stage, latest_datetime)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">		end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">		puts &quot;Auto importing process for &quot; + prefer_stage + &quot; completed in #{(end_time - start_time)} seconds\n\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
